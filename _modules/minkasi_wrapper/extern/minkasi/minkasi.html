
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>minkasi_wrapper.extern.minkasi.minkasi &#8212; minkasi_wrapper v0.1.2.dev6+gf1ee8ad.d20230322</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">MinkasiWrapper</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">minkasi_wrapper v0.1.2.dev6+gf1ee8ad.d20230322</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for minkasi_wrapper.extern.minkasi.minkasi</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mkfftw</span>
<span class="c1">#import pyfits</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">WMAP9</span> <span class="k">as</span> <span class="n">cosmo</span> <span class="c1">#choose your cosmology here</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">import</span> <span class="nn">gc</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">healpy</span>
    <span class="n">have_healpy</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">have_healpy</span><span class="o">=</span><span class="kc">False</span>
<span class="k">try</span><span class="p">:</span> 
    <span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
    <span class="kn">import</span> <span class="nn">minkasi_nb</span>
    <span class="n">have_numba</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">have_numba</span><span class="o">=</span><span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">qpoint</span> <span class="k">as</span> <span class="nn">qp</span>
    <span class="n">have_qp</span><span class="o">=</span><span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">have_qp</span><span class="o">=</span><span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
    <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">myrank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">nproc</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nproc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">have_mpi</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">have_mpi</span><span class="o">=</span><span class="kc">False</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">have_mpi</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">myrank</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span>
<span class="c1">#try:</span>
<span class="c1">#    import numba as nb</span>
<span class="c1">#    have_numba=True</span>
<span class="c1">#else:</span>
<span class="c1">#    have_numba=False</span>


<span class="c1"># mylib=ctypes.cdll.LoadLibrary(&quot;libminkasi.so&quot;)</span>
<span class="kn">from</span> <span class="nn">.._minkasi_init</span> <span class="kn">import</span> <span class="n">mylib</span>
<span class="n">tod2map_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_simple</span>
<span class="n">tod2map_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">tod2map_atomic_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_atomic</span>
<span class="n">tod2map_atomic_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="c1">#tod2map_everyone_c=mylib.tod2map_everyone</span>
<span class="c1">#tod2map_everyone_c.argtypes=[ctypes.c_void_p,ctypes.c_void_p,ctypes.c_int,ctypes.c_int,ctypes.c_void_p,ctypes.c_int,ctypes.c_void_p,ctypes.c_int]</span>

<span class="n">tod2map_omp_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_omp</span>
<span class="n">tod2map_omp_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">tod2map_cached_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_cached</span>
<span class="n">tod2map_cached_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">map2tod_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">map2tod_simple</span>
<span class="n">map2tod_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">map2tod_omp_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">map2tod_omp</span>
<span class="n">map2tod_omp_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">map2tod_iqu_omp_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">map2tod_iqu_omp</span>
<span class="n">map2tod_iqu_omp_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">map2tod_qu_omp_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">map2tod_qu_omp</span>
<span class="n">map2tod_qu_omp_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">tod2map_iqu_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_iqu_simple</span>
<span class="n">tod2map_iqu_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">tod2map_qu_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_qu_simple</span>
<span class="n">tod2map_qu_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">tod2map_iqu_precon_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_iqu_precon_simple</span>
<span class="n">tod2map_iqu_precon_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">tod2map_qu_precon_simple_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2map_qu_precon_simple</span>
<span class="n">tod2map_qu_precon_simple_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">scan_map_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">scan_map</span>
<span class="n">scan_map_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">tod2cuts_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">tod2cuts</span>
<span class="n">tod2cuts_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">cuts2tod_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">cuts2tod</span>
<span class="n">cuts2tod_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">set_nthread_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">set_nthread</span>
<span class="n">set_nthread_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">get_nthread_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">get_nthread</span>
<span class="n">get_nthread_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>

<span class="n">fill_isobeta_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">fill_isobeta</span>
<span class="n">fill_isobeta_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">fill_isobeta_derivs_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">fill_isobeta_derivs</span>
<span class="n">fill_isobeta_derivs_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">fill_gauss_derivs_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">fill_gauss_derivs</span>
<span class="n">fill_gauss_derivs_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">fill_gauss_src_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">fill_gauss_src</span>
<span class="n">fill_gauss_src_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>

<span class="n">outer_c</span><span class="o">=</span><span class="n">mylib</span><span class="o">.</span><span class="n">outer_block</span>
<span class="n">outer_c</span><span class="o">.</span><span class="n">argtypes</span><span class="o">=</span><span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>



<div class="viewcode-block" id="y2rj"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.y2rj.html#minkasi_wrapper.extern.minkasi.minkasi.y2rj">[docs]</a><span class="k">def</span> <span class="nf">y2rj</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;conversion to multiply a y map by to get a Rayleigh-Jeans normalized map</span>
<span class="sd">    note that it doesn&#39;t have the T_cmb at the end, so the value for low frequencies</span>
<span class="sd">    is -2.&quot;&quot;&quot;</span>
    <span class="n">kb</span><span class="o">=</span><span class="mf">1.38064852e-16</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">6.62607004e-27</span>
    <span class="n">T</span><span class="o">=</span><span class="mf">2.725</span>
    <span class="n">x</span><span class="o">=</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e9</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">kb</span><span class="o">/</span><span class="n">T</span>
    
    <span class="n">ex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">f</span><span class="o">=</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ex</span><span class="o">/</span><span class="p">(</span><span class="n">ex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">ex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="planck_g"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.planck_g.html#minkasi_wrapper.extern.minkasi.minkasi.planck_g">[docs]</a><span class="k">def</span> <span class="nf">planck_g</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;conversion between T_CMB and T_RJ as a function of frequency.&quot;&quot;&quot;</span>
    <span class="n">kb</span><span class="o">=</span><span class="mf">1.38064852e-16</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">6.62607004e-27</span>
    <span class="n">T</span><span class="o">=</span><span class="mf">2.725</span>
    <span class="n">x</span><span class="o">=</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e9</span><span class="o">*</span><span class="n">h</span><span class="o">/</span><span class="n">kb</span><span class="o">/</span><span class="n">T</span>
    <span class="n">ex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ex</span><span class="o">/</span><span class="p">(</span> <span class="p">(</span><span class="n">ex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="report_mpi"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.report_mpi.html#minkasi_wrapper.extern.minkasi.minkasi.report_mpi">[docs]</a><span class="k">def</span> <span class="nf">report_mpi</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;myrank is &#39;</span><span class="p">,</span><span class="n">myrank</span><span class="p">,</span><span class="s1">&#39; out of &#39;</span><span class="p">,</span><span class="n">nproc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mpi not found&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="barrier"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.barrier.html#minkasi_wrapper.extern.minkasi.minkasi.barrier">[docs]</a><span class="k">def</span> <span class="nf">barrier</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
        <span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="invsafe"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.invsafe.html#minkasi_wrapper.extern.minkasi.minkasi.invsafe">[docs]</a><span class="k">def</span> <span class="nf">invsafe</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
    <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ii</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&lt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="c1">#print ii</span>
    <span class="n">s_inv</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">s</span>
    <span class="n">s_inv</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s_inv</span><span class="p">),</span><span class="n">u</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="tod2map_simple"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tod2map_simple.html#minkasi_wrapper.extern.minkasi.minkasi.tod2map_simple">[docs]</a><span class="k">def</span> <span class="nf">tod2map_simple</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ipix</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="s1">&#39;int32&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - ipix is not int32 in tod2map_simple.  this is likely to produce garbage results.&quot;</span><span class="p">)</span>
    <span class="n">tod2map_simple_c</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
<div class="viewcode-block" id="tod2map_everyone"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tod2map_everyone.html#minkasi_wrapper.extern.minkasi.minkasi.tod2map_everyone">[docs]</a><span class="k">def</span> <span class="nf">tod2map_everyone</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">edges</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">==</span><span class="n">get_nthread</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tod2map_everyone_c</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">edges</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span></div>

<div class="viewcode-block" id="tod2map_omp"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tod2map_omp.html#minkasi_wrapper.extern.minkasi.minkasi.tod2map_omp">[docs]</a><span class="k">def</span> <span class="nf">tod2map_omp</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">atomic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ipix</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="s1">&#39;int32&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - ipix is not int32 in tod2map_omp.  this is likely to produce garbage results.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atomic</span><span class="p">:</span>
        <span class="n">tod2map_atomic_c</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tod2map_omp_c</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="tod2map_cached"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tod2map_cached.html#minkasi_wrapper.extern.minkasi.minkasi.tod2map_cached">[docs]</a><span class="k">def</span> <span class="nf">tod2map_cached</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ipix</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="s1">&#39;int32&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - ipix is not int32 in tod2map_cached.  this is likely to produce garbage results.&quot;</span><span class="p">)</span>
    <span class="n">tod2map_cached_c</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="tod2polmap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tod2polmap.html#minkasi_wrapper.extern.minkasi.minkasi.tod2polmap">[docs]</a><span class="k">def</span> <span class="nf">tod2polmap</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">poltag</span><span class="p">,</span><span class="n">twogamma</span><span class="p">,</span><span class="n">ipix</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fun</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">tod2map_qu_simple_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">tod2map_iqu_simple_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU_PRECON&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">tod2map_qu_precon_simple_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU_PRECON&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">tod2map_iqu_precon_simple_c</span>
    <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unrecognized poltag &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">poltag</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in tod2polmap.&#39;</span><span class="p">)</span>
    <span class="c1">#print(&#39;calling &#39; + repr(fun))</span>
    <span class="n">fun</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">twogamma</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.map2tod.html#minkasi_wrapper.extern.minkasi.minkasi.map2tod">[docs]</a><span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">do_omp</span><span class="p">:</span>
        <span class="n">map2tod_omp_c</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ndet</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">do_add</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">map2tod_simple_c</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="polmap2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.polmap2tod.html#minkasi_wrapper.extern.minkasi.minkasi.polmap2tod">[docs]</a><span class="k">def</span> <span class="nf">polmap2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">poltag</span><span class="p">,</span><span class="n">twogamma</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fun</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">map2tod_qu_omp_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">map2tod_iqu_omp_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU_PRECON&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">map2tod_qu_precon_omp_c</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU_PRECON&#39;</span><span class="p">:</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">map2tod_iqu_precon_omp_c</span>
    <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unknown poltag &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">poltag</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in polmap2tod.&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1">#print(&#39;calling &#39; + repr(fun))</span>
    <span class="n">fun</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">twogamma</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndata</span><span class="p">,</span><span class="n">ipix</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="read_fits_map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.read_fits_map.html#minkasi_wrapper.extern.minkasi.minkasi.read_fits_map">[docs]</a><span class="k">def</span> <span class="nf">read_fits_map</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">do_trans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_trans</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">=</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tmp</span></div>
<div class="viewcode-block" id="write_fits_map_wheader"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.write_fits_map_wheader.html#minkasi_wrapper.extern.minkasi.minkasi.write_fits_map_wheader">[docs]</a><span class="k">def</span> <span class="nf">write_fits_map_wheader</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">do_trans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">do_trans</span><span class="p">:</span>
        <span class="nb">map</span><span class="o">=</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="get_ft_vec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_ft_vec.html#minkasi_wrapper.extern.minkasi.minkasi.get_ft_vec">[docs]</a><span class="k">def</span> <span class="nf">get_ft_vec</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&gt;</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&gt;</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="set_nthread"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.set_nthread.html#minkasi_wrapper.extern.minkasi.minkasi.set_nthread">[docs]</a><span class="k">def</span> <span class="nf">set_nthread</span><span class="p">(</span><span class="n">nthread</span><span class="p">):</span>
    <span class="n">set_nthread_c</span><span class="p">(</span><span class="n">nthread</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_nthread"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_nthread.html#minkasi_wrapper.extern.minkasi.minkasi.get_nthread">[docs]</a><span class="k">def</span> <span class="nf">get_nthread</span><span class="p">():</span>
    <span class="n">nthread</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">get_nthread_c</span><span class="p">(</span><span class="n">nthread</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nthread</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="segs_from_vec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.segs_from_vec.html#minkasi_wrapper.extern.minkasi.minkasi.segs_from_vec">[docs]</a><span class="k">def</span> <span class="nf">segs_from_vec</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; segs_from_vec(vec,pad=True)</span>
<span class="sd">    return the starting/stopping points of regions marked False in vec.  For use in e.g. generating</span>
<span class="sd">    cuts from a vector/array.  If pad is False, assume vector is already True-padded&quot;&quot;&quot;</span>
    <span class="c1">#insert input vector into a True-padded vector do make reasoning about starting/stopping points</span>
    <span class="c1">#of False regions easier.</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="n">vv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">vec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="s1">&#39;bool&#39;</span><span class="p">:</span>
            <span class="n">vv</span><span class="o">=</span><span class="n">vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
            <span class="n">vv</span><span class="p">[:]</span><span class="o">=</span><span class="n">vec</span>
    <span class="k">if</span> <span class="n">vv</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">nseg</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">istart</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">istop</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vv</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nseg</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">istart</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">istop</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nseg</span><span class="p">):</span>
            <span class="n">istart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">])</span>
            <span class="n">istop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">nseg</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">istop</span></div>

<div class="viewcode-block" id="cut_blacklist"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.cut_blacklist.html#minkasi_wrapper.extern.minkasi.minkasi.cut_blacklist">[docs]</a><span class="k">def</span> <span class="nf">cut_blacklist</span><span class="p">(</span><span class="n">tod_names</span><span class="p">,</span><span class="n">blacklist</span><span class="p">):</span>
    <span class="n">mydict</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">tod_names</span><span class="p">:</span>
        <span class="n">tt</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mydict</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">=</span><span class="n">nm</span>
    <span class="n">ncut</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
        <span class="n">tt</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#if mydict.has_key(tt):</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">:</span>
            <span class="n">ncut</span><span class="o">=</span><span class="n">ncut</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">del</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="n">tt</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ncut</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deleted &#39;</span><span class="p">,</span><span class="n">ncut</span><span class="p">,</span><span class="s1">&#39; bad files.&#39;</span><span class="p">)</span>
        <span class="n">mynames</span><span class="o">=</span><span class="n">mydict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">mynames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mynames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tod_names</span> </div>


<div class="viewcode-block" id="find_spikes"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.find_spikes.html#minkasi_wrapper.extern.minkasi.minkasi.find_spikes">[docs]</a><span class="k">def</span> <span class="nf">find_spikes</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">inner</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">outer</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rad</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1">#find spikes in a block of timestreams</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">filt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">inner</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">filt1</span><span class="o">=</span><span class="n">filt1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">inner</span><span class="o">**</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">filt1</span><span class="o">=</span><span class="n">filt1</span><span class="o">/</span><span class="n">filt1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">filt2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">outer</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">filt2</span><span class="o">=</span><span class="n">filt2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">outer</span><span class="o">**</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">filt2</span><span class="o">=</span><span class="n">filt2</span><span class="o">/</span><span class="n">filt2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="o">-</span><span class="n">filt2</span> <span class="c1">#make a filter that is the difference of two Gaussians, one narrow, one wide</span>
    <span class="n">filtft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">datft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">datfilt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">filtft</span><span class="o">*</span><span class="n">datft</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">jumps</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ndet</span>
    <span class="n">mystd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">datfilt</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">datfilt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">mystd</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">datfilt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span>
            <span class="k">if</span> <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">datfilt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">return</span> <span class="n">jumps</span><span class="p">,</span><span class="n">datfilt</span>
    <span class="k">return</span> <span class="n">mystd</span></div>
<div class="viewcode-block" id="make_rings_wSlope"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.make_rings_wSlope.html#minkasi_wrapper.extern.minkasi.minkasi.make_rings_wSlope">[docs]</a><span class="k">def</span> <span class="nf">make_rings_wSlope</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">pixsize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">amps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bb</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">rot</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">xvec</span><span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span><span class="o">=</span><span class="n">xvec</span><span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span>
    <span class="n">yvec</span><span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span><span class="o">=</span><span class="n">yvec</span><span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span>

    <span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">xvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">ymat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">yvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xmat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ymat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pixsize</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span><span class="o">|</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">amps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)):</span>
            <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">beam_area</span><span class="o">=</span><span class="n">pixsize</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">beam_area</span><span class="o">=</span><span class="n">beam_area</span><span class="o">/</span><span class="mi">3600</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;beam_area is &#39;</span><span class="p">,</span><span class="n">beam_area</span><span class="o">*</span><span class="mf">1e9</span><span class="p">,</span><span class="s1">&#39; nsr&#39;</span><span class="p">)</span>
    <span class="n">nring</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">rings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nring</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span>
    <span class="n">mypix</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mypix is &#39;</span><span class="p">,</span><span class="n">mypix</span><span class="p">)</span>

    <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">xvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">ymat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">yvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">srcft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">src_map</span><span class="p">)</span>
    <span class="n">xtr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">xmat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="c1"># Rotate and translate x coords</span>
    <span class="n">ytr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ymat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">xmat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="c1"># Rotate and translate y coords</span>
    <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">xtr</span><span class="o">/</span><span class="n">aa</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ytr</span><span class="o">/</span><span class="n">bb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="n">pixsize</span>            <span class="c1"># Elliptically scale x,y</span>
    <span class="n">myvals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:</span><span class="n">nring</span><span class="p">]</span><span class="o">*</span><span class="mf">1.0</span>   <span class="c1"># Get just the values that correspond to rings</span>
    <span class="n">myvals</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">myvals</span><span class="p">)</span> <span class="c1"># Set it such that the maximum value approaches 0</span>
    <span class="n">pk2pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">myvals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">myvals</span><span class="p">)</span>
    <span class="n">myvals</span> <span class="o">-=</span> <span class="n">pk2pk</span><span class="o">/</span><span class="mf">50.0</span>       <span class="c1"># Let&#39;s assume we&#39;re down about a factor of 50 at the outskirts.</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nring</span><span class="p">):</span>
        <span class="c1">#rings[i,(rmat&gt;=edges[i])&amp;(rmat&lt;edges[i+1]=1.0</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nring</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">slope</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">myvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">myvals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># expect positve slope; want negative one.</span>
        <span class="n">rgtinedge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmat</span><span class="o">&gt;=</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rfromin</span>   <span class="o">=</span> <span class="p">(</span><span class="n">rmat</span><span class="o">-</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">initline</span>  <span class="o">=</span> <span class="n">rfromin</span><span class="p">[</span><span class="n">rgtinedge</span><span class="p">]</span><span class="o">*</span><span class="n">slope</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">rgtinedge</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">myvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">initline</span><span class="p">)</span><span class="o">/</span><span class="n">myvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Should be normalized to 1 now.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">rgtinedge</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">rgtoutedge</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmat</span><span class="o">&gt;=</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">rgtoutedge</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">myannul</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c1</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span><span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rgtinedge</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">rgtoutedge</span><span class="o">.</span><span class="n">ravel</span><span class="p">())]</span>
        <span class="n">rannul</span>  <span class="o">=</span> <span class="n">rmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">myannul</span><span class="p">]</span>
        <span class="n">rmin</span>    <span class="o">=</span> <span class="p">(</span><span class="n">rmat</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rannul</span><span class="p">))</span>
        <span class="n">rmout</span>   <span class="o">=</span> <span class="p">(</span><span class="n">rmat</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rannul</span><span class="p">))</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span><span class="o">*</span><span class="n">srcft</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rings</span></div>

<div class="viewcode-block" id="make_rings"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.make_rings.html#minkasi_wrapper.extern.minkasi.minkasi.make_rings">[docs]</a><span class="k">def</span> <span class="nf">make_rings</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span><span class="n">cent</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">pixsize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">amps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">iswcs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">ix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">iy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xvec</span><span class="p">[</span><span class="n">ix</span><span class="p">:]</span><span class="o">=</span><span class="n">xvec</span><span class="p">[</span><span class="n">ix</span><span class="p">:]</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span>
    <span class="n">yvec</span><span class="p">[</span><span class="n">iy</span><span class="p">:]</span><span class="o">=</span><span class="n">yvec</span><span class="p">[</span><span class="n">iy</span><span class="p">:]</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span>
    <span class="c1">#xvec[map.nx/2:]=xvec[map.nx/2:]-map.nx</span>
    <span class="c1">#yvec[map.ny/2:]=yvec[map.ny/2:]-map.ny</span>

    <span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">xvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">ymat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">yvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xmat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ymat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pixsize</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span><span class="o">|</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">src_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">amps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)):</span>
            <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rmat</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">amps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">src_map</span><span class="o">=</span><span class="n">src_map</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">beam_area</span><span class="o">=</span><span class="n">pixsize</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">src_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">beam_area</span><span class="o">=</span><span class="n">beam_area</span><span class="o">/</span><span class="mi">3600</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;beam_area is &#39;</span><span class="p">,</span><span class="n">beam_area</span><span class="o">*</span><span class="mf">1e9</span><span class="p">,</span><span class="s1">&#39; nsr&#39;</span><span class="p">)</span>
    <span class="n">nring</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">rings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nring</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">iswcs</span><span class="p">:</span>
        <span class="n">mypix</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mypix</span><span class="o">=</span><span class="n">cent</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mypix is &#39;</span><span class="p">,</span><span class="n">mypix</span><span class="p">)</span>

    <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">xvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">ymat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">yvec</span><span class="p">],</span><span class="nb">map</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">srcft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">src_map</span><span class="p">)</span>
    <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">xmat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ymat</span><span class="o">-</span><span class="n">mypix</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pixsize</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nring</span><span class="p">):</span>
        <span class="c1">#rings[i,(rmat&gt;=edges[i])&amp;(rmat&lt;edges[i+1]=1.0</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,(</span><span class="n">rmat</span><span class="o">&gt;=</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,(</span><span class="n">rmat</span><span class="o">&gt;=</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span><span class="o">*</span><span class="n">srcft</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rings</span></div>
        


<div class="viewcode-block" id="find_jumps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.find_jumps.html#minkasi_wrapper.extern.minkasi.minkasi.find_jumps">[docs]</a><span class="k">def</span> <span class="nf">find_jumps</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rat</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="c1">#find jumps in a block of timestreams, preferably with the common mode removed</span>
    <span class="c1">#width is width in pixels to average over when looking for a jump</span>
    <span class="c1">#pad is the length in units of width to mask at beginning/end of timestream</span>
    <span class="c1">#thresh is threshold in units of filtered data median absolute deviation to qualify as a jump</span>
    <span class="c1">#rat is the ratio of largest neighboring opposite-sign jump to the found jump.  If</span>
    <span class="c1">#  there is an opposite-sign jump nearby, the jump finder has probably just picked up a spike.</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#make a filter template that is a gaussian with sigma with, sign-flipped in the center</span>
    <span class="c1">#so, positive half-gaussian starting from zero, and negative half-gaussian at the end</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">myfilt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">width</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">myfilt</span><span class="o">=</span><span class="n">myfilt</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">width</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myfilt</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">myfilt</span><span class="o">=</span><span class="n">myfilt</span><span class="o">/</span><span class="n">fac</span>

    <span class="n">dat_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">myfilt_ft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">myfilt</span><span class="p">)</span>
    <span class="n">dat_filt</span><span class="o">=</span><span class="n">dat_filt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">myfilt_ft</span><span class="p">],</span><span class="n">ndet</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dat_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">dat_filt_org</span><span class="o">=</span><span class="n">dat_filt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">dat_filt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dat_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">pad</span><span class="o">*</span><span class="n">width</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">dat_filt</span><span class="p">[:,</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="n">width</span><span class="p">:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">det_thresh</span><span class="o">=</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dat_dejump</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jumps</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ndet</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;have filtered data, now searching for jumps&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span><span class="o">&gt;</span><span class="n">det_thresh</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>            
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]))</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#+1 seems to be the right index to use</span>
            <span class="n">imin</span><span class="o">=</span><span class="n">ind</span><span class="o">-</span><span class="n">width</span>
            <span class="k">if</span> <span class="n">imin</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">imin</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">imax</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="n">width</span>
            <span class="k">if</span> <span class="n">imax</span><span class="o">&gt;</span><span class="n">n</span><span class="p">:</span>
                <span class="n">imax</span><span class="o">=</span><span class="n">n</span>
            <span class="n">val</span><span class="o">=</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">val2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">imin</span><span class="p">:</span><span class="n">imax</span><span class="p">])</span>
            
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;found jump on detector &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39; at sample &#39;</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val2</span><span class="o">/</span><span class="n">val</span><span class="p">)</span><span class="o">&gt;</span><span class="n">rat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I think this is a spike due to ratio &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val2</span><span class="o">/</span><span class="n">val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="c1">#independent of if we think it is a spike or a jump, zap that stretch of the data</span>
            <span class="n">dat_dejump</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">:]</span><span class="o">=</span><span class="n">dat_dejump</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">:]</span><span class="o">+</span><span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">dat_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="o">-</span><span class="n">pad</span><span class="o">*</span><span class="n">width</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="n">pad</span><span class="o">*</span><span class="n">width</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1">#return dat_dejump,jumps,dat_filt_org</span>
    <span class="k">return</span> <span class="n">jumps</span></div>

<div class="viewcode-block" id="fit_jumps_from_cm"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_jumps_from_cm.html#minkasi_wrapper.extern.minkasi.minkasi.fit_jumps_from_cm">[docs]</a><span class="k">def</span> <span class="nf">fit_jumps_from_cm</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">jumps</span><span class="p">,</span><span class="n">cm</span><span class="p">,</span><span class="n">cm_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">poly_order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">jump_vals</span><span class="o">=</span><span class="n">jumps</span><span class="p">[:]</span>
    <span class="n">ndet</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">jumps</span><span class="p">)</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">m1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">poly_order</span><span class="p">)</span>
    <span class="n">m2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cm_order</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm_order</span><span class="p">):</span>
        <span class="n">m2</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">m2</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cm</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">npp</span><span class="o">=</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dat_dejump</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">njump</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">segs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working on detector &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39; who has &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39; jumps with segments &#39;</span><span class="p">,</span><span class="n">segs</span><span class="p">)</span>
            <span class="n">mm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span><span class="n">npp</span><span class="o">+</span><span class="n">njump</span><span class="p">])</span>
            <span class="n">mm</span><span class="p">[:,:</span><span class="n">npp</span><span class="p">]</span><span class="o">=</span><span class="n">mat</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">njump</span><span class="p">):</span>
                <span class="n">mm</span><span class="p">[</span><span class="n">segs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">segs</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="n">npp</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">mm</span><span class="p">)</span>
            <span class="c1">#print lhs</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">lhs_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
            <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lhs_inv</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
            <span class="n">jump_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="n">npp</span><span class="p">:]</span>
            <span class="n">jump_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mm</span><span class="p">[:,</span><span class="n">npp</span><span class="p">:],</span><span class="n">fitp</span><span class="p">[</span><span class="n">npp</span><span class="p">:])</span>
            <span class="n">dat_dejump</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">dat_dejump</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">-</span><span class="n">jump_pred</span>


    <span class="k">return</span> <span class="n">dat_dejump</span></div>
            

    <span class="c1">#for i in range(ndet):</span>
<div class="viewcode-block" id="gapfill_eig"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.gapfill_eig.html#minkasi_wrapper.extern.minkasi.minkasi.gapfill_eig">[docs]</a><span class="k">def</span> <span class="nf">gapfill_eig</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">cuts</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">niter_eig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">niter_inner</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">insert_cuts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ndat</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cuts_empty</span><span class="o">=</span><span class="n">cuts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#use this to clear out cut samples</span>
    <span class="n">cuts_empty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> 
    <span class="n">cuts_cur</span><span class="o">=</span><span class="n">cuts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cuts_cur</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">eig_ctr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter_eig</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cuts_cur</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mycov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">tmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ee</span><span class="p">,</span><span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">mycov</span><span class="p">)</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ee</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
        <span class="n">neig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working with &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">neig</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; eigenvectors.&#39;</span><span class="p">)</span>
        <span class="n">ee</span><span class="o">=</span><span class="n">ee</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">vv</span><span class="o">=</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">uu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">uu</span><span class="p">,</span><span class="n">uu</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">lhs_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iter_ctr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter_inner</span><span class="p">):</span>
            <span class="c1">#in this inner loop, we fit the data </span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">uu</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lhs_inv</span><span class="p">,</span><span class="n">rhs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fitp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">uu</span><span class="p">)</span>
            <span class="n">cuts_cur</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">pred</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cuts_cur</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">insert_cuts</span><span class="p">:</span>
        <span class="n">cuts_cur</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cuts_cur</span></div>
        

<span class="k">def</span> <span class="nf">__gapfill_eig_poly</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">cuts</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">npoly</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">niter_eig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">niter_inner</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#this code is not yet working.  regular gapfill_eig should work since the polys could</span>
                 <span class="c1">#be described by SVD, so SVD modes should look like polys iff they would have been important</span>
    <span class="n">ndat</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">npoly</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ndat</span><span class="p">)</span>
        <span class="n">polymat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">npoly</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">old_coeffs</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">cuts_cur</span><span class="o">=</span><span class="n">cuts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    
    <span class="n">cuts_cur</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">cuts_empty</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cuts_empty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">eig_ctr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter_eig</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cuts_cur</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#insert current best-guess solution for the cuts</span>
        <span class="k">if</span> <span class="n">npoly</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>  <span class="c1">#if we&#39;re fitting polynomials as well as eigenmodes, subtract them off before re-estimating the covariance</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">old_coeffs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">polymat</span><span class="p">,</span><span class="n">old_coeffs</span><span class="p">[</span><span class="n">neig</span><span class="p">:,:])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">mycov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">tmp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">mycov</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mycov</span><span class="o">+</span><span class="n">mycov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ee</span><span class="p">,</span><span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">mycov</span><span class="p">)</span>
        <span class="n">mode_map</span><span class="o">=</span><span class="n">ee</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
        <span class="n">neig</span><span class="o">=</span><span class="n">mode_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndat</span><span class="p">,</span><span class="n">neig</span><span class="o">+</span><span class="n">npoly</span><span class="p">])</span>
        <span class="n">eigs</span><span class="o">=</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mode_map</span><span class="p">]</span>
        <span class="n">ts_vecs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eigs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">mat</span><span class="p">[:,:</span><span class="n">neig</span><span class="p">]</span><span class="o">=</span><span class="n">ts_vecs</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">npoly</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[:,</span><span class="n">neig</span><span class="p">:]</span><span class="o">=</span><span class="n">polymat</span>
        <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">lhs_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="c1">#now that we have the vectors we expect to describe our data, do a few rounds</span>
        <span class="c1">#of fitting amplitudes to timestream models, subtract that off, assign cuts to zero,</span>
        <span class="c1">#and restore the model.  </span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inner_ctr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter_inner</span><span class="p">):</span>
            <span class="n">cuts_cur</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lhs_inv</span><span class="p">,</span><span class="n">rhs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">fitp</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            

<div class="viewcode-block" id="get_type"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_type.html#minkasi_wrapper.extern.minkasi.minkasi.get_type">[docs]</a><span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="n">nbyte</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nbyte</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbyte</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbyte</span><span class="o">==-</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbyte</span><span class="o">==-</span><span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbyte</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unsupported nbyte &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">nbyte</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in get_type&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="read_octave_struct"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.read_octave_struct.html#minkasi_wrapper.extern.minkasi.minkasi.read_octave_struct">[docs]</a><span class="k">def</span> <span class="nf">read_octave_struct</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">nkey</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print &#39;nkey is &#39; + repr(nkey)</span>
    <span class="n">dat</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nkey</span><span class="p">):</span>
        <span class="n">key</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1">#print &#39;key is &#39; + key</span>
        <span class="n">ndim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span><span class="n">ndim</span><span class="p">)</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="c1">#print &#39;Dimensions of &#39; + key + &#39; are &#39; + repr(dims)</span>
        <span class="n">nbyte</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#print &#39;nbyte is &#39; + repr(nbyte)</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">get_type</span><span class="p">(</span><span class="n">nbyte</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">dims</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dat</span></div>



<div class="viewcode-block" id="nsphere_vol"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.nsphere_vol.html#minkasi_wrapper.extern.minkasi.minkasi.nsphere_vol">[docs]</a><span class="k">def</span> <span class="nf">nsphere_vol</span><span class="p">(</span><span class="n">npp</span><span class="p">):</span>
    <span class="n">iseven</span><span class="o">=</span><span class="p">(</span><span class="n">npp</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">iseven</span><span class="p">:</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">npp</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">vol</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="n">nn</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nn</span><span class="o">=</span><span class="p">(</span><span class="n">npp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">vol</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="n">nn</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">npp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">vol</span></div>


<span class="k">def</span> <span class="nf">_prime_loop</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="n">icur</span><span class="p">,</span><span class="n">lcur</span><span class="p">,</span><span class="n">vals</span><span class="p">):</span>
    <span class="n">facs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lcur</span><span class="p">,</span><span class="n">ln</span><span class="o">+</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">nfac</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">facs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nfac</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">icur</span><span class="p">:(</span><span class="n">icur</span><span class="o">+</span><span class="n">nfac</span><span class="p">)]</span><span class="o">=</span><span class="n">facs</span>
            <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="n">nfac</span>
            <span class="c1">#print 2**vals[:icur]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bad facs came from &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">([</span><span class="mi">2</span><span class="o">**</span><span class="n">lcur</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">ln</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="n">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="c1">#print icur</span>
        <span class="k">return</span> <span class="n">icur</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">facs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lcur</span><span class="p">,</span><span class="n">ln</span><span class="p">,</span><span class="n">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">facs</span><span class="p">:</span>
            <span class="n">icur</span><span class="o">=</span><span class="n">_prime_loop</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span><span class="n">lp</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">icur</span><span class="p">,</span><span class="n">fac</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">icur</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I don&#39;&#39;t think I should have gotten here.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">icur</span>
                             
        

<div class="viewcode-block" id="find_good_fft_lens"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.find_good_fft_lens.html#minkasi_wrapper.extern.minkasi.minkasi.find_good_fft_lens">[docs]</a><span class="k">def</span> <span class="nf">find_good_fft_lens</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">primes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]):</span>
    <span class="n">lmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">npr</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">primes</span><span class="p">)</span>
    <span class="n">vol</span><span class="o">=</span><span class="n">nsphere_vol</span><span class="p">(</span><span class="n">npr</span><span class="p">)</span>

    <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">lp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">primes</span><span class="p">)</span>
    <span class="n">npoint_max</span><span class="o">=</span><span class="p">(</span><span class="n">vol</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="n">npr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">lp</span><span class="p">)</span><span class="o">+</span><span class="mi">30</span> <span class="c1">#add a bit just to make sure we don&#39;t act up for small n</span>
    <span class="c1">#print &#39;npoint max is &#39;,npoint max</span>
    <span class="n">npoint_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">npoint_max</span><span class="p">)</span>

    <span class="c1">#vals=np.zeros(npoint_max,dtype=&#39;int&#39;)</span>
    <span class="n">vals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npoint_max</span><span class="p">)</span>
    <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">icur</span><span class="o">=</span><span class="n">_prime_loop</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">lp</span><span class="p">,</span><span class="n">icur</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">vals</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">icur</span><span class="o">&lt;=</span><span class="n">npoint_max</span><span class="p">)</span>
    <span class="n">myvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">vals</span><span class="p">[:</span><span class="n">icur</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">myvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">myvals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">myvals</span></div>
    
    

<span class="k">def</span> <span class="nf">_linfit_2mat</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">mat1</span><span class="p">,</span><span class="n">mat2</span><span class="p">):</span>
    <span class="n">np1</span><span class="o">=</span><span class="n">mat1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">np2</span><span class="o">=</span><span class="n">mat2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat1</span><span class="p">,</span><span class="n">mat2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">mm</span><span class="p">)</span>
    <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">lhs_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
    <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lhs_inv</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
    <span class="n">fitp1</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">np1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">fitp2</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="n">np1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitp2</span><span class="p">)</span><span class="o">==</span><span class="n">np2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fitp1</span><span class="p">,</span><span class="n">fitp2</span>

<div class="viewcode-block" id="fit_mat_vecs_poly_nonoise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_mat_vecs_poly_nonoise.html#minkasi_wrapper.extern.minkasi.minkasi.fit_mat_vecs_poly_nonoise">[docs]</a><span class="k">def</span> <span class="nf">fit_mat_vecs_poly_nonoise</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">mat</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">cm_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cm_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cm_order</span><span class="o">=</span><span class="n">order</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">polys</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">cm_polys</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cm_order</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">v1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">v2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="o">*</span><span class="n">mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rhs1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cm_polys</span><span class="p">,</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">rhs2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">A1</span><span class="o">=</span><span class="n">cm_polys</span><span class="o">*</span><span class="n">ndet</span>
    <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">A2</span><span class="o">=</span><span class="n">polys</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">vv</span><span class="p">],</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">A</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs1</span><span class="p">,</span><span class="n">rhs2</span><span class="p">)</span>
    <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">A</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span><span class="n">rhs</span><span class="p">)</span>
    <span class="n">cm_fitp</span><span class="o">=</span><span class="n">fitp</span><span class="p">[:</span><span class="n">cm_order</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mat_fitp</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="n">cm_order</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat_fitp</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">cm_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cm_fitp</span><span class="p">,</span><span class="n">cm_polys</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_fitp</span><span class="p">,</span><span class="n">polys</span><span class="p">)</span>
    <span class="n">mat_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">tmp</span><span class="p">],</span><span class="n">ndet</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">cm_pred</span><span class="o">+</span><span class="n">mat_pred</span>
    <span class="k">return</span> <span class="n">pred</span><span class="p">,</span><span class="n">cm_fitp</span><span class="p">,</span><span class="n">mat_fitp</span><span class="p">,</span><span class="n">polys</span></div>



<div class="viewcode-block" id="smooth_spectra"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.smooth_spectra.html#minkasi_wrapper.extern.minkasi.minkasi.smooth_spectra">[docs]</a><span class="k">def</span> <span class="nf">smooth_spectra</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span><span class="n">fwhm</span><span class="p">):</span>
    <span class="n">nspec</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tot</span><span class="o">=</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">to_conv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1">#r2r normalization</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">to_conv</span><span class="o">/</span><span class="n">tot</span>
    <span class="n">to_conv_ft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">to_conv</span><span class="p">)</span>
    <span class="n">xtrans</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
        <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">to_conv_ft</span>
    <span class="c1">#return mkfftw.fft_r2r(xtrans)/(2*(xtrans.shape[1]-1)),to_conv</span>
    <span class="k">return</span> <span class="n">xtrans</span><span class="p">,</span><span class="n">to_conv_ft</span></div>
<div class="viewcode-block" id="smooth_many_vecs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.smooth_many_vecs.html#minkasi_wrapper.extern.minkasi.minkasi.smooth_many_vecs">[docs]</a><span class="k">def</span> <span class="nf">smooth_many_vecs</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nvec</span><span class="o">=</span><span class="n">vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tot</span><span class="o">=</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">to_conv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1">#r2r normalization</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">to_conv</span><span class="o">/</span><span class="n">tot</span>
    <span class="n">to_conv_ft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">to_conv</span><span class="p">)</span>
    <span class="n">xtrans</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">xtrans</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">to_conv_ft</span>
    <span class="n">back</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">xtrans</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">back</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>
<div class="viewcode-block" id="smooth_vec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.smooth_vec.html#minkasi_wrapper.extern.minkasi.minkasi.smooth_vec">[docs]</a><span class="k">def</span> <span class="nf">smooth_vec</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">vec</span><span class="o">.</span><span class="n">size</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">sig</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tot</span><span class="o">=</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">to_conv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">to_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1">#r2r normalization</span>
    <span class="n">to_conv</span><span class="o">=</span><span class="n">to_conv</span><span class="o">/</span><span class="n">tot</span>
    <span class="n">to_conv_ft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">to_conv</span><span class="p">)</span>
    <span class="n">xtrans</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">back</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">xtrans</span><span class="o">*</span><span class="n">to_conv_ft</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">back</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="fit_cm_plus_poly"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_cm_plus_poly.html#minkasi_wrapper.extern.minkasi.minkasi.fit_cm_plus_poly">[docs]</a><span class="k">def</span> <span class="nf">fit_cm_plus_poly</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">cm_ord</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">niter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">medsub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">full_out</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">medsub</span><span class="p">:</span>
        <span class="n">med</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        
        <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">med</span><span class="p">],</span><span class="n">n</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        
        

    <span class="n">xx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mf">0.0</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">xx</span><span class="o">-</span><span class="n">xx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">xx</span><span class="o">/</span><span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">pmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="nb">ord</span><span class="p">)</span>
    <span class="n">cm_pmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">cm_ord</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">calfacs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span>
    <span class="n">dd</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">niter</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span><span class="o">/=</span><span class="n">calfacs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            
        <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm_mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cm_pmat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cm_mat</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">cm_pmat</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">cm</span>
        <span class="n">fitp_p</span><span class="p">,</span><span class="n">fitp_cm</span><span class="o">=</span><span class="n">_linfit_2mat</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">pmat</span><span class="p">,</span><span class="n">cm_mat</span><span class="p">)</span>
        <span class="n">pred1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pmat</span><span class="p">,</span><span class="n">fitp_p</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">pred2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cm_mat</span><span class="p">,</span><span class="n">fitp_cm</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred1</span><span class="o">+</span><span class="n">pred2</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">pred1</span>
        
    <span class="k">if</span> <span class="n">full_out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dd</span><span class="p">,</span><span class="n">pred2</span><span class="p">,</span><span class="n">cm</span> <span class="c1">#if requested, return the modelled CM as well</span>
    <span class="k">return</span> <span class="n">dd</span></div>


<span class="k">def</span> <span class="nf">__run_pcg_old</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">precon</span><span class="p">):</span>
    <span class="n">Ax</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

    <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="n">Ax</span>
    <span class="n">z</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r</span>
    <span class="n">p</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">zr</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span>
        <span class="n">Ap</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">pAp</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">zr</span><span class="o">/</span><span class="n">pAp</span>

        <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">alpha</span>
        <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">Ap</span><span class="o">*</span><span class="n">alpha</span> 
        <span class="n">z_new</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r_new</span>
        <span class="n">zr_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
        <span class="n">beta</span><span class="o">=</span><span class="n">zr_new</span><span class="o">/</span><span class="n">zr</span>
        <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">beta</span>
        
        <span class="n">p</span><span class="o">=</span><span class="n">p_new</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z_new</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r_new</span>
        <span class="n">zr</span><span class="o">=</span><span class="n">zr_new</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_new</span>
    <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="run_pcg"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.run_pcg.html#minkasi_wrapper.extern.minkasi.minkasi.run_pcg">[docs]</a><span class="k">def</span> <span class="nf">run_pcg</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">precon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">outroot</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span><span class="n">save_iters</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">save_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">save_tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="n">plot_iters</span><span class="o">=</span><span class="p">[],</span><span class="n">plot_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">Ax</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ax</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="n">Ax</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print(&#39;applying precon&#39;)</span>
        <span class="n">z</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">k</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="n">zr</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">get_nsamp</span><span class="p">()</span>
    <span class="n">tloop</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">iter</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="n">nsamp</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">Ap</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pAp</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">zr</span><span class="o">/</span><span class="n">pAp</span>
        <span class="c1">#print(&#39;alpha,pAp, and zr  are &#39; + repr(alpha) + &#39;  &#39; + repr(pAp) + &#39;  &#39; + repr(zr))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">alpha</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">r_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ap</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">Ap</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#print(&#39;applying precon&#39;)</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zr_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
        <span class="n">beta</span><span class="o">=</span><span class="n">zr_new</span><span class="o">/</span><span class="n">zr</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">p_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">beta</span>
        
        <span class="n">p</span><span class="o">=</span><span class="n">p_new</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z_new</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r_new</span>
        <span class="n">zr</span><span class="o">=</span><span class="n">zr_new</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_new</span>
        <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">save_iters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">save_ind</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outroot</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span><span class="o">+</span><span class="n">save_tail</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">plot_iters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plotting on iteration &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_info</span><span class="p">)</span>

    <span class="n">tave</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tloop</span><span class="p">)</span><span class="o">/</span><span class="n">maxiter</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average time per iteration was &#39;</span><span class="p">,</span><span class="n">tave</span><span class="p">,</span><span class="s1">&#39; with effective throughput &#39;</span><span class="p">,</span><span class="n">nsamp</span><span class="o">/</span><span class="n">tave</span><span class="o">/</span><span class="mf">1e6</span><span class="p">,</span><span class="s1">&#39; Msamp/s&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">plot_iters</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plotting on iteration &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_info</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping plotting on iter &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="run_pcg_wprior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.run_pcg_wprior.html#minkasi_wrapper.extern.minkasi.minkasi.run_pcg_wprior">[docs]</a><span class="k">def</span> <span class="nf">run_pcg_wprior</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">precon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">outroot</span><span class="o">=</span><span class="s1">&#39;map&#39;</span><span class="p">,</span><span class="n">save_iters</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">save_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">save_tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
    <span class="c1">#least squares equations in the presence of a prior - chi^2 = (d-Am)^T N^-1 (d-Am) + (p-m)^T Q^-1 (p-m)</span>
    <span class="c1">#where p is the prior target for parameters, and Q is the variance.  The ensuing equations are</span>
    <span class="c1">#(A^T N-1 A + Q^-1)m = A^T N^-1 d + Q^-1 p.  For non-zero p, it is assumed you have done this already and that </span>
    <span class="c1">#b=A^T N^-1 d + Q^-1 p</span>
    <span class="c1">#to have a prior then, whenever we call Ax, just a Q^-1 x to Ax.</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">Ax</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>    
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print(&#39;applying prior&#39;)</span>
        <span class="n">prior</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">Ax</span><span class="p">)</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ax</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="n">Ax</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">z</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">k</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="n">zr</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">iter</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">Ap</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#print(&#39;applying prior&#39;)</span>
            <span class="n">prior</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pAp</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">zr</span><span class="o">/</span><span class="n">pAp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">alpha</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">r_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ap</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">Ap</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zr_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
        <span class="n">beta</span><span class="o">=</span><span class="n">zr_new</span><span class="o">/</span><span class="n">zr</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">p_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">beta</span>
        
        <span class="n">p</span><span class="o">=</span><span class="n">p_new</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z_new</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r_new</span>
        <span class="n">zr</span><span class="o">=</span><span class="n">zr_new</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_new</span>
        <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">save_iters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">save_ind</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outroot</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span><span class="o">+</span><span class="n">save_tail</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span></div>

    

<div class="viewcode-block" id="run_pcg_wprior_old"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.run_pcg_wprior_old.html#minkasi_wrapper.extern.minkasi.minkasi.run_pcg_wprior_old">[docs]</a><span class="k">def</span> <span class="nf">run_pcg_wprior_old</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">prior</span><span class="p">,</span><span class="n">precon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">Ax</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="c1">#prior.apply_prior(Ax,x0)</span>
    <span class="n">flub</span><span class="o">=</span><span class="n">prior</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;means of flub and Ax are &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Ax</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flub</span><span class="p">)))</span>
    <span class="n">Ax</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">Ax</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="o">+</span><span class="n">prior</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ax</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">b</span><span class="o">-</span><span class="n">Ax</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">z</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">k</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="n">zr</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">iter</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">Ap</span><span class="o">=</span><span class="n">tods</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">fwee</span><span class="o">=</span><span class="n">prior</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="c1">#print &#39;means are &#39;,np.mean(np.abs(Ap.maps[0].map)),np.mean(np.abs(fwee))</span>
        <span class="n">Ap</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">Ap</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="o">+</span><span class="n">fwee</span>
        <span class="c1">#prior.apply_prior(Ap,p)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pAp</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">zr</span><span class="o">/</span><span class="n">pAp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">x_new</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">alpha</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">r_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">Ap</span><span class="p">,</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r_new</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">Ap</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">precon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">precon</span><span class="o">*</span><span class="n">r_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zr_new</span><span class="o">=</span><span class="n">r_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z_new</span><span class="p">)</span>
        <span class="n">beta</span><span class="o">=</span><span class="n">zr_new</span><span class="o">/</span><span class="n">zr</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">p_new</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">p_new</span><span class="o">=</span><span class="n">z_new</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">beta</span>
        
        <span class="n">p</span><span class="o">=</span><span class="n">p_new</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z_new</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r_new</span>
        <span class="n">zr</span><span class="o">=</span><span class="n">zr_new</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_new</span>
        <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.apply_noise.html#minkasi_wrapper.extern.minkasi.minkasi.apply_noise">[docs]</a><span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#dat=tod[&#39;dat_calib&#39;]</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">)</span>
    <span class="n">nn</span><span class="o">=</span><span class="n">datft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">datft</span><span class="o">=</span><span class="n">datft</span><span class="o">*</span><span class="n">tod</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span>
    <span class="n">dat_rot</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>
    <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">dat_rot</span><span class="p">)</span>
    <span class="c1">#for fft_r2r, the first/last samples get counted for half of the interior ones, so </span>
    <span class="c1">#divide them by 2 in the post-filtering.  Makes symmetry much happier...</span>
    <span class="c1">#print &#39;hello&#39;</span>
    <span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">dat</span></div>



<div class="viewcode-block" id="get_grad_mask_2d"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_grad_mask_2d.html#minkasi_wrapper.extern.minkasi.minkasi.get_grad_mask_2d">[docs]</a><span class="k">def</span> <span class="nf">get_grad_mask_2d</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">todvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span><span class="n">noisemap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">hitsmap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;make a mask that has an estimate of the gradient within a pixel.  Look at the </span>
<span class="sd">    rough expected noise to get an idea of which gradients are substantially larger than</span>
<span class="sd">    the map noise.&quot;&quot;&quot;</span>
    <span class="k">if</span>  <span class="n">noisemap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noisemap</span><span class="o">=</span><span class="n">make_hits</span><span class="p">(</span><span class="n">todvec</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">do_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">noisemap</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
        <span class="n">noisemap</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noisemap</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hitsmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hitsmap</span><span class="o">=</span><span class="n">make_hits</span><span class="p">(</span><span class="n">todvec</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">do_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mygrad</span><span class="o">=</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">mygrad</span><span class="o">=</span><span class="n">mygrad</span><span class="o">+</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">mygrad</span><span class="o">=</span><span class="n">mygrad</span><span class="o">+</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">mygrad</span><span class="o">=</span><span class="n">mygrad</span><span class="o">+</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">mygrad</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="n">mygrad</span><span class="p">)</span>



    <span class="c1">#find the typical timestream noise in a pixel, which should be the noise map times sqrt(hits)</span>
    <span class="n">hitsmask</span><span class="o">=</span><span class="n">hitsmap</span><span class="o">.</span><span class="n">map</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">noisemap</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tmp</span><span class="p">[</span><span class="n">hitsmask</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">hitsmask</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hitsmap</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">hitsmask</span><span class="p">])</span>
    <span class="c1">#return mygrad,tmp</span>
    <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">mygrad</span><span class="o">&gt;</span><span class="p">(</span><span class="n">thresh</span><span class="o">*</span><span class="n">tmp</span><span class="p">))</span>
    <span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">/</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cutting &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">frac</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f map pixels in get_grad_mask_2d.&quot;</span><span class="p">)</span>
    <span class="n">mygrad</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#return mygrad,tmp,noisemap</span>
    <span class="k">return</span> <span class="n">mygrad</span></div>

<div class="viewcode-block" id="null_precon"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.null_precon.html#minkasi_wrapper.extern.minkasi.minkasi.null_precon">[docs]</a><span class="k">class</span> <span class="nc">null_precon</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isnull</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="scaled_airmass_from_el"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.scaled_airmass_from_el.html#minkasi_wrapper.extern.minkasi.minkasi.scaled_airmass_from_el">[docs]</a><span class="k">def</span> <span class="nf">scaled_airmass_from_el</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="n">airmass</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="o">-</span><span class="n">airmass</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="c1">#airmass=airmass/np.std(airmass)</span>
    <span class="k">return</span> <span class="n">airmass</span></div>

<div class="viewcode-block" id="tsGeneric"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric">[docs]</a><span class="k">class</span> <span class="nc">tsGeneric</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="c1">#print(&#39;calling mul&#39;)</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span>
<div class="viewcode-block" id="tsGeneric.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="tsGeneric.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">common</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsGeneric.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">params</span></div>
<div class="viewcode-block" id="tsGeneric.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">):</span>
        <span class="n">Ax</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">Ax</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">params</span></div>
<div class="viewcode-block" id="tsGeneric.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsGeneric.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.html#minkasi_wrapper.extern.minkasi.minkasi.tsGeneric.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div></div>
<div class="viewcode-block" id="tsVecs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsVecs.html#minkasi_wrapper.extern.minkasi.minkasi.tsVecs">[docs]</a><span class="k">class</span> <span class="nc">tsVecs</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">vecs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="o">=</span><span class="n">vecs</span>
        <span class="c1">#self.ndet=tod.info[&#39;dat_calib&#39;].shape[0]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="o">=</span><span class="n">vecs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvec</span><span class="o">=</span><span class="n">vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">])</span>
<div class="viewcode-block" id="tsVecs.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsVecs.html#minkasi_wrapper.extern.minkasi.minkasi.tsVecs.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#mat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsVecs.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsVecs.html#minkasi_wrapper.extern.minkasi.minkasi.tsVecs.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#mat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[:]</span><span class="o">=</span><span class="n">mat</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>    </div></div>

<div class="viewcode-block" id="tsNotch"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsNotch.html#minkasi_wrapper.extern.minkasi.minkasi.tsNotch">[docs]</a><span class="k">class</span> <span class="nc">tsNotch</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">numin</span><span class="p">,</span><span class="n">numax</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_tvec</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">tvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bw</span><span class="o">=</span><span class="n">numax</span><span class="o">-</span><span class="n">numin</span>
        <span class="n">dnu</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">dt</span>
        <span class="n">nfreq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">bw</span><span class="o">/</span><span class="n">dnu</span><span class="p">))</span> <span class="c1">#factor of 2 is to account for partial waves</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">numin</span><span class="p">,</span><span class="n">numax</span><span class="p">,</span><span class="n">nfreq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span><span class="o">=</span><span class="n">nfreq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">nfreq</span><span class="p">,</span><span class="n">ndet</span><span class="p">])</span>
<div class="viewcode-block" id="tsNotch.get_vecs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsNotch.html#minkasi_wrapper.extern.minkasi.minkasi.tsNotch.get_vecs">[docs]</a>    <span class="k">def</span> <span class="nf">get_vecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tvec</span><span class="p">):</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tvec</span><span class="o">-</span><span class="n">tvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vecs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span><span class="p">):</span>
            <span class="n">vecs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tvec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">vecs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tvec</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vecs</span></div>
        
<div class="viewcode-block" id="tsNotch.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsNotch.html#minkasi_wrapper.extern.minkasi.minkasi.tsNotch.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_tvec</span><span class="p">()</span>
        <span class="n">vecs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vecs</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">T</span><span class="nd">@vecs</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[:]</span><span class="o">=</span><span class="n">mat</span><span class="p">[:]</span><span class="o">+</span><span class="n">pred</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[:]</span><span class="o">=</span><span class="n">pred</span></div>
<div class="viewcode-block" id="tsNotch.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsNotch.html#minkasi_wrapper.extern.minkasi.minkasi.tsNotch.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_tvec</span><span class="p">()</span>
        <span class="n">vecs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vecs</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="c1">#tmp=mat@(vecs.T)</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">vecs</span><span class="nd">@mat</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">tmp</span></div></div>


<div class="viewcode-block" id="tsPoly"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsPoly.html#minkasi_wrapper.extern.minkasi.minkasi.tsPoly">[docs]</a><span class="k">class</span> <span class="nc">tsPoly</span><span class="p">(</span><span class="n">tsVecs</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>

        <span class="c1">#self.ndata=tod.info[&#39;dat_calib&#39;].shape[1]</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndata</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="n">order</span>
        <span class="c1">#self.ndet=tod.info[&#39;dat_calib&#39;].shape[0]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nvec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">])</span></div>


<div class="viewcode-block" id="partition_interval"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.partition_interval.html#minkasi_wrapper.extern.minkasi.minkasi.partition_interval">[docs]</a><span class="k">def</span> <span class="nf">partition_interval</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">seg_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">round_up</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#print(&#39;partitioning &#39;,start,stop,seg_len)</span>
    <span class="c1">#make sure we behave correctly if the interval is shorter than the desired segment</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">seg_len</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">nseg</span><span class="o">=</span><span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">//</span><span class="n">seg_len</span>
    <span class="k">if</span> <span class="n">nseg</span><span class="o">*</span><span class="n">seg_len</span><span class="o">&lt;</span><span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">round_up</span><span class="p">:</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">seg_len</span><span class="o">=</span><span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">//</span><span class="n">nseg</span>
    <span class="n">nextra</span><span class="o">=</span><span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">-</span><span class="n">seg_len</span><span class="o">*</span><span class="n">nseg</span>
    <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">seg_len</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nextra</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nextra</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="o">+</span><span class="n">vec</span>
    <span class="k">return</span> <span class="n">inds</span></div>
    
<div class="viewcode-block" id="split_partitioned_vec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.split_partitioned_vec.html#minkasi_wrapper.extern.minkasi.minkasi.split_partitioned_vec">[docs]</a><span class="k">def</span> <span class="nf">split_partitioned_vec</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">breaks</span><span class="o">=</span><span class="p">[],</span><span class="n">seg_len</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">partition_interval</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">seg_len</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">breaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">start</span><span class="p">:</span>
        <span class="n">breaks</span><span class="o">=</span><span class="n">breaks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partition_interval</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">seg_len</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">breaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">stop</span><span class="p">:</span>
        <span class="n">breaks</span><span class="o">=</span><span class="n">breaks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partition_interval</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">seg_len</span><span class="p">)</span>
    <span class="n">breaks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">breaks</span><span class="p">,</span><span class="n">stop</span><span class="p">])</span>
    <span class="n">nseg</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">segs</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nseg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nseg</span><span class="p">):</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">partition_interval</span><span class="p">(</span><span class="n">breaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">breaks</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">seg_len</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">nseg</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">segs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">inds</span>
    <span class="n">segs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">segs</span></div>

<span class="c1">#breaks,stop,start=0,seg_len=100)</span>
<div class="viewcode-block" id="tsStripes"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes">[docs]</a><span class="k">class</span> <span class="nc">tsStripes</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">seg_len</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">do_slope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tthresh</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_tvec</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>        
        <span class="n">splits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span><span class="o">&gt;</span><span class="n">tthresh</span><span class="o">*</span><span class="n">dt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">split_partitioned_vec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">splits</span><span class="p">,</span><span class="n">seg_len</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="o">=</span><span class="n">inds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">=</span><span class="n">splits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">])</span>
<div class="viewcode-block" id="tsStripes.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need dat in tod2map destriper&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">tod2map_destriped</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsStripes.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need dat in map2tod destriper&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">map2tod_destriped</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsStripes.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsStripes.set_prior_from_corr"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes.set_prior_from_corr">[docs]</a>    <span class="k">def</span> <span class="nf">set_prior_from_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">corrvec</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">corrvec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrvec</span><span class="o">=</span><span class="n">corrvec</span><span class="p">[:,:</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">corrft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">corrvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thresh</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">corrft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">tt</span><span class="o">=</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">corrft</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="n">ind</span><span class="o">=</span><span class="n">corrft</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">&lt;</span><span class="n">tt</span>
                <span class="n">corrft</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="n">tt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">corrft</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>
<div class="viewcode-block" id="tsStripes.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">):</span>
        <span class="n">xft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>        
        <span class="n">Ax</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">Ax</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">xft</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div></div>
        
<div class="viewcode-block" id="tsStripes_old"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old">[docs]</a><span class="k">class</span> <span class="nc">tsStripes_old</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">seg_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">do_slope</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="n">nseg</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="n">seg_len</span>
        <span class="k">if</span> <span class="n">nseg</span><span class="o">*</span><span class="n">seg_len</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1">#this says to connect segments with straight lines as</span>
        <span class="c1">#opposed to simple horizontal offsets</span>
        <span class="k">if</span> <span class="n">do_slope</span><span class="p">:</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">=</span><span class="n">seg_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_slope</span><span class="o">=</span><span class="n">do_slope</span>
<div class="viewcode-block" id="tsStripes_old.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_slope</span><span class="p">:</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="n">vec2</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">vec</span>
            <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vec2</span><span class="p">,</span><span class="n">vec</span><span class="p">])</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="n">imax</span><span class="o">=</span><span class="n">nseg</span>
            <span class="k">if</span> <span class="n">nseg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">&lt;</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">have_extra</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">nextra</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">imax</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">have_extra</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">nextra</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imax</span><span class="p">):</span>
                <span class="c1">#tmp[:,i:i+2]=tmp[:,i:i+2]+dat[:,i*self.seg_len:(i+1)*self.seg_len]@(vv.T)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">],(</span><span class="n">vv</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">have_extra</span><span class="p">:</span>
                <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextra</span><span class="p">)</span><span class="o">/</span><span class="n">nextra</span>
                <span class="n">vec2</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">vec</span>
                <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vec2</span><span class="p">,</span><span class="n">vec</span><span class="p">])</span>
                <span class="c1">#tmp[:,-2:]=tmp[:,-2:]+dat[:,self.seg_len*nseg:]@(vv.T)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">*</span><span class="n">nseg</span><span class="p">:],(</span><span class="n">vv</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="k">if</span> <span class="n">nseg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">&lt;</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nseg</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">)</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ndat</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
                <span class="n">vec</span><span class="p">[:</span><span class="n">ndat</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vec</span><span class="p">,[</span><span class="n">nseg</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">tmp</span></div>

<div class="viewcode-block" id="tsStripes_old.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old.html#minkasi_wrapper.extern.minkasi.minkasi.tsStripes_old.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">ndat</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_slope</span><span class="p">:</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="n">vec2</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">vec</span>
            <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vec2</span><span class="p">,</span><span class="n">vec</span><span class="p">])</span>
            <span class="n">nseg</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="n">imax</span><span class="o">=</span><span class="n">nseg</span>
            <span class="k">if</span> <span class="n">imax</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">&lt;</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">have_extra</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">nextra</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">imax</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">have_extra</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">nseg</span><span class="o">=</span><span class="n">nseg</span><span class="o">-</span><span class="mi">1</span>
                <span class="c1">#imax=imax+1</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imax</span><span class="p">):</span>
                <span class="c1">#tmp[:,i*self.seg_len:(i+1)*self.seg_len]=self.params[:,i:i+2]@vv</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">vv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">have_extra</span><span class="p">:</span>
                <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nextra</span><span class="p">)</span><span class="o">/</span><span class="n">nextra</span>
                <span class="n">vec2</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">vec</span>
                <span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vec2</span><span class="p">,</span><span class="n">vec</span><span class="p">])</span>
                <span class="c1">#tmp[:,self.seg_len*nseg:]=self.params[:,-2:]@vv</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="o">*</span><span class="n">nseg</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span><span class="n">vv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">ndat</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
                <span class="n">pars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">mymod</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_len</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">mymod</span><span class="p">[:</span><span class="n">ndat</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tmp</span>
            <span class="k">return</span> <span class="n">dat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
                <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">tmp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">tmp</span></div></div>

<div class="viewcode-block" id="tsBinnedAz"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz">[docs]</a><span class="k">class</span> <span class="nc">tsBinnedAz</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span><span class="n">nbin</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
        <span class="c1">#print(&#39;nbin is&#39;,nbin)</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nbin</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span>
        
<div class="viewcode-block" id="tsBinnedAz.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">map2tod_binned_det</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsBinnedAz.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAz.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">tod2map_binned_det</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="tsBinnedAzShared"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared">[docs]</a><span class="k">class</span> <span class="nc">tsBinnedAzShared</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
<span class="c1">#&quot;&quot;&quot;class to have az shared amongst TODs (say, if you think the ground is constant for a while)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ndet</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span><span class="n">nbin</span><span class="o">=</span><span class="mi">360</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nbin</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span>
        
<div class="viewcode-block" id="tsBinnedAzShared.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">map2tod_binned_det</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsBinnedAzShared.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared.html#minkasi_wrapper.extern.minkasi.minkasi.tsBinnedAzShared.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nbin is&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">tod2map_binned_det</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">,</span><span class="n">do_add</span><span class="p">)</span></div></div>
<div class="viewcode-block" id="tsDetAz"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsDetAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsDetAz">[docs]</a><span class="k">class</span> <span class="nc">tsDetAz</span><span class="p">(</span><span class="n">tsGeneric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">npoly</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tsDetAz</span><span class="p">):</span> <span class="c1">#we&#39;re starting a new instance from an old one, e.g. from copy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">fname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">az</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azmin</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">azmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azmax</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">azmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">npoly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">ndet</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;AZ&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">azmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="o">=</span><span class="n">npoly</span>
            <span class="c1">#self.ndet=tod.info[&#39;dat_calib&#39;].shape[0]            </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
        <span class="c1">#self.params=np.zeros([self.ndet,self.npoly])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_get_polys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">polys</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="p">)])</span>
        <span class="n">polys</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">az_scale</span><span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">az</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">azmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">azmin</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">-</span><span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">polys</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">az_scale</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">npoly</span><span class="p">):</span>
            <span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">az_scale</span><span class="o">*</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,:]</span>
        <span class="n">polys</span><span class="o">=</span><span class="n">polys</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">polys</span>
<div class="viewcode-block" id="tsDetAz.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsDetAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsDetAz.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#dat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_polys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_polys</span><span class="p">())</span></div>
<div class="viewcode-block" id="tsDetAz.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsDetAz.html#minkasi_wrapper.extern.minkasi.minkasi.tsDetAz.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#dat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="c1">#print(&quot;params shape is &quot;,self.params.shape)</span>
            <span class="c1">#self.params[:]=self.params[:]+np.dot(self._get_polys(),dat)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_polys</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.params[:]=np.dot(self._get_polys(),dat)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_polys</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div></div>

        
<div class="viewcode-block" id="tsAirmass"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass">[docs]</a><span class="k">class</span> <span class="nc">tsAirmass</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.sz=tod.info[&#39;dat_calib&#39;].shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;apix&#39;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1">#tod.info[&#39;apix&#39;]=scaled_airmass_from_el(tod.info[&#39;elev&#39;])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="n">scaled_airmass_from_el</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;apix&#39;</span><span class="p">]</span>
<div class="viewcode-block" id="tsAirmass.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">copyMat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">tsAirmass</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span>
        <span class="k">if</span> <span class="n">copyMat</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>  <span class="c1">#since this shouldn&#39;t change, use a pointer to not blow up RAM</span>
        <span class="k">return</span> <span class="n">cp</span></div>
<div class="viewcode-block" id="tsAirmass.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.0</span></div>
<div class="viewcode-block" id="tsAirmass.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsAirmass.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">params</span></div>
    <span class="k">def</span> <span class="nf">_get_current_legmat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">m1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m1</span>
    <span class="k">def</span> <span class="nf">_get_current_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">m1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_legmat</span><span class="p">()</span>
        <span class="n">poly</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">poly</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>
        <span class="k">return</span> <span class="n">mat</span>

<div class="viewcode-block" id="tsAirmass.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">):</span>
            <span class="c1">#tmp[i]=np.sum(tod.info[&#39;apix&#39;]**(i+1)*dat)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">tmp</span></div>
        <span class="c1">#poly=self._get_current_legmat()</span>
        <span class="c1">#vec=np.sum(dat*self.airmass,axis=0)</span>
        <span class="c1">#atd=np.dot(vec,poly)</span>
        <span class="c1">#if do_add:</span>
        <span class="c1">#    self.params[:]=self.params[:]+atd</span>
        <span class="c1">#else:</span>
        <span class="c1">#    self.params[:]=atd</span>

<div class="viewcode-block" id="tsAirmass.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mat</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">):</span>
            <span class="c1">#mat=mat+self.params[i]*tod.info[&#39;apix&#39;]**(i+1)</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#mat=self._get_current_model()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">mat</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span>
<div class="viewcode-block" id="tsAirmass.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.html#minkasi_wrapper.extern.minkasi.minkasi.tsAirmass.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<span class="k">class</span> <span class="nc">__tsAirmass_old</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.sz=tod.info[&#39;dat_calib&#39;].shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="n">scaled_airmass_from_el</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">copyMat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">tsAirmass</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span>
        <span class="k">if</span> <span class="n">copyMat</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">airmass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>  <span class="c1">#since this shouldn&#39;t change, use a pointer to not blow up RAM</span>
        <span class="k">return</span> <span class="n">cp</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">params</span>
    <span class="k">def</span> <span class="nf">_get_current_legmat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">m1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legvander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m1</span>
    <span class="k">def</span> <span class="nf">_get_current_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">m1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_legmat</span><span class="p">()</span>
        <span class="n">poly</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">poly</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span>
        <span class="k">return</span> <span class="n">mat</span>

    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">poly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_legmat</span><span class="p">()</span>
        <span class="n">vec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">airmass</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">atd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">poly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">atd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="n">atd</span>

    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">mat</span>
        <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
            <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="tsCommon"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon">[docs]</a><span class="k">class</span> <span class="nc">tsCommon</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.sz=tod.info[&#39;dat_calib&#39;].shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
<div class="viewcode-block" id="tsCommon.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">tsCommon</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="k">except</span><span class="p">:</span><span class="c1">#if the size doesn&#39;t have a copy function, then it&#39;s probably a number you can just assign</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">cp</span></div>
<div class="viewcode-block" id="tsCommon.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.0</span></div>
<div class="viewcode-block" id="tsCommon.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">common</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">common</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsCommon.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">params</span></div>
        
<div class="viewcode-block" id="tsCommon.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#assert(self.fname==tod.info[&#39;fname&#39;]</span>
        <span class="n">nm</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsCommon.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">nm</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsCommon.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCommon.html#minkasi_wrapper.extern.minkasi.minkasi.tsCommon.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span></div>
<div class="viewcode-block" id="detOffset"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset">[docs]</a><span class="k">class</span> <span class="nc">detOffset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.sz=tod.info[&#39;dat_calib&#39;].shape[0]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
<div class="viewcode-block" id="detOffset.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">detOffset</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="k">return</span> <span class="n">cp</span></div>
<div class="viewcode-block" id="detOffset.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="detOffset.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="detOffset.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">params</span></div>
<div class="viewcode-block" id="detOffset.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
<div class="viewcode-block" id="detOffset.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></div>
<div class="viewcode-block" id="detOffset.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.detOffset.html#minkasi_wrapper.extern.minkasi.minkasi.detOffset.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span></div>

<div class="viewcode-block" id="tsCalib"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib">[docs]</a><span class="k">class</span> <span class="nc">tsCalib</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.sz=tod.info[&#39;dat_calib&#39;].shape[0]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
<div class="viewcode-block" id="tsCalib.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">tsCalib</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">sz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">pred</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span>
        <span class="k">return</span> <span class="n">cp</span></div>
<div class="viewcode-block" id="tsCalib.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="tsCalib.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsCalib.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">params</span></div>
<div class="viewcode-block" id="tsCalib.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsCalib.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[:]</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></div>
<div class="viewcode-block" id="tsCalib.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsCalib.html#minkasi_wrapper.extern.minkasi.minkasi.tsCalib.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="n">tt</span></div>
    
    
    
<div class="viewcode-block" id="tsModel"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel">[docs]</a><span class="k">class</span> <span class="nc">tsModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">todvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">modelclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">todvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">todvec</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="n">nm</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">=</span><span class="n">modelclass</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="tsModel.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_tsModel</span><span class="o">=</span><span class="n">tsModel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_tsModel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_tsModel</span></div>

<div class="viewcode-block" id="tsModel.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">nm</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsModel.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">nm</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>

<div class="viewcode-block" id="tsModel.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">],</span><span class="n">Ax</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span></div>
<div class="viewcode-block" id="tsModel.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tsmodels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tsmodels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if tsmodels.data.has_key(nm):</span>
                <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">tsmodels</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tsmodels</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in tsModel.dot - missing key &#39;</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                    <span class="k">assert</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#pretty sure we want to crash if missing names</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="n">tot</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div>
<div class="viewcode-block" id="tsModel.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
<div class="viewcode-block" id="tsModel.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tsmodel</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">tsmodel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">],</span><span class="n">a</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tsmodel</span><span class="p">):</span> <span class="c1">#this is used in preconditioning - need to fix if ts-based preconditioning is desired        </span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tt</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">*</span><span class="n">tsmodel</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tt</span>
        <span class="c1">#for nm in tt.data.keys():</span>
        <span class="c1">#    tt.params[nm]=tt.params[nm]*tsmodel.params[nm]</span>
    <span class="k">def</span> <span class="nf">mpi_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
<div class="viewcode-block" id="tsModel.get_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.get_caches">[docs]</a>    <span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">get_caches</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>
<div class="viewcode-block" id="tsModel.clear_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>
<div class="viewcode-block" id="tsModel.mpi_reduce"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsModel.mpi_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">mpi_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="tsMultiModel"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel">[docs]</a><span class="k">class</span> <span class="nc">tsMultiModel</span><span class="p">(</span><span class="n">tsModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to hold timestream models that are shared between groups of TODs.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">todvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">todtags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">modelclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ts_multi_model&#39;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">todtags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">alltags</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allgather</span><span class="p">(</span><span class="n">todtags</span><span class="p">)</span>
            <span class="n">alltags</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">alltags</span><span class="p">)</span>
            <span class="n">alltags</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">alltags</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">modelclass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">mytag</span> <span class="ow">in</span> <span class="n">alltags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mytag</span><span class="p">]</span><span class="o">=</span><span class="n">modelclass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">todvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">tod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">todvec</span><span class="o">.</span><span class="n">tods</span><span class="p">):</span>
                    <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">=</span><span class="n">todtags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<div class="viewcode-block" id="tsMultiModel.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsMultiModel.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">]]</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsMultiModel.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">]]</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>
<div class="viewcode-block" id="tsMultiModel.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.html#minkasi_wrapper.extern.minkasi.minkasi.tsMultiModel.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tsmodels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tsmodels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">tsmodels</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tsmodels</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">nm</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in tsMultiModel.dot - missing key &#39;</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
                    <span class="k">assert</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div></div>
<div class="viewcode-block" id="Mapset"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset">[docs]</a><span class="k">class</span> <span class="nc">Mapset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="o">=</span><span class="p">[]</span>
<div class="viewcode-block" id="Mapset.add_map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.add_map">[docs]</a>    <span class="k">def</span> <span class="nf">add_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="o">+</span><span class="mi">1</span></div>
<div class="viewcode-block" id="Mapset.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
<div class="viewcode-block" id="Mapset.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_mapset</span><span class="o">=</span><span class="n">Mapset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="n">new_mapset</span><span class="o">.</span><span class="n">add_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">new_mapset</span></div>
<div class="viewcode-block" id="Mapset.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tot</span></div>
<div class="viewcode-block" id="Mapset.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">a</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">):</span>
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mm</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">mapset</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mm</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">):</span>
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mm</span><span class="o">.</span><span class="n">axpy</span><span class="p">(</span><span class="n">mapset</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mm</span>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">):</span>
        <span class="c1">#mm=self.copy()</span>
        <span class="n">mm</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#return mm</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="c1">#print(&#39;callin mul on map &#39;,i)</span>
            <span class="n">mm</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mm</span>
<div class="viewcode-block" id="Mapset.get_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.get_caches">[docs]</a>    <span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_caches</span><span class="p">()</span></div>
<div class="viewcode-block" id="Mapset.clear_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span></div>
<div class="viewcode-block" id="Mapset.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isglobal_prior</span><span class="p">:</span>
                        <span class="c1">#print(&#39;applying global prior&#39;)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Ax</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#print(&#39;going through exception&#39;)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">apply_prior</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Ax</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>
<div class="viewcode-block" id="Mapset.mpi_reduce"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Mapset.html#minkasi_wrapper.extern.minkasi.minkasi.Mapset.mpi_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">mpi_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span>
                <span class="nb">map</span><span class="o">.</span><span class="n">mpi_reduce</span><span class="p">()</span></div></div>
<span class="c1">#class Cuts:</span>
<span class="c1">#    def __init__(self,tod):</span>
<span class="c1">#        self.tag=tod.info[&#39;tag&#39;]</span>
<span class="c1">#        self.ndet=tod.info[&#39;dat_calib&#39;].shape[0]</span>
<span class="c1">#        self.cuts=[None]*self.ndet</span>
<span class="c1">#</span>
<span class="c1">#class CutsVec:</span>
<span class="c1">#    def __init__(self,todvec):</span>
<span class="c1">#        self.ntod=todvec.ntod</span>
<span class="c1">#        self.cuts=[None]*self.ntod</span>
<span class="c1">#        for tod in todvec.tods:</span>
<span class="c1">#            self.cuts[tod.info[&#39;tag&#39;]]=Cuts(tod)</span>
            
<div class="viewcode-block" id="SkyMap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap">[docs]</a><span class="k">class</span> <span class="nc">SkyMap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;CAR&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">primes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cosdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mywcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ipix&#39;</span><span class="p">,</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ref_equ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mywcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">pixsize</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#we had better have a pixel size if we don&#39;t have an incoming WCS that contains it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">=</span><span class="n">get_wcs</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="p">,</span><span class="n">proj</span><span class="p">,</span><span class="n">cosdec</span><span class="p">,</span><span class="n">ref_equ</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">=</span><span class="n">mywcs</span>
            <span class="n">pixsize_use</span><span class="o">=</span><span class="n">mywcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
            <span class="c1">#print(&#39;pixel size from wcs and requested are &#39;,pixsize_use,pixsize,100*(pixsize_use-pixsize)/pixsize)</span>
            <span class="n">pixsize</span><span class="o">=</span><span class="n">pixsize_use</span>
            
        <span class="n">corners</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">pix_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">corners</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pix_corners</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">)</span>

        <span class="c1">#print pix_corners</span>
        <span class="c1">#print type(pix_corners)</span>
        <span class="c1">#if pix_corners.min()&lt;0.5:</span>
        <span class="k">if</span> <span class="n">pix_corners</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;-</span><span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;corners seem to have gone negative in SkyMap projection.  not good, you may want to check this.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#try a patch to fix the wcs xxx</span>
            <span class="k">if</span> <span class="n">nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ny</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ny</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
            <span class="n">ny</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
        <span class="c1">#print nx,ny</span>
        <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">ny</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">primes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">lens</span><span class="o">=</span><span class="n">find_good_fft_lens</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="n">ny</span><span class="p">),</span><span class="n">primes</span><span class="p">)</span>
            <span class="c1">#print &#39;nx and ny initially are &#39;,nx,ny</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">lens</span><span class="p">[</span><span class="n">lens</span><span class="o">&gt;=</span><span class="n">nx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">lens</span><span class="p">[</span><span class="n">lens</span><span class="o">&gt;=</span><span class="n">ny</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="c1">#print &#39;small prime nx and ny are now &#39;,nx,ny</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="o">=</span><span class="n">primes</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="n">lims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="o">=</span><span class="n">pixsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">=</span><span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="o">=</span><span class="n">pad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="n">purge_pixellization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="o">=</span><span class="n">cosdec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="kc">None</span>
<div class="viewcode-block" id="SkyMap.get_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.get_caches">[docs]</a>    <span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
        <span class="n">nthread</span><span class="o">=</span><span class="n">get_nthread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nthread</span><span class="p">,</span><span class="n">npix</span><span class="p">])</span></div>
<div class="viewcode-block" id="SkyMap.clear_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span></div>
<div class="viewcode-block" id="SkyMap.set_tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.set_tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">set_tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">todvec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select which method of tod2map to use.  options include simple (1 proc), omp (everyone makes a map copy), everyone (everyone loops through</span>
<span class="sd">           all the data but assigns only to their own piece), atomic (no map copy, accumulate via atomic adds), and cached (every thread has a sticky</span>
<span class="sd">           copy of the map).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nproc</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_simple</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_omp</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;omp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_omp</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_simple</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;everyone&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">todvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need tods when setting to everyone so we can know which pieces belong to which threads&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">todvec</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
                <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ipix</span><span class="o">=</span><span class="n">ipix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">ipix</span><span class="p">)</span>
                <span class="n">ipix</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">inds</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ipix</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">nproc</span>
                <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">save_pixellization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_edges&#39;</span><span class="p">,</span><span class="n">inds</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_everyone</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;cached&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_caches</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tod2map_cached</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;atomic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tod2map_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">todmap_atomic</span></div>
<div class="viewcode-block" id="SkyMap.tod2map_atomic"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.tod2map_atomic">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMap.todmap_omp"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.todmap_omp">[docs]</a>    <span class="k">def</span> <span class="nf">todmap_omp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMap.tod2map_simple"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.tod2map_simple">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span></div>
    <span class="c1">#def tod2map_cached(self.map,dat,ipix):</span>
    <span class="c1">#    ipix=self.get_pix(tod)</span>
    <span class="c1">#    tod2map_cached(map,dat,ipix)</span>

<div class="viewcode-block" id="SkyMap.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">newmap</span><span class="o">=</span><span class="n">SkyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="p">,</span><span class="n">cosdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">mywcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">newmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="n">newmap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMap.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="SkyMap.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="SkyMap.assign"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="c1">#self.map[:,:]=arr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">arr</span></div>
<div class="viewcode-block" id="SkyMap.pix_from_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.pix_from_radec">[docs]</a>    <span class="k">def</span> <span class="nf">pix_from_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsamp</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">ndet</span><span class="o">*</span><span class="n">nsamp</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nn</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1">#coords[:,0]=np.reshape(tod.info[&#39;dx&#39;]*180/np.pi,nn)</span>
        <span class="c1">#coords[:,1]=np.reshape(tod.info[&#39;dy&#39;]*180/np.pi,nn)</span>
        <span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ra</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dec</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>


        <span class="c1">#print coords.shape</span>
        <span class="n">pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print pix.shape</span>
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#-1 is to go between unit offset in FITS and zero offset in python</span>
        <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xpix</span><span class="p">)</span>
        <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ypix</span><span class="p">)</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div>

<div class="viewcode-block" id="SkyMap.get_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.get_pix">[docs]</a>    <span class="k">def</span> <span class="nf">get_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">savepix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ipix</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ipix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ipix</span>
        <span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_radec</span><span class="p">()</span>
        <span class="c1">#ndet=tod.info[&#39;dx&#39;].shape[0]</span>
        <span class="c1">#nsamp=tod.info[&#39;dx&#39;].shape[1]</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nsamp</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nn</span><span class="o">=</span><span class="n">ndet</span><span class="o">*</span><span class="n">nsamp</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nn</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1">#coords[:,0]=np.reshape(tod.info[&#39;dx&#39;]*180/np.pi,nn)</span>
        <span class="c1">#coords[:,1]=np.reshape(tod.info[&#39;dy&#39;]*180/np.pi,nn)</span>
            <span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ra</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dec</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>


        <span class="c1">#print coords.shape</span>
            <span class="n">pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print pix.shape</span>
            <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#-1 is to go between unit offset in FITS and zero offset in python</span>
            <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  
            <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xpix</span><span class="p">)</span>
            <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ypix</span><span class="p">)</span>
            <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_from_radec</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savepix</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">save_pixellization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div>
<div class="viewcode-block" id="SkyMap.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="c1">#map2tod(dat,self.map,tod.info[&#39;ipix&#39;],do_add,do_omp)</span>
        <span class="n">map2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkyMap.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>        
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#tod2map_cached(self.caches,dat,tod.info[&#39;ipix&#39;])</span>
            <span class="n">tod2map_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_omp</span><span class="p">:</span>
                <span class="c1">#tod2map_omp(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#tod2map_simple(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="p">:</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">clear_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkyMap.tod2map_old"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.tod2map_old">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#tod2map_cached(self.caches,dat,tod.info[&#39;ipix&#39;])</span>
            <span class="n">tod2map_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_omp</span><span class="p">:</span>
                <span class="c1">#tod2map_omp(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#tod2map_simple(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="p">:</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">clear_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkyMap.r_th_maps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.r_th_maps">[docs]</a>    <span class="k">def</span> <span class="nf">r_th_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">xvec</span><span class="o">-</span><span class="n">xvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>        
        <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">yvec</span><span class="o">=</span><span class="n">yvec</span><span class="o">-</span><span class="n">yvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ymat</span><span class="p">,</span><span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yvec</span><span class="p">,</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xmat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ymat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">th</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xmat</span><span class="p">,</span><span class="n">ymat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rmat</span><span class="p">,</span><span class="n">th</span></div>
<div class="viewcode-block" id="SkyMap.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div>
        
<div class="viewcode-block" id="SkyMap.plot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plot_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">clf</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">pause</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">pause_len</span><span class="o">=</span><span class="mf">0.001</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">plot_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;vmin&#39;</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;vmax&#39;</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;clf&#39;</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">clf</span><span class="o">=</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;clf&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;pause&#39;</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pause</span><span class="o">=</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;pause&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pause_len</span> <span class="ow">in</span> <span class="n">plot_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pause_len</span><span class="o">=</span><span class="n">plot_info</span><span class="p">[</span><span class="s1">&#39;pause_len&#39;</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
        <span class="k">if</span> <span class="n">clf</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pause</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">pause_len</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkyMap.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;map.fits&#39;</span><span class="p">):</span>
        <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#try a patch to fix the wcs xxx </span>
            <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">new_map</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">new_map</span>
<div class="viewcode-block" id="SkyMap.mpi_reduce"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.mpi_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">mpi_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chunksize</span><span class="o">=</span><span class="mf">1e5</span><span class="p">):</span>
        <span class="c1">#chunksize is added since at least on my laptop mpi4py barfs if it</span>
        <span class="c1">#tries to reduce an nside=512 healpix map, so need to break it into pieces.</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="c1">#print(&quot;reducing map&quot;)</span>
            <span class="k">if</span> <span class="n">chunksize</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span><span class="o">/</span><span class="n">chunksize</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nchunk</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1">#print(&#39;nchunk is &#39;,nchunk)</span>
            <span class="k">if</span> <span class="n">nchunk</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">nchunk</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="c1">#self.map[inds[i]:inds[i+1]]=comm.allreduce(self.map[inds[i]:inds[i+1]])</span>
                    <span class="c1">#tmp=np.zeros(inds[i+1]-inds[i])</span>
                    <span class="c1">#tmp[:]=self.map[inds[i]:inds[i+1]]</span>
                    <span class="c1">#tmp=comm.allreduce(tmp)</span>
                    <span class="c1">#self.map[inds[i]:inds[i+1]]=tmp</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>
            
            <span class="c1">#print(&quot;reduced&quot;)</span>
<div class="viewcode-block" id="SkyMap.invert"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMap.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMap.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="MapNoiseWhite"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.MapNoiseWhite.html#minkasi_wrapper.extern.minkasi.minkasi.MapNoiseWhite">[docs]</a><span class="k">class</span> <span class="nc">MapNoiseWhite</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar_map</span><span class="p">,</span><span class="n">isinv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nfac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="o">=</span><span class="n">read_fits_map</span><span class="p">(</span><span class="n">ivar_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">isinv</span><span class="p">):</span>
            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="o">&gt;</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ivar</span><span class="o">*</span><span class="n">nfac</span>
<div class="viewcode-block" id="MapNoiseWhite.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.MapNoiseWhite.html#minkasi_wrapper.extern.minkasi.minkasi.MapNoiseWhite.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">map</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ivar</span></div></div>
    
<div class="viewcode-block" id="SkyMapCoarse"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse">[docs]</a><span class="k">class</span> <span class="nc">SkyMapCoarse</span><span class="p">(</span><span class="n">SkyMap</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<div class="viewcode-block" id="SkyMapCoarse.get_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.get_caches">[docs]</a>    <span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span></div>
<div class="viewcode-block" id="SkyMapCoarse.clear_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span></div>
<div class="viewcode-block" id="SkyMapCoarse.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cp</span></div>
<div class="viewcode-block" id="SkyMapCoarse.get_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.get_pix">[docs]</a>    <span class="k">def</span> <span class="nf">get_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span></div>
<div class="viewcode-block" id="SkyMapCoarse.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span></div>
<div class="viewcode-block" id="SkyMapCoarse.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCoarse.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span></div></div>
<div class="viewcode-block" id="SkyMapTwoRes"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes">[docs]</a><span class="k">class</span> <span class="nc">SkyMapTwoRes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A pair of maps to serve as a prior for multi-experiment mapping.  This would e.g. be the ACT map that e.g. Mustang should agree</span>
<span class="sd">    with on large scales.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">map_lowres</span><span class="p">,</span><span class="n">lims</span><span class="p">,</span><span class="n">osamp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">smooth_fac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">small_wcs</span><span class="p">,</span><span class="n">lims_use</span><span class="p">,</span><span class="n">map_corner</span><span class="o">=</span><span class="n">get_aligned_map_subregion_car</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span><span class="n">map_lowres</span><span class="p">,</span><span class="n">osamp</span><span class="o">=</span><span class="n">osamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">small_lims</span><span class="o">=</span><span class="n">lims_use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">small_wcs</span><span class="o">=</span><span class="n">small_wcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">read_fits_map</span><span class="p">(</span><span class="n">map_lowres</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="o">=</span><span class="n">osamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="o">=</span><span class="n">map_corner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamft</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_deconvolved</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine_prior</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isglobal_prior</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_fac</span><span class="o">=</span><span class="n">smooth_fac</span>
<div class="viewcode-block" id="SkyMapTwoRes.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.get_map_deconvolved"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.get_map_deconvolved">[docs]</a>    <span class="k">def</span> <span class="nf">get_map_deconvolved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">map_deconvolved</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_deconvolved</span><span class="o">=</span><span class="n">read_fits_map</span><span class="p">(</span><span class="n">map_deconvolved</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.set_beam_gauss"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.set_beam_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">set_beam_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fwhm_pix</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">get_ft_vec</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yvec</span><span class="o">=</span><span class="n">get_ft_vec</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yvec</span><span class="p">,</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">rsqr</span><span class="o">=</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">sig_pix</span><span class="o">=</span><span class="n">fwhm_pix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">beam</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rsqr</span><span class="o">/</span><span class="p">(</span><span class="n">sig_pix</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">beam</span><span class="o">=</span><span class="n">beam</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.set_beam_1d"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.set_beam_1d">[docs]</a>    <span class="k">def</span> <span class="nf">set_beam_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prof</span><span class="p">,</span><span class="n">pixsize</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">get_ft_vec</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yvec</span><span class="o">=</span><span class="n">get_ft_vec</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yvec</span><span class="p">,</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">rsqr</span><span class="o">=</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">rr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rsqr</span><span class="p">)</span><span class="o">*</span><span class="n">pixsize</span>
        <span class="n">beam</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">prof</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">prof</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">beam</span><span class="o">=</span><span class="n">beam</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beamft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span></div>


<div class="viewcode-block" id="SkyMapTwoRes.set_noise_white"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.set_noise_white">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise_white</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar_map</span><span class="p">,</span><span class="n">isinv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nfac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="n">MapNoiseWhite</span><span class="p">(</span><span class="n">ivar_map</span><span class="p">,</span><span class="n">isinv</span><span class="p">,</span><span class="n">nfac</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.maps2fine"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.maps2fine">[docs]</a>    <span class="k">def</span> <span class="nf">maps2fine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fine</span><span class="p">,</span><span class="n">coarse</span><span class="p">):</span>
        <span class="n">out</span><span class="o">=</span><span class="n">fine</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)]</span><span class="o">=</span><span class="n">coarse</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">fine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.maps2coarse"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.maps2coarse">[docs]</a>    <span class="k">def</span> <span class="nf">maps2coarse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fine</span><span class="p">,</span><span class="n">coarse</span><span class="p">):</span>
        <span class="n">out</span><span class="o">=</span><span class="n">coarse</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">coarse</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fine</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">out</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.coarse2maps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.coarse2maps">[docs]</a>    <span class="k">def</span> <span class="nf">coarse2maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inmap</span><span class="p">):</span>
        <span class="n">coarse</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">inmap</span>
        <span class="n">fine</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">):</span>
                <span class="n">coarse</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">inmap</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">fine</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)]</span><span class="o">=</span><span class="n">inmap</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">return</span> <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.set_mask"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.set_mask">[docs]</a>    <span class="k">def</span> <span class="nf">set_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hits</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">=</span><span class="n">hits</span><span class="o">&gt;</span><span class="n">thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine_prior</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">hits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fine_prior</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_deconvolved</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.apply_Qinv"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.apply_Qinv">[docs]</a>    <span class="k">def</span> <span class="nf">apply_Qinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_prior</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">tmp2</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">map_deconvolved</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
                <span class="n">tmp2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)])</span>
        <span class="n">tmp2_conv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beamft</span><span class="p">)</span>
        <span class="n">tmp2_conv_filt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp2_conv</span><span class="p">)</span>
        <span class="n">tmp2_reconv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">tmp2_conv_filt</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beamft</span><span class="p">)</span>
        <span class="c1">#tmp2_reconv=np.fft.irfft2(np.fft.rfft2(tmp2_conv)*self.beamft)</span>
        <span class="c1">#tmp2_reconv=tmp2.copy()</span>
        <span class="n">fac</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span><span class="p">):</span>
                <span class="n">tmp</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">),(</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">):((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="p">)]</span><span class="o">=</span><span class="n">fac</span><span class="o">*</span><span class="n">tmp2_reconv</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ans</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">tmp</span>
        <span class="n">ans</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ans</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.apply_H"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.apply_H">[docs]</a>    <span class="k">def</span> <span class="nf">apply_H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="p">):</span>
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps2coarse</span><span class="p">(</span><span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="p">)</span>
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mm</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.apply_HT"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.apply_HT">[docs]</a>    <span class="k">def</span> <span class="nf">apply_HT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mm</span><span class="p">):</span>
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
        <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse2maps</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.get_rhs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.get_rhs">[docs]</a>    <span class="k">def</span> <span class="nf">get_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">):</span>
        <span class="c1">#if map is None:</span>
        <span class="c1">#    map=self.map</span>
        <span class="c1">#map_filt=self.noise.apply_noise(map)</span>
        <span class="c1">#map_filt_conv=np.fft.irfft2(np.fft.rfft2(map_filt)*self.beamft)</span>
        <span class="c1">#tmp=0.0*self.mask</span>
        <span class="c1">#fac=1.0/self.osamp**2</span>
        <span class="c1">#for i in range(self.nx_coarse):</span>
        <span class="c1">#    for j in range(self.ny_coarse):</span>
        <span class="c1">#        tmp[(i*self.osamp):((i+1)*self.osamp),(j*self.osamp):((j+1)*self.osamp)]=fac*map_filt_conv[i+self.map_corner[0],j+self.map_corner[1]]</span>

        <span class="c1">#ans=0*tmp</span>
        <span class="c1">#ans[self.mask]=tmp[self.mask]</span>
        <span class="c1">#return ans</span>
        

        <span class="n">coarse_ind</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">fine_ind</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">SkyMapCoarse</span><span class="p">):</span>
                <span class="n">coarse_ind</span><span class="o">=</span><span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">SkyMap</span><span class="p">):</span>
                    <span class="n">fine_ind</span><span class="o">=</span><span class="n">i</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coarse_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">fine_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Errror in twolevel prior:  either fine or coarse skymap not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        
        <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_HT</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">coarse</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">fine</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
            <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse2maps</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
            <span class="n">i1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i2</span><span class="o">=</span><span class="n">i1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nx_coarse</span>
            <span class="n">j1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">j2</span><span class="o">=</span><span class="n">j1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ny_coarse</span>
            <span class="n">coarse</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span><span class="o">=</span><span class="n">coarse</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_facs</span><span class="p">)</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">coarse</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">+</span><span class="n">fine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">osamp</span><span class="o">**</span><span class="mi">2</span></div>

<div class="viewcode-block" id="SkyMapTwoRes.beam_convolve"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.beam_convolve">[docs]</a>    <span class="k">def</span> <span class="nf">beam_convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">mapft</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
        <span class="n">mapft</span><span class="o">=</span><span class="n">mapft</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beamft</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft2</span><span class="p">(</span><span class="n">mapft</span><span class="p">)</span></div>
<div class="viewcode-block" id="SkyMapTwoRes.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapTwoRes.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">outmapset</span><span class="p">):</span>
        <span class="n">coarse_ind</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">fine_ind</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">nmap</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">SkyMapCoarse</span><span class="p">):</span>
                <span class="n">coarse_ind</span><span class="o">=</span><span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">SkyMap</span><span class="p">):</span>
                    <span class="n">fine_ind</span><span class="o">=</span><span class="n">i</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">coarse_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">fine_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Errror in twolevel prior:  either fine or coarse skymap not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">mm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_H</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="n">mm_filt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
            <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_HT</span><span class="p">(</span><span class="n">mm_filt</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps2coarse</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="n">summed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">summed</span><span class="p">)</span>
            <span class="n">summed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">summed</span><span class="p">)</span>
            <span class="n">summed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">summed</span><span class="p">)</span>
            <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse2maps</span><span class="p">(</span><span class="n">summed</span><span class="p">)</span>

        <span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">+</span><span class="n">fine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">coarse</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_fac</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">summed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps2coarse</span><span class="p">(</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="n">summed_smooth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">summed</span><span class="p">)</span>
            <span class="n">delt</span><span class="o">=</span><span class="n">summed</span><span class="o">-</span><span class="n">summed_smooth</span>
            <span class="n">delt_filt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_fac</span>
            <span class="n">delt_filt</span><span class="o">=</span><span class="n">delt_filt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">beam_convolve</span><span class="p">(</span><span class="n">delt_filt</span><span class="p">)</span>
            <span class="n">coarse</span><span class="p">,</span><span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coarse2maps</span><span class="p">(</span><span class="n">delt_filt</span><span class="p">)</span>
            <span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">fine_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">+</span><span class="n">fine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">outmapset</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">coarse_ind</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">coarse</span></div>
            



    <span class="k">def</span> <span class="nf">__bust_apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">outmap</span><span class="p">):</span>
        <span class="n">outmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">outmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_Qinv</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">)</span></div>
              


<div class="viewcode-block" id="poltag2pols"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.poltag2pols.html#minkasi_wrapper.extern.minkasi.minkasi.poltag2pols">[docs]</a><span class="k">def</span> <span class="nf">poltag2pols</span><span class="p">(</span><span class="n">poltag</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU_PRECON&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="s1">&#39;QQ&#39;</span><span class="p">,</span><span class="s1">&#39;QU&#39;</span><span class="p">,</span><span class="s1">&#39;UU&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU_PRECON&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;QQ&#39;</span><span class="p">,</span><span class="s1">&#39;UU&#39;</span><span class="p">,</span><span class="s1">&#39;QU&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="PolMap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap">[docs]</a><span class="k">class</span> <span class="nc">PolMap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="p">,</span><span class="n">poltag</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;CAR&#39;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">primes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cosdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mywcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ipix&#39;</span><span class="p">,</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ref_equ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">pols</span><span class="o">=</span><span class="n">poltag2pols</span><span class="p">(</span><span class="n">poltag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unrecognized polarization state &#39;</span> <span class="o">+</span> <span class="n">poltag</span> <span class="o">+</span> <span class="s1">&#39; in PolMap.__init__&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">npol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mywcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">=</span><span class="n">get_wcs</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="p">,</span><span class="n">proj</span><span class="p">,</span><span class="n">cosdec</span><span class="p">,</span><span class="n">ref_equ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">=</span><span class="n">mywcs</span>
        <span class="n">corners</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">pix_corners</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">corners</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>        
        <span class="n">pix_corners</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">)</span>
        <span class="c1">#print pix_corners</span>
        <span class="c1">#print type(pix_corners)</span>
        <span class="c1">#if pix_corners.min()&lt;0.5:</span>
        <span class="k">if</span> <span class="n">pix_corners</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;-</span><span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;corners seem to have gone negative in SkyMap projection.  not good, you may want to check this.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#try a patch to fix the wcs xxx</span>
            <span class="k">if</span> <span class="n">nx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ny</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ny</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
            <span class="n">ny</span><span class="o">=</span><span class="p">(</span><span class="n">pix_corners</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span>
        <span class="c1">#print nx,ny</span>
        <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">ny</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">primes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">lens</span><span class="o">=</span><span class="n">find_good_fft_lens</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="n">ny</span><span class="p">),</span><span class="n">primes</span><span class="p">)</span>
            <span class="c1">#print &#39;nx and ny initially are &#39;,nx,ny</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">lens</span><span class="p">[</span><span class="n">lens</span><span class="o">&gt;=</span><span class="n">nx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">lens</span><span class="p">[</span><span class="n">lens</span><span class="o">&gt;=</span><span class="n">ny</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="c1">#print &#39;small prime nx and ny are now &#39;,nx,ny</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="o">=</span><span class="n">primes</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">=</span><span class="n">npol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">=</span><span class="n">poltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="o">=</span><span class="n">pols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="n">lims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="n">purge_pixellization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="o">=</span><span class="n">pixsize</span>
        <span class="k">if</span> <span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">npol</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">=</span><span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="o">=</span><span class="n">pad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="o">=</span><span class="n">cosdec</span>
<div class="viewcode-block" id="PolMap.get_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.get_caches">[docs]</a>    <span class="k">def</span> <span class="nf">get_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span>
        <span class="n">nthread</span><span class="o">=</span><span class="n">get_nthread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nthread</span><span class="p">,</span><span class="n">npix</span><span class="p">])</span></div>
<div class="viewcode-block" id="PolMap.clear_caches"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span></div>
<div class="viewcode-block" id="PolMap.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">newmap</span><span class="o">=</span><span class="n">PolMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">primes</span><span class="p">,</span><span class="n">cosdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">mywcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            <span class="n">newmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="n">newmap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolMap.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="PolMap.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="PolMap.assign"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">)</span>
        <span class="c1">#self.map[:,:]=arr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">arr</span></div>
<div class="viewcode-block" id="PolMap.set_polstate"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.set_polstate">[docs]</a>    <span class="k">def</span> <span class="nf">set_polstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">poltag</span><span class="p">):</span>
        <span class="n">pols</span><span class="o">=</span><span class="n">poltag2pols</span><span class="p">(</span><span class="n">poltag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unrecognized polarization state &#39;</span> <span class="o">+</span> <span class="n">poltag</span> <span class="o">+</span> <span class="s1">&#39; in PolMap.set_polstate.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">npol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">=</span><span class="n">npol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">=</span><span class="n">poltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="o">=</span><span class="n">pols</span>
        <span class="k">if</span> <span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="n">npol</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span></div>
<div class="viewcode-block" id="PolMap.invert"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="c1">#We can use np.linalg.pinv to reasonably efficiently invert a bunch of tiny matrices with an</span>
        <span class="c1">#eigenvalue cut.  It&#39;s more efficient to do this in C, but it only has to be done once per run</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU_PRECON&#39;</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">thresh</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU_PRECON&#39;</span><span class="p">:</span>
                <span class="c1">#the mapping may seem a bit abstruse here.  The preconditioner matrix has entries</span>
                <span class="c1">#  [I   Q   U ]</span>
                <span class="c1">#  [Q  QQ  QU ]</span>
                <span class="c1">#  [U  QU  UU ]</span>
                <span class="c1">#so the unpacking needs to match the ordering in the C file before we can use pinv</span>
                <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
                <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span>
                <span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">tmp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
                <span class="n">alldets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">isbad</span><span class="o">=</span><span class="n">alldets</span><span class="o">&lt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">alldets</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">ispos</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>
                <span class="n">inds</span><span class="o">=</span><span class="n">isbad</span><span class="o">&amp;</span><span class="n">ispos</span>
                <span class="n">vec</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;determinant range is &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alldets</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alldets</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">thresh</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning!  zeroing out bits like this is super janky.  Be warned...&#39;</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">isbad</span><span class="p">,:,:]</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">inds</span><span class="o">=</span><span class="n">isbad</span><span class="o">&amp;</span><span class="n">ispos</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">vec</span>
                <span class="n">alldets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;determinant range is now &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alldets</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alldets</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">!=</span><span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>
<div class="viewcode-block" id="PolMap.pix_from_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.pix_from_radec">[docs]</a>    <span class="k">def</span> <span class="nf">pix_from_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nsamp</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">ndet</span><span class="o">*</span><span class="n">nsamp</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nn</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ra</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dec</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="c1">#print coords.shape</span>
        <span class="n">pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print pix.shape</span>
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#-1 is to go between unit offset in FITS and zero offset in python</span>
        <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xpix</span><span class="p">)</span>
        <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ypix</span><span class="p">)</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div>
<div class="viewcode-block" id="PolMap.get_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.get_pix">[docs]</a>    <span class="k">def</span> <span class="nf">get_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">savepix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ipix</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">ipix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ipix</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nsamp</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nn</span><span class="o">=</span><span class="n">ndet</span><span class="o">*</span><span class="n">nsamp</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nn</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="c1">#print coords.shape</span>
            <span class="n">pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print pix.shape</span>
            <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  <span class="c1">#-1 is to go between unit offset in FITS and zero offset in python</span>
            <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>  
            <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">xpix</span><span class="p">)</span>
            <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ypix</span><span class="p">)</span>
            <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_radec</span><span class="p">()</span>
            <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_from_radec</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savepix</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">save_pixellization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div>
<div class="viewcode-block" id="PolMap.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#polmap2tod(dat,self.map,self.poltag,tod.info[&#39;twogamma_saved&#39;],tod.info[&#39;ipix&#39;],do_add,do_omp)</span>
            <span class="n">polmap2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;twogamma_saved&#39;</span><span class="p">],</span><span class="n">ipix</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#map2tod(dat,self.map,tod.info[&#39;ipix&#39;],do_add,do_omp)</span>
            <span class="n">map2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">ipix</span><span class="p">,</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="PolMap.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ipix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
        <span class="c1">#print(&#39;ipix start is &#39;,ipix[0,0:500:100])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#tod2polmap(self.map,dat,self.poltag,tod.info[&#39;twogamma_saved&#39;],tod.info[&#39;ipix&#39;])</span>
            <span class="n">tod2polmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;twogamma_saved&#39;</span><span class="p">],</span><span class="n">ipix</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="p">:</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">clear_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1">#print(&quot;working on nonpolarized bit&quot;)</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#tod2map_cached(self.caches,dat,tod.info[&#39;ipix&#39;])</span>
            <span class="n">tod2map_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_omp</span><span class="p">:</span>
                <span class="c1">#tod2map_omp(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#tod2map_simple(self.map,dat,tod.info[&#39;ipix&#39;])</span>
                <span class="n">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">ipix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="p">:</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">clear_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="PolMap.r_th_maps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.r_th_maps">[docs]</a>    <span class="k">def</span> <span class="nf">r_th_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">xvec</span><span class="o">-</span><span class="n">xvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>        
        <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">yvec</span><span class="o">=</span><span class="n">yvec</span><span class="o">-</span><span class="n">yvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ymat</span><span class="p">,</span><span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yvec</span><span class="p">,</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xmat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ymat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">th</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xmat</span><span class="p">,</span><span class="n">ymat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rmat</span><span class="p">,</span><span class="n">th</span></div>
<div class="viewcode-block" id="PolMap.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div>
        
<div class="viewcode-block" id="PolMap.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;map.fits&#39;</span><span class="p">):</span>
        <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">fname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;fits&#39;</span><span class="p">:</span>
                    <span class="n">head</span><span class="o">=</span><span class="n">fname</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">tail</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">head</span><span class="o">=</span><span class="n">fname</span>
                    <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">head</span><span class="o">=</span><span class="n">fname</span>
                <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
                <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">tail</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">tail</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#try a patch to fix the wcs xxx </span>
            <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">new_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="n">new_map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">poltag</span><span class="o">+</span><span class="s1">&#39;_PRECON&#39;</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">)</span>
            <span class="n">new_map</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;QU_PRECON&#39;</span><span class="p">:</span>
                <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">new_map</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">==</span><span class="s1">&#39;IQU_PRECON&#39;</span><span class="p">:</span>
                <span class="c1">#the indices are set such that the preconditioner matrix [I Q U; Q QQ QU; U QU UU] match the C code.  </span>
                <span class="c1">#once we&#39;ve inverted, the output should be the product of that matrix times [I Q U]</span>
                <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">new_map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">new_map</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unrecognized tag in PolMap.__mul__:  &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">))</span>
            <span class="k">assert</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<div class="viewcode-block" id="PolMap.mpi_reduce"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.PolMap.html#minkasi_wrapper.extern.minkasi.minkasi.PolMap.mpi_reduce">[docs]</a>    <span class="k">def</span> <span class="nf">mpi_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chunksize</span><span class="o">=</span><span class="mf">1e5</span><span class="p">):</span>
        <span class="c1">#chunksize is added since at least on my laptop mpi4py barfs if it</span>
        <span class="c1">#tries to reduce an nside=512 healpix map, so need to break it into pieces.</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="c1">#print(&quot;reducing map&quot;)</span>
            <span class="k">if</span> <span class="n">chunksize</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">)</span><span class="o">/</span><span class="n">chunksize</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nchunk</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="mi">1</span>
            <span class="c1">#print(&#39;nchunk is &#39;,nchunk)</span>
            <span class="k">if</span> <span class="n">nchunk</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span><span class="n">nchunk</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="c1">#self.map[inds[i]:inds[i+1]]=comm.allreduce(self.map[inds[i]:inds[i+1]])</span>
                    <span class="c1">#tmp=np.zeros(inds[i+1]-inds[i])</span>
                    <span class="c1">#tmp[:]=self.map[inds[i]:inds[i+1]]</span>
                    <span class="c1">#tmp=comm.allreduce(tmp)</span>
                    <span class="c1">#self.map[inds[i]:inds[i+1]]=tmp</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div></div>
            
            <span class="c1">#print(&quot;reduced&quot;)</span>
<div class="viewcode-block" id="HealMap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealMap">[docs]</a><span class="k">class</span> <span class="nc">HealMap</span><span class="p">(</span><span class="n">SkyMap</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;RING&#39;</span><span class="p">,</span><span class="n">nside</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ipix&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">have_healpy</span><span class="p">):</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Healpix map requested, but healpy not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">=</span><span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="o">=</span><span class="n">nside</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">healpy</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span>
<div class="viewcode-block" id="HealMap.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealMap.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newmap</span><span class="o">=</span><span class="n">HealMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">newmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">newmap</span></div>
<div class="viewcode-block" id="HealMap.pix_from_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealMap.pix_from_radec">[docs]</a>    <span class="k">def</span> <span class="nf">pix_from_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">healpy</span><span class="o">.</span><span class="n">ang2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">dec</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">==</span><span class="s1">&#39;NEST&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ipix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span></div>
    <span class="c1">#def get_pix(self,tod,savepix=True):</span>
    <span class="c1">#    if not(self.tag is None):</span>
    <span class="c1">#        ipix=tod.get_saved_pix(self.tag)</span>
    <span class="c1">#        if not(ipix is None):</span>
    <span class="c1">#            return ipix</span>
    <span class="c1">#    ra,dec=tod.get_radec()</span>
    <span class="c1">#    #ipix=healpy.ang2pix(self.nside,np.pi/2-tod.info[&#39;dy&#39;],tod.info[&#39;dx&#39;],self.proj==&#39;NEST&#39;)</span>
    <span class="c1">#    ipix=healpy.ang2pix(self.nside,np.pi/2-dec,ra,self.proj==&#39;NEST&#39;)</span>
    <span class="c1">#    if savepix:</span>
    <span class="c1">#        tod.save_pixellization(self.tag,ipix)            </span>
    <span class="c1">#    return ipix</span>
<div class="viewcode-block" id="HealMap.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealMap.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;map.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">healpy</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">nest</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">==</span><span class="s1">&#39;NEST&#39;</span><span class="p">),</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>        </div></div>
    

<div class="viewcode-block" id="HealPolMap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealPolMap">[docs]</a><span class="k">class</span> <span class="nc">HealPolMap</span><span class="p">(</span><span class="n">PolMap</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">poltag</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;RING&#39;</span><span class="p">,</span><span class="n">nside</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ipix&#39;</span><span class="p">,</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">have_healpy</span><span class="p">):</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Healpix map requested, but healpy not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">pols</span><span class="o">=</span><span class="n">poltag2pols</span><span class="p">(</span><span class="n">poltag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unrecognized polarization state &#39;</span> <span class="o">+</span> <span class="n">poltag</span> <span class="o">+</span> <span class="s1">&#39; in PolMap.__init__&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">npol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">=</span><span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="o">=</span><span class="n">nside</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">healpy</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">=</span><span class="n">npol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="o">=</span><span class="n">poltag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="o">=</span><span class="n">pols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_pixellization</span><span class="o">=</span><span class="n">purge_pixellization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">])</span>
<div class="viewcode-block" id="HealPolMap.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">newmap</span><span class="o">=</span><span class="n">HealPolMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poltag</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">newmap</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="n">newmap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
    <span class="c1">#def get_pix(self,tod):</span>
    <span class="c1">#    ipix=healpy.ang2pix(self.nside,np.pi/2-tod.info[&#39;dy&#39;],tod.info[&#39;dx&#39;],self.proj==&#39;NEST&#39;)</span>
    <span class="c1">#    return ipix</span>
<div class="viewcode-block" id="HealPolMap.pix_from_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.pix_from_radec">[docs]</a>    <span class="k">def</span> <span class="nf">pix_from_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">healpy</span><span class="o">.</span><span class="n">ang2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">dec</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">==</span><span class="s1">&#39;NEST&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ipix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span></div>
    <span class="c1">#def get_pix(self,tod,savepix=True):</span>
    <span class="c1">#    if not(self.tag is None):</span>
    <span class="c1">#        ipix=tod.get_saved_pix(self.tag)</span>
    <span class="c1">#        if not(ipix is None):</span>
    <span class="c1">#            return ipix</span>
    <span class="c1">#    ra,dec=tod.get_radec()</span>
    <span class="c1">#    ipix=self.pix_from_radec(ra,dec)</span>
    <span class="c1">#    if savepix:</span>
    <span class="c1">#        if not(self.tag is None):</span>
    <span class="c1">#            tod.save_pixellization(self.tag,ipix)</span>
    <span class="c1">#    return ipix</span>

<div class="viewcode-block" id="HealPolMap.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.html#minkasi_wrapper.extern.minkasi.minkasi.HealPolMap.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;map.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">healpy</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">nest</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">==</span><span class="s1">&#39;NEST&#39;</span><span class="p">),</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>        
            <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span><span class="o">=</span><span class="n">fname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ind</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;fits&#39;</span><span class="p">:</span>
                            <span class="n">head</span><span class="o">=</span><span class="n">fname</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>
                            <span class="n">tail</span><span class="o">=</span><span class="n">fname</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">head</span><span class="o">=</span><span class="n">fname</span>
                            <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">head</span><span class="o">=</span><span class="n">fname</span>
                        <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span>
                    <span class="c1">#tmp=np.zeros([self.ny,self.nx])</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
                        <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                        <span class="c1">#print(&#39;tmp shape is &#39;,tmp.shape)</span>
                        <span class="n">fname</span><span class="o">=</span><span class="n">head</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">tail</span>
                        <span class="n">healpy</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">nest</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">==</span><span class="s1">&#39;NEST&#39;</span><span class="p">),</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div></div>
                        <span class="c1">#healpy.write_map(fname,tmp[:,0],nest=(self.proj==&#39;NEST&#39;),overwrite=overwrite)</span>
    

<div class="viewcode-block" id="Cuts"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts">[docs]</a><span class="k">class</span> <span class="nc">Cuts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1">#if class(tod)==Cuts: #for use in copy</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">Cuts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_inds</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">bad_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">namps</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">nsamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_add</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">do_add</span>
            <span class="k">return</span>
        <span class="n">bad_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bad_samples&#39;</span><span class="p">])</span>
        <span class="c1">#dims=tod.info[&#39;dat_calib&#39;].shape</span>
        <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="n">bad_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">bad_inds</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsamp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_inds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="o">=</span><span class="n">bad_inds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_add</span><span class="o">=</span><span class="n">do_add</span>
<div class="viewcode-block" id="Cuts.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="Cuts.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cuts</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">cuts</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span></div>
<div class="viewcode-block" id="Cuts.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_add</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span></div>
<div class="viewcode-block" id="Cuts.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">]</span></div>
<div class="viewcode-block" id="Cuts.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cuts</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">cuts</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div>
<div class="viewcode-block" id="Cuts.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Cuts.html#minkasi_wrapper.extern.minkasi.minkasi.Cuts.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>
<div class="viewcode-block" id="CutsCompact"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact">[docs]</a><span class="k">class</span> <span class="nc">CutsCompact</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">CutsCompact</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">ndet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">nseg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">istart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">istop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#ndet=tod.info[&#39;dat_calib&#39;].shape[0]</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">ndet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndet</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ndet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ndet</span>
            <span class="c1">#self.imax=tod.info[&#39;dat_calib&#39;].shape[1]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="kc">None</span>
        
<div class="viewcode-block" id="CutsCompact.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">copy</span><span class="o">=</span><span class="n">CutsCompact</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">copy</span><span class="o">.</span><span class="n">imap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">copy</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">imap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span>
        <span class="k">return</span> <span class="n">copy</span></div>
<div class="viewcode-block" id="CutsCompact.add_cut"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.add_cut">[docs]</a>    <span class="k">def</span> <span class="nf">add_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">det</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">istop</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">istart</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="p">:</span>
            <span class="c1">#this is asking to add a cut past the end of the data.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">istop</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="p">:</span> <span class="c1">#don&#39;t have a cut run past the end of the timestream</span>
            <span class="n">istop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">istart</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istart</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">istop</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istop</span><span class="p">)</span></div>
<div class="viewcode-block" id="CutsCompact.get_imap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.get_imap">[docs]</a>    <span class="k">def</span> <span class="nf">get_imap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ncut</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]):</span>
                <span class="n">ncut</span><span class="o">=</span><span class="n">ncut</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ncut is &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ncut</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncut</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]):</span>
                <span class="n">istart</span><span class="o">=</span><span class="n">det</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">istop</span><span class="o">=</span><span class="n">det</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">nn</span><span class="o">=</span><span class="n">istop</span><span class="o">-</span><span class="n">istart</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="p">[</span><span class="n">icur</span><span class="p">:</span><span class="n">icur</span><span class="o">+</span><span class="n">nn</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span><span class="n">istop</span><span class="p">)</span>
                <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="n">nn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="p">))</span></div>
<div class="viewcode-block" id="CutsCompact.cuts_from_array"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.cuts_from_array">[docs]</a>    <span class="k">def</span> <span class="nf">cuts_from_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cutmat</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cutmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">nseg</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">istop</span><span class="o">=</span><span class="n">segs_from_vec</span><span class="p">(</span><span class="n">cutmat</span><span class="p">[</span><span class="n">det</span><span class="p">,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">nseg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">istart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">istop</span></div>
<div class="viewcode-block" id="CutsCompact.merge_cuts"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.merge_cuts">[docs]</a>    <span class="k">def</span> <span class="nf">merge_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imax</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>  <span class="c1">#if we only have one segment, don&#39;t have to worry about strange overlaps</span>
                <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]):</span>
                    <span class="n">tmp</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">nseg</span><span class="p">,</span><span class="n">istart</span><span class="p">,</span><span class="n">istop</span><span class="o">=</span><span class="n">segs_from_vec</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nseg</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">nseg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">istart</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">=</span><span class="n">istop</span></div>
    
<div class="viewcode-block" id="CutsCompact.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#mat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="n">tod2cuts_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="p">),</span><span class="n">do_add</span><span class="p">)</span></div>

<div class="viewcode-block" id="CutsCompact.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#mat=tod.info[&#39;dat_calib&#39;]</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="c1">#print(&#39;first element is &#39; + repr(mat[0,self.imap[0]]))</span>
        <span class="n">cuts2tod_c</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imap</span><span class="p">),</span><span class="n">do_add</span><span class="p">)</span></div>
        <span class="c1">#print(&#39;first element is now &#39; + repr(mat[0,self.imap[0]]))</span>
        <span class="c1">#return mat</span>
<div class="viewcode-block" id="CutsCompact.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span></div>
<div class="viewcode-block" id="CutsCompact.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">map</span><span class="p">)</span></div>
<div class="viewcode-block" id="CutsCompact.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">map</span></div>
<div class="viewcode-block" id="CutsCompact.write"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
<div class="viewcode-block" id="CutsCompact.apply_prior"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.html#minkasi_wrapper.extern.minkasi.minkasi.CutsCompact.apply_prior">[docs]</a>    <span class="k">def</span> <span class="nf">apply_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Ax</span><span class="p">):</span>
        <span class="n">Ax</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">Ax</span><span class="o">.</span><span class="n">map</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">map</span></div>
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_mul</span><span class="p">):</span>
        <span class="n">tt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">*</span><span class="n">to_mul</span><span class="o">.</span><span class="n">map</span>
        <span class="k">return</span> <span class="n">tt</span></div>

<span class="c1">#this class is pointless, as you can get the same functionality with the tsModel class, which will be </span>
<span class="c1">#consistent with other timestream model classes.  </span>
<span class="c1">#class CutsVecs:</span>
<span class="c1">#    def __init__(self,todvec,do_add=True):</span>
<span class="c1">#        #if class(todvec)==CutsVecs: #for use in copy</span>
<span class="c1">#        if isinstance(todvec,CutsVecs):</span>
<span class="c1">#            self.cuts=[None]*todvec.ntod</span>
<span class="c1">#            self.ntod=todvec.ntod</span>
<span class="c1">#            for i in range(todvec.ntod):</span>
<span class="c1">#                self.cuts[i]=todvec.cuts[i].copy()</span>
<span class="c1">#            return</span>
<span class="c1">#        #if class(todvec)!=TodVec:</span>
<span class="c1">#        if not(isinstance(todvec,TodVec)):</span>
<span class="c1">#            print(&#39;error in CutsVecs init, must pass in a todvec class.&#39;)</span>
<span class="c1">#            return None</span>
<span class="c1">#        self.cuts=[None]*todvec.ntod</span>
<span class="c1">#        self.ntod=todvec.ntod</span>
<span class="c1">#        for i in range(todvec.ntod):</span>
<span class="c1">#            tod=todvec.tods[i]</span>
<span class="c1">#            if tod.info[&#39;tag&#39;]!=i:</span>
<span class="c1">#                print(&#39;warning, tag mismatch in CutsVecs.__init__&#39;)</span>
<span class="c1">#                print(&#39;continuing, but you should be careful...&#39;)            </span>
<span class="c1">#            if &#39;bad_samples&#39; in tod.info:</span>
<span class="c1">#                self.cuts[i]=Cuts(tod,do_add)</span>
<span class="c1">#            elif &#39;mask&#39; in tod.info:</span>
<span class="c1">#                self.cuts[i]=CutsCompact(tod)</span>
<span class="c1">#                self.cuts[i].cuts_from_array(tod.info[&#39;mask&#39;])</span>
<span class="c1">#                self.cuts[i].get_imap()</span>
<span class="c1">#    def copy(self):</span>
<span class="c1">#        return CutsVecs(self)</span>
<span class="c1">#    def clear(self):</span>
<span class="c1">#        for cuts in self.cuts:</span>
<span class="c1">#            cuts.clear()</span>
<span class="c1">#    def axpy(self,cutsvec,a):</span>
<span class="c1">#        assert(self.ntod==cutsvec.ntod)</span>
<span class="c1">#        for i in range(ntod):</span>
<span class="c1">#            self.cuts[i].axpy(cutsvec.cuts[i],a)</span>
<span class="c1">#    def map2tod(self,todvec):</span>
<span class="c1">#        assert(self.ntod==todvec.ntod)</span>
<span class="c1">#        for i in range(self.ntod):</span>
<span class="c1">#            self.cuts[i].map2tod(todvec.tods[i])</span>
<span class="c1">#    def tod2map(self,todvec,dat):</span>
<span class="c1">#        assert(self.ntod==todvec.ntod)</span>
<span class="c1">#        assert(self.ntod==dat.ntod)</span>
<span class="c1">#        for i in range(self.ntod):</span>
<span class="c1">#            self.cuts[i].tod2map(todvec.tods[i],dat.tods[i])</span>
<span class="c1">#    def dot(self,cutsvec):</span>
<span class="c1">#        tot=0.0</span>
<span class="c1">#        assert(self.ntod==cutsvec.ntod)</span>
<span class="c1">#        for i in range(self.ntod):</span>
<span class="c1">#            tot+=self.cuts[i].dot(cutsvec.cuts[i])</span>
<span class="c1">#        return tot</span>
        
                                 
            
<div class="viewcode-block" id="SkyMapCar"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCar.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCar">[docs]</a><span class="k">class</span> <span class="nc">SkyMapCar</span><span class="p">(</span><span class="n">SkyMap</span><span class="p">):</span>
<div class="viewcode-block" id="SkyMapCar.pix_from_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCar.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCar.pix_from_radec">[docs]</a>    <span class="k">def</span> <span class="nf">pix_from_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">):</span>
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">ra</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">)</span>
        <span class="c1">#ypix=np.round((dec-self.lims[2])/self.pixsize)</span>
        <span class="n">ypix</span><span class="o">=</span><span class="p">((</span><span class="n">dec</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div></div>
        
<div class="viewcode-block" id="SkyMapCarOld"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld">[docs]</a><span class="k">class</span> <span class="nc">SkyMapCarOld</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="n">lims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="o">=</span><span class="n">lims</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="o">=</span><span class="n">pixsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">pixsize</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="p">))</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">pixsize</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">=</span><span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npix</span><span class="o">=</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
<div class="viewcode-block" id="SkyMapCarOld.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mycopy</span><span class="o">=</span><span class="n">SkyMapCar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">)</span>
        <span class="n">mycopy</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">mycopy</span></div>
<div class="viewcode-block" id="SkyMapCarOld.clear"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:]</span><span class="o">=</span><span class="mi">0</span></div>

<div class="viewcode-block" id="SkyMapCarOld.axpy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.axpy">[docs]</a>    <span class="k">def</span> <span class="nf">axpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">[:]</span></div>
        
<div class="viewcode-block" id="SkyMapCarOld.assign"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">arr</span></div>
<div class="viewcode-block" id="SkyMapCarOld.get_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.get_pix">[docs]</a>    <span class="k">def</span> <span class="nf">get_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">):</span>
        <span class="n">xpix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cosdec</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">)</span>
        <span class="n">ypix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">)</span>
        <span class="c1">#ipix=np.asarray(ypix*self.nx+xpix,dtype=&#39;int32&#39;)</span>
        <span class="n">ipix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xpix</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">+</span><span class="n">ypix</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipix</span></div>
<div class="viewcode-block" id="SkyMapCarOld.map2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.map2tod">[docs]</a>    <span class="k">def</span> <span class="nf">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">map2tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ipix&#39;</span><span class="p">],</span><span class="n">do_add</span><span class="p">,</span><span class="n">do_omp</span><span class="p">)</span></div>

<div class="viewcode-block" id="SkyMapCarOld.tod2map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.tod2map">[docs]</a>    <span class="k">def</span> <span class="nf">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">do_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_omp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_omp</span><span class="p">:</span>
            <span class="n">tod2map_omp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ipix&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tod2map_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ipix&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="SkyMapCarOld.r_th_maps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.r_th_maps">[docs]</a>    <span class="k">def</span> <span class="nf">r_th_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">xvec</span><span class="o">=</span><span class="n">xvec</span><span class="o">-</span><span class="n">xvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>        
        <span class="n">yvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">yvec</span><span class="o">=</span><span class="n">yvec</span><span class="o">-</span><span class="n">yvec</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ymat</span><span class="p">,</span><span class="n">xmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">yvec</span><span class="p">,</span><span class="n">xvec</span><span class="p">)</span>
        <span class="n">rmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xmat</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ymat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">th</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xmat</span><span class="p">,</span><span class="n">ymat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rmat</span><span class="p">,</span><span class="n">th</span></div>
<div class="viewcode-block" id="SkyMapCarOld.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.html#minkasi_wrapper.extern.minkasi.minkasi.SkyMapCarOld.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">*</span><span class="nb">map</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div></div>
<div class="viewcode-block" id="find_bad_skew_kurt"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.find_bad_skew_kurt.html#minkasi_wrapper.extern.minkasi.minkasi.find_bad_skew_kurt">[docs]</a><span class="k">def</span> <span class="nf">find_bad_skew_kurt</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">skew_thresh</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span><span class="n">kurt_thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">isgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndet</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dat</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mystd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">=</span><span class="n">skew</span><span class="o">/</span><span class="n">mystd</span><span class="o">**</span><span class="mf">1.5</span>
    <span class="n">mykurt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dat</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kurt</span><span class="o">=</span><span class="n">mykurt</span><span class="o">/</span><span class="n">mystd</span><span class="o">**</span><span class="mi">4</span><span class="o">-</span><span class="mi">3</span>
    
    <span class="n">isgood</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">skew</span><span class="p">)</span><span class="o">&gt;</span><span class="n">skew_thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">skew</span><span class="p">))]</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">isgood</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kurt</span><span class="p">)</span><span class="o">&gt;</span><span class="n">kurt_thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kurt</span><span class="p">))]</span><span class="o">=</span><span class="kc">False</span>
    


    <span class="k">return</span> <span class="n">skew</span><span class="p">,</span><span class="n">kurt</span><span class="p">,</span><span class="n">isgood</span></div>

<div class="viewcode-block" id="timestreams_from_gauss"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_gauss.html#minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_gauss">[docs]</a><span class="k">def</span> <span class="nf">timestreams_from_gauss</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">fwhm</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#pred=np.zeros(tod.info[&#39;dat_calib&#39;].shape)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#n=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">())</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n</span><span class="p">)</span>
    <span class="n">npar_src</span><span class="o">=</span><span class="mi">4</span> <span class="c1">#x,y,sig,amp</span>
    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">pp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npar_src</span><span class="p">)</span>
    <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ra</span>
    <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dec</span>
    <span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">fwhm</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">/</span><span class="mi">3600</span> 
    <span class="n">pp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">fill_gauss_src_c</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">pred</span></div>

<div class="viewcode-block" id="timestreams_from_isobeta_c"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_isobeta_c.html#minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_isobeta_c">[docs]</a><span class="k">def</span> <span class="nf">timestreams_from_isobeta_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#pred=np.zeros(tod.info[&#39;dat_calib&#39;].shape)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#n=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">())</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n</span><span class="p">)</span>
    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">fill_isobeta_c</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="n">npar_beta</span><span class="o">=</span><span class="mi">5</span> <span class="c1">#x,y,theta,beta,amp</span>
    <span class="n">npar_src</span><span class="o">=</span><span class="mi">4</span> <span class="c1">#x,y,sig,amp</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">npar_beta</span><span class="p">)</span><span class="o">//</span><span class="n">npar_src</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">pp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npar_src</span><span class="p">)</span>
        <span class="n">ioff</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span>
        <span class="n">pp</span><span class="p">[:]</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">ioff</span><span class="p">:(</span><span class="n">ioff</span><span class="o">+</span><span class="n">npar_src</span><span class="p">)]</span>
        <span class="n">fill_gauss_src_c</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">pred</span></div>

<div class="viewcode-block" id="derivs_from_elliptical_isobeta"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.derivs_from_elliptical_isobeta.html#minkasi_wrapper.extern.minkasi.minkasi.derivs_from_elliptical_isobeta">[docs]</a><span class="k">def</span> <span class="nf">derivs_from_elliptical_isobeta</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">npar</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">npar</span><span class="o">==</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">fill_elliptical_isobeta_derivs</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">pred</span><span class="p">,</span><span class="n">derivs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span></div>

<div class="viewcode-block" id="derivs_from_elliptical_gauss"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.derivs_from_elliptical_gauss.html#minkasi_wrapper.extern.minkasi.minkasi.derivs_from_elliptical_gauss">[docs]</a><span class="k">def</span> <span class="nf">derivs_from_elliptical_gauss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">npar</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">npar</span><span class="o">==</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">fill_elliptical_gauss_derivs</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">pred</span><span class="p">,</span><span class="n">derivs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span></div>


<div class="viewcode-block" id="derivs_from_isobeta_c"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.derivs_from_isobeta_c.html#minkasi_wrapper.extern.minkasi.minkasi.derivs_from_isobeta_c">[docs]</a><span class="k">def</span> <span class="nf">derivs_from_isobeta_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">npar</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
    <span class="c1">#n=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">dims</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
    <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
    <span class="c1">#sz_deriv=np.append(npar,tod.info[&#39;dat_calib&#39;].shape)</span>
    <span class="n">sz_deriv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">npar</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
    <span class="c1">#pred=np.zeros(tod.info[&#39;dat_calib&#39;].shape)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz_deriv</span><span class="p">)</span>

    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">fill_isobeta_derivs_c</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">derivs</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span></div>

<div class="viewcode-block" id="derivs_from_gauss_c"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.derivs_from_gauss_c.html#minkasi_wrapper.extern.minkasi.minkasi.derivs_from_gauss_c">[docs]</a><span class="k">def</span> <span class="nf">derivs_from_gauss_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">npar</span><span class="o">=</span><span class="mi">4</span>
    <span class="c1">#n=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">n</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_nsamp</span><span class="p">()</span>
    <span class="c1">#sz_deriv=np.append(npar,tod.info[&#39;dat_calib&#39;].shape)</span>
    <span class="n">sz_deriv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">npar</span><span class="p">,</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">())</span>
    
    <span class="c1">#pred=np.zeros(tod.info[&#39;dat_calib&#39;].shape)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz_deriv</span><span class="p">)</span>

    <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span>
    <span class="n">fill_gauss_derivs_c</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dx</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">dy</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">derivs</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span></div>

<div class="viewcode-block" id="derivs_from_map"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.derivs_from_map.html#minkasi_wrapper.extern.minkasi.minkasi.derivs_from_map">[docs]</a><span class="k">def</span> <span class="nf">derivs_from_map</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">fun</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">dpar</span><span class="p">,</span><span class="n">do_symm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">#print(&#39;do_symm is &#39;,do_symm)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
    <span class="n">fun</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nb">map</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">pred</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">npar</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_symm</span><span class="p">:</span>
        <span class="n">tmp2</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">()</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
        <span class="n">pp</span><span class="o">=</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">dpar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fun</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">pp</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span> <span class="c1">#strictly speaking, we shouldn&#39;t need this, but it makes us more robust to bugs elsewhere</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_symm</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">=</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">dpar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fun</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span><span class="n">pp</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">tmp2</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
            <span class="nb">map</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp2</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="n">tmp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dpar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dpar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1">#pred=np.reshape(pred,pred.size)</span>
    <span class="c1">#derivs=np.reshape(derivs,[derivs.shape[0],derivs.shape[1]*derivs.shape[2]])</span>
    <span class="k">return</span> <span class="n">pred</span><span class="p">,</span><span class="n">derivs</span></div>

<div class="viewcode-block" id="timestreams_from_isobeta"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_isobeta.html#minkasi_wrapper.extern.minkasi.minkasi.timestreams_from_isobeta">[docs]</a><span class="k">def</span> <span class="nf">timestreams_from_isobeta</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">):</span>
    <span class="n">npar_beta</span><span class="o">=</span><span class="mi">5</span> <span class="c1">#x,y,theta,beta,amp</span>
    <span class="n">npar_src</span><span class="o">=</span><span class="mi">4</span> <span class="c1">#x,y,sig,amp</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">npar_beta</span><span class="p">)</span><span class="o">//</span><span class="n">npar_src</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">nsrc</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="p">)</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">amp</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">cosdec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>


    <span class="n">dx</span><span class="o">=</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">cosdec</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">y0</span>
    <span class="n">rsqr</span><span class="o">=</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span>
    <span class="n">rsqr</span><span class="o">=</span><span class="n">rsqr</span><span class="o">/</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1">#print rsqr.max()</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">amp</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rsqr</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">src_x</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">src_y</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">src_sig</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">src_amp</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">src_x</span>
        <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">src_y</span>
        <span class="n">rsqr</span><span class="o">=</span><span class="p">(</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">src_y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">src_amp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rsqr</span><span class="o">/</span><span class="n">src_sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pred</span></div>

    

<div class="viewcode-block" id="isobeta_src_chisq"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.isobeta_src_chisq.html#minkasi_wrapper.extern.minkasi.minkasi.isobeta_src_chisq">[docs]</a><span class="k">def</span> <span class="nf">isobeta_src_chisq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tods</span><span class="p">):</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">tods</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">timestreams_from_isobeta_c</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
        <span class="c1">#chisq=chisq+tod.timestream_chisq(tod.info[&#39;dat_calib&#39;]-pred)</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">tod</span><span class="o">.</span><span class="n">timestream_chisq</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">chisq</span>
    <span class="n">npar_beta</span><span class="o">=</span><span class="mi">5</span> <span class="c1">#x,y,theta,beta,amp</span>
    <span class="n">npar_src</span><span class="o">=</span><span class="mi">4</span> <span class="c1">#x,y,sig,amp</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">npar_beta</span><span class="p">)</span><span class="o">//</span><span class="n">npar_src</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">nsrc</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="p">)</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">amp</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">cosdec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">tods</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span>
        <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">y0</span>
        <span class="n">rsqr</span><span class="o">=</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">cosdec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">amp</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rsqr</span><span class="o">/</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
            <span class="n">src_x</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">src_y</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">src_sig</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">src_amp</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npar_src</span><span class="o">+</span><span class="n">npar_beta</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">dx</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">src_x</span>
            <span class="n">dy</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">src_y</span>
            <span class="n">rsqr</span><span class="o">=</span><span class="p">(</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">src_y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">src_amp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rsqr</span><span class="o">/</span><span class="n">src_sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#chisq=chisq+tod.timestream_chisq(tod.info[&#39;dat_calib&#39;]-pred)</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">tod</span><span class="o">.</span><span class="n">timestream_chisq</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span></div>



<div class="viewcode-block" id="NoiseBinnedDet"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedDet.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedDet">[docs]</a><span class="k">class</span> <span class="nc">NoiseBinnedDet</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nn</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dnu</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">freqs</span><span class="o">/</span><span class="n">dnu</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="n">bins</span><span class="o">&lt;</span><span class="n">ndata</span><span class="p">]</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">bins</span><span class="p">,</span><span class="n">ndata</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">bins</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
        <span class="n">nbin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span>
        <span class="n">det_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nbin</span><span class="p">])</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
            <span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">datft</span><span class="p">[:,</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="o">=</span><span class="n">det_ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndata</span><span class="o">=</span><span class="n">ndata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">ndet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">=</span><span class="n">nn</span>
<div class="viewcode-block" id="NoiseBinnedDet.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedDet.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedDet.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">):</span>
            <span class="c1">#datft[:,self.bins[i]:self.bins[i+1]]=datft[:,self.bins[i]:self.bins[i+1]]*np.outer(self.det_ps[:,i],self.bins[i+1]-self.bins[i])</span>
            <span class="n">datft</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">datft</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>
        <span class="n">dd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dd</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dd</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dd</span></div></div>

<div class="viewcode-block" id="NoiseWhite"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseWhite.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseWhite">[docs]</a><span class="k">class</span> <span class="nc">NoiseWhite</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="c1">#this is the ratio between the median absolute</span>
        <span class="c1">#deviation of the diff and sigma</span>
        <span class="n">fac</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">sigs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">fac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="o">=</span><span class="n">sigs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sigs</span><span class="o">**</span><span class="mi">2</span>
<div class="viewcode-block" id="NoiseWhite.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseWhite.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseWhite.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dat</span></div></div>
<div class="viewcode-block" id="NoiseWhiteNotch"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseWhiteNotch.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseWhiteNotch">[docs]</a><span class="k">class</span> <span class="nc">NoiseWhiteNotch</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">numin</span><span class="p">,</span><span class="n">numax</span><span class="p">,</span><span class="n">tod</span><span class="p">):</span>
        <span class="n">fac</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">sigs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">fac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigs</span><span class="o">=</span><span class="n">sigs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sigs</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#fold in fft normalization to the weights</span>
        <span class="n">tvec</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_tvec</span><span class="p">()</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>
        <span class="n">tlen</span><span class="o">=</span><span class="n">tvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dnu</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tlen</span><span class="o">-</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">numin</span><span class="o">/</span><span class="n">dnu</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numax</span><span class="o">/</span><span class="n">dnu</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

<div class="viewcode-block" id="NoiseWhiteNotch.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseWhiteNotch.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseWhiteNotch.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">datft</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">istart</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">istop</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>

        <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dat</span></div></div>
        
<div class="viewcode-block" id="NoiseBinnedEig"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedEig.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedEig">[docs]</a><span class="k">class</span> <span class="nc">NoiseBinnedEig</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>

        <span class="n">ndet</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nn</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mycov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">mycov</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mycov</span><span class="o">+</span><span class="n">mycov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ee</span><span class="p">,</span><span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">mycov</span><span class="p">)</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ee</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
        <span class="n">vecs</span><span class="o">=</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">resid</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mask</span><span class="p">],</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">dnu</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">nn</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dnu is &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dnu</span><span class="p">))</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">freqs</span><span class="o">/</span><span class="n">dnu</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="n">bins</span><span class="o">&lt;</span><span class="n">ndata</span><span class="p">]</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">bins</span><span class="p">,</span><span class="n">ndata</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">bins</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
        <span class="n">nbin</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span>

        <span class="n">nmode</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">det_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nbin</span><span class="p">])</span>
        <span class="n">mode_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nmode</span><span class="p">,</span><span class="n">nbin</span><span class="p">])</span>
        <span class="n">residft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
        <span class="n">modeft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
            <span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residft</span><span class="p">[:,</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mode_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">modeft</span><span class="p">[:,</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">=</span><span class="n">vecs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">det_ps</span><span class="p">))):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warning - have non-finite numbers in noise model.  This should not be unexpected.&quot;</span><span class="p">)</span>
            <span class="n">det_ps</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">det_ps</span><span class="p">)]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="o">=</span><span class="n">det_ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_ps</span><span class="o">=</span><span class="n">mode_ps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndata</span><span class="o">=</span><span class="n">ndata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="n">ndet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn</span><span class="o">=</span><span class="n">nn</span>
<div class="viewcode-block" id="NoiseBinnedEig.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedEig.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseBinnedEig.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ndata</span><span class="p">)</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbin</span><span class="p">):</span>
            <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#print(&#39;bins are &#39;,self.bins[i],self.bins[i+1],n,datft.shape[1])</span>
            <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">mat</span><span class="o">=</span><span class="n">mat</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">mat_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">Ax</span><span class="o">=</span><span class="n">datft</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Ax</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat_inv</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">Ax</span><span class="o">-</span><span class="n">tmp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">det_ps</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">datft</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">tmp</span>
            <span class="c1">#print(tmp.shape,mat.shape)</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>
        <span class="n">dd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dd</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dd</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dd</span></div></div>
<div class="viewcode-block" id="NoiseCMWhite"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite">[docs]</a><span class="k">class</span> <span class="nc">NoiseCMWhite</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting up noise cm white&#39;</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[:]</span><span class="o">=</span><span class="n">u</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">,:])</span>
        <span class="n">dat_clean</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">pred</span>
        <span class="n">myvar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dat_clean</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">myvar</span>
<div class="viewcode-block" id="NoiseCMWhite.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">dd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">))</span>
        <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">rhs</span><span class="o">/</span><span class="n">lhs</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">have_numba</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">cm</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>
            <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1">#dd[:]=dd[:]+dat</span>
            <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">axpy_in_place</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
            <span class="n">minkasi_nb</span><span class="o">.</span><span class="n">scale_matrix_by_vector</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dd</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">cm</span><span class="p">)</span>
            <span class="c1">#print(dd[:4,:4])</span>
            <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="o">*</span><span class="n">tmp</span>
        <span class="n">t4</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#print(t2-t1,t3-t2,t4-t3)</span>
        <span class="k">return</span> <span class="n">dd</span></div>
<div class="viewcode-block" id="NoiseCMWhite.get_det_weights"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseCMWhite.get_det_weights">[docs]</a>    <span class="k">def</span> <span class="nf">get_det_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="NoiseSmoothedSVD"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD">[docs]</a><span class="k">class</span> <span class="nc">NoiseSmoothedSVD</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat_use</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">prewhiten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fit_powlaw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">u_in</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prewhiten</span><span class="p">:</span>
            <span class="n">noisevec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dat_use</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="n">dat_use</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">noisevec</span><span class="p">],</span><span class="n">dat_use</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">u_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">dat_use</span><span class="p">,</span><span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span><span class="o">=</span><span class="n">u_in</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ndet</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#print(u.shape,s.shape,v.shape)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got svd&#39;</span><span class="p">)</span>

        <span class="n">n</span><span class="o">=</span><span class="n">dat_use</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndet</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[:]</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">u_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">dat_use</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit_powlaw</span><span class="p">:</span>
            <span class="n">spec_smooth</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">dat_rot</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
                <span class="n">fitp</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">fit_ts_ps</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]);</span>
                <span class="n">spec_smooth</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat_trans</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">)</span>
            <span class="n">spec_smooth</span><span class="o">=</span><span class="n">smooth_many_vecs</span><span class="p">(</span><span class="n">dat_trans</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">prewhiten</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span><span class="o">=</span><span class="n">noisevec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="o">=</span><span class="n">spec_smooth</span>
<div class="viewcode-block" id="NoiseSmoothedSVD.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">noisemat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">datft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">datft</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">[:,:</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>
        <span class="c1">#dat=np.dot(self.v.T,dat_rot)</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vT</span><span class="p">,</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#noisemat=np.repeat([self.noisevec],dat.shape[1],axis=0).transpose()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>        
        <span class="k">return</span> <span class="n">dat</span></div>

<div class="viewcode-block" id="NoiseSmoothedSVD.apply_noise_wscratch"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.apply_noise_wscratch">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise_wscratch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">tmp2</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">noisemat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">tmp</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">tmp2</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">dat</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">,</span><span class="n">datft</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">datft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">datft</span><span class="p">[:]</span><span class="o">=</span><span class="n">datft</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">[:,:</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">tmp</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">,</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="c1">#dat=np.dot(self.v.T,dat_rot)</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vT</span><span class="p">,</span><span class="n">dat_rot</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noisevec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1">#noisemat=np.repeat([self.noisevec],dat.shape[1],axis=0).transpose()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>        
        <span class="k">return</span> <span class="n">dat</span></div>

<div class="viewcode-block" id="NoiseSmoothedSVD.get_det_weights"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.html#minkasi_wrapper.extern.minkasi.minkasi.NoiseSmoothedSVD.get_det_weights">[docs]</a>    <span class="k">def</span> <span class="nf">get_det_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the per-detector weights for use in making actual noise maps.&quot;&quot;&quot;</span>
        <span class="n">mode_wt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mywt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#tmp=np.dot(self.v.T,np.dot(np.diag(mode_wt),self.v))</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vT</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mode_wt</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="mf">2.0</span></div></div>

<div class="viewcode-block" id="Tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod">[docs]</a><span class="k">class</span> <span class="nc">Tod</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jumps</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuts</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_delayed</span><span class="o">=</span><span class="kc">False</span>
<div class="viewcode-block" id="Tod.lims"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.lims">[docs]</a>    <span class="k">def</span> <span class="nf">lims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ymin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ymax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span></div>
<div class="viewcode-block" id="Tod.set_apix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_apix">[docs]</a>    <span class="k">def</span> <span class="nf">set_apix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;calculates dxel normalized to +-1 from elevation&#39;&#39;&#39;</span>
        <span class="c1">#TBD pass in and calculate scan center&#39;s elevation vs time</span>
        <span class="n">elev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">elev</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">elev</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">elev</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ndet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">track_elev</span><span class="p">,</span><span class="n">xel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndet</span><span class="p">))</span>
        <span class="n">delev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">track_elev</span>
        <span class="n">ml</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delev</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;apix&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">delev</span><span class="o">/</span><span class="n">ml</span></div>
<div class="viewcode-block" id="Tod.get_ndet"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_ndet">[docs]</a>    <span class="k">def</span> <span class="nf">get_ndet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
<div class="viewcode-block" id="Tod.get_ndata"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_ndata">[docs]</a>    <span class="k">def</span> <span class="nf">get_ndata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>
<div class="viewcode-block" id="Tod.get_nsamp"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_nsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_nsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#get total number of timestream samples, not samples per detector</span>
        <span class="c1">#return np.product(self.info[&#39;dat_calib&#39;].shape)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">()</span></div>

<div class="viewcode-block" id="Tod.get_saved_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_saved_pix">[docs]</a>    <span class="k">def</span> <span class="nf">get_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Tod.clear_saved_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.clear_saved_pix">[docs]</a>    <span class="k">def</span> <span class="nf">clear_saved_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span></div>
<div class="viewcode-block" id="Tod.save_pixellization"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.save_pixellization">[docs]</a>    <span class="k">def</span> <span class="nf">save_pixellization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">ipix</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning - overwriting key &#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s1">&#39; in tod.save_pixellization.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">=</span><span class="n">ipix</span></div>
    

<div class="viewcode-block" id="Tod.get_data_dims"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_data_dims">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">())</span></div>
        <span class="c1">#dims=self.info[&#39;dat_calib&#39;].shape</span>
        <span class="c1">#if len(dims)==1:</span>
        <span class="c1">#    dims=np.asarray([1,dims[0]],dtype=&#39;int&#39;)</span>
        <span class="c1">#return dims</span>
        <span class="c1">#return self.info[&#39;dat_calib&#39;].shape</span>

<div class="viewcode-block" id="Tod.get_data"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span></div>
<div class="viewcode-block" id="Tod.get_tvec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_tvec">[docs]</a>    <span class="k">def</span> <span class="nf">get_tvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ctime&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Tod.get_radec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_radec">[docs]</a>    <span class="k">def</span> <span class="nf">get_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span></div>
<div class="viewcode-block" id="Tod.get_empty"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_empty">[docs]</a>    <span class="k">def</span> <span class="nf">get_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;dtype&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;dat_calib&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">else</span><span class="p">:</span>            
            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="c1">#return np.zeros(self.info[&#39;dat_calib&#39;].shape,dtype=self.info[&#39;dat_calib&#39;].dtype)            </span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">()],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#return np.empty(self.info[&#39;dat_calib&#39;].shape,dtype=self.info[&#39;dat_calib&#39;].dtype)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">()],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>
<div class="viewcode-block" id="Tod.set_tag"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_tag">[docs]</a>    <span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tag</span></div>
<div class="viewcode-block" id="Tod.set_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_pix">[docs]</a>    <span class="k">def</span> <span class="nf">set_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="n">ipix</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">get_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1">#self.info[&#39;ipix&#39;]=ipix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span><span class="o">=</span><span class="n">ipix</span></div>
<div class="viewcode-block" id="Tod.copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">copy_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">copy_info</span><span class="p">:</span>
            <span class="n">myinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">myinfo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">myinfo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">tod</span><span class="o">=</span><span class="n">Tod</span><span class="p">(</span><span class="n">myinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tod</span><span class="o">=</span><span class="n">Tod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jumps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">jumps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jumps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">jumps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jumps</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">cuts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">tod</span><span class="o">.</span><span class="n">cuts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span><span class="p">[:]</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">cuts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span><span class="p">[:]</span>
        <span class="n">tod</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span>
            
        <span class="k">return</span> <span class="n">tod</span></div>
<div class="viewcode-block" id="Tod.set_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_noise">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">modelclass</span><span class="o">=</span><span class="n">NoiseSmoothedSVD</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">delayed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delayed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_args</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_kwargs</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_delayed</span><span class="o">=</span><span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_modelclass</span><span class="o">=</span><span class="n">modelclass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_delayed</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="n">modelclass</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="Tod.get_det_weights"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.get_det_weights">[docs]</a>    <span class="k">def</span> <span class="nf">get_det_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;noise model not set in get_det_weights.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">get_det_weights</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;noise model does not support detector weights in get_det_weights.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
<div class="viewcode-block" id="Tod.set_noise_white_masked"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_noise_white_masked">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise_white_masked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;white_masked&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>
<div class="viewcode-block" id="Tod.apply_noise_white_masked"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.apply_noise_white_masked">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise_white_masked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>
        <span class="n">dd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]],</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dd</span></div>
<div class="viewcode-block" id="Tod.set_noise_cm_white"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_noise_cm_white">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise_cm_white</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deprecated usage - please switch to tod.set_noise(minkasi.NoiseCMWhite)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="n">NoiseCMWhite</span><span class="p">)</span>
        <span class="k">return</span>

        <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ndet</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>
        <span class="c1">#mode[:]=u[:,0]  #bug fixes pointed out by Fernando Zago.  19 Nov 2019</span>
        <span class="c1">#pred=np.outer(mode,v[0,:])</span>
        <span class="n">mode</span><span class="p">[:]</span><span class="o">=</span><span class="n">u</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">mode</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">,:])</span>

        <span class="n">dat_clean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">pred</span>
        <span class="n">myvar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dat_clean</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">myvar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;cm_white&#39;</span></div>
        
<div class="viewcode-block" id="Tod.apply_noise_cm_white"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.apply_noise_cm_white">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise_cm_white</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I&#39;m not sure how you got here (tod.apply_noise_cm_white), but you should not have been able to.  Please complain to someone.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>

        <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]))</span>
        <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">mat</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="c1">#if len(lhs)&gt;1:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">rhs</span><span class="o">/</span><span class="n">lhs</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">cm</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]],</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="o">*</span><span class="n">tmp</span>
        <span class="k">return</span> <span class="n">dd</span></div>
<div class="viewcode-block" id="Tod.set_noise_binned_eig"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_noise_binned_eig">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise_binned_eig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>
        <span class="n">mycov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">mycov</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">mycov</span><span class="o">+</span><span class="n">mycov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">ee</span><span class="p">,</span><span class="n">vv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">mycov</span><span class="p">)</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ee</span><span class="o">&gt;</span><span class="n">thresh</span><span class="o">*</span><span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span>
        <span class="n">vecs</span><span class="o">=</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">resid</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vv</span><span class="p">[:,</span><span class="n">mask</span><span class="p">],</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">resid</span></div>
<div class="viewcode-block" id="Tod.set_noise_smoothed_svd"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_noise_smoothed_svd">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise_smoothed_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prewhiten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fit_powlaw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;If func comes in as not empty, assume we can call func(pars,tod) to get a predicted model for the tod that</span>
<span class="sd">        we subtract off before estimating the noise.&#39;&#39;&#39;</span>

        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deprecated usage - please switch to tod.set_noise(minkasi.NoiseSmoothedSVD)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="n">NoiseSmoothedSVD</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">dat_use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_noise</span><span class="p">(</span><span class="n">NoiseSmoothedSVD</span><span class="p">,</span><span class="n">dat_use</span><span class="p">)</span>
        <span class="k">return</span>


        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">dat_use</span>
            <span class="c1">#u,s,v=numpy.linalg.svd(self.info[&#39;dat_calib&#39;]-tmp,0)</span>
        <span class="k">if</span> <span class="n">prewhiten</span><span class="p">:</span>
            <span class="n">noisevec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dat_use</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dat_use</span><span class="o">=</span><span class="n">dat_use</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">noisevec</span><span class="p">],</span><span class="n">dat_use</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">dat_use</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got svd&#39;</span><span class="p">)</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">size</span>
        <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndet</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fit_powlaw</span><span class="p">:</span>
            <span class="n">spec_smooth</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">dat_rot</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndet</span><span class="p">):</span>
                <span class="n">fitp</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">fit_ts_ps</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]);</span>
                <span class="n">spec_smooth</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat_trans</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">)</span>
            <span class="n">spec_smooth</span><span class="o">=</span><span class="n">smooth_many_vecs</span><span class="p">(</span><span class="n">dat_trans</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">spec_smooth</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">prewhiten</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noisevec&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">noisevec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">spec_smooth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;smoothed_svd&#39;</span></div>
        <span class="c1">#return dat_rot</span>
        
<div class="viewcode-block" id="Tod.apply_noise"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.apply_noise">[docs]</a>    <span class="k">def</span> <span class="nf">apply_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#dat=self.info[&#39;dat_calib&#39;]</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#the .copy() is here so you don&#39;t</span>
                                       <span class="c1">#overwrite data stored in the TOD.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_delayed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_modelclass</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_args</span><span class="p">),</span> <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_kwargs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_delayed</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unable to use class-based noised, falling back onto hardwired.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;cm_white&#39;</span><span class="p">:</span>
            <span class="c1">#print &#39;calling cm_white&#39;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_noise_cm_white</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;white_masked&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_noise_white_masked</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="c1">#if self.info.has_key(&#39;noisevec&#39;):</span>
        <span class="k">if</span> <span class="s1">&#39;noisevec&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
            <span class="n">noisemat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;noisevec&#39;</span><span class="p">]],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span><span class="n">dat</span><span class="p">)</span>

        <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">datft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">datft</span><span class="o">=</span><span class="n">datft</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mywt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">dat_rot</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>
        <span class="n">dat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">dat_rot</span><span class="p">)</span>
        <span class="c1">#if self.info.has_key(&#39;noisevec&#39;):</span>
        <span class="k">if</span> <span class="s1">&#39;noisevec&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="n">dat</span><span class="o">/</span><span class="n">noisemat</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dat</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dat</span></div>
<div class="viewcode-block" id="Tod.mapset2tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.mapset2tod">[docs]</a>    <span class="k">def</span> <span class="nf">mapset2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#dat=0*self.info[&#39;dat_calib&#39;]</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span>
            <span class="nb">map</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dat</span></div>
<div class="viewcode-block" id="Tod.tod2mapset"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.tod2mapset">[docs]</a>    <span class="k">def</span> <span class="nf">tod2mapset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                     
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#dat=self.info[&#39;dat_calib&#39;]</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span>
            <span class="nb">map</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="p">)</span></div>
<div class="viewcode-block" id="Tod.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset_out</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#tmp=0.0*self.info[&#39;dat_calib&#39;]</span>
        <span class="c1">#for map in mapset.maps:</span>
        <span class="c1">#    map.map2tod(self,tmp)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapset2tod</span><span class="p">(</span><span class="n">mapset</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">t3</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tod2mapset</span><span class="p">(</span><span class="n">mapset_out</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">t4</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#for map in mapset_out.maps:</span>
        <span class="c1">#    map.tod2map(self,tmp)</span>
        <span class="k">if</span> <span class="n">times</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">,</span><span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">]))</span></div>
<div class="viewcode-block" id="Tod.set_jumps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.set_jumps">[docs]</a>    <span class="k">def</span> <span class="nf">set_jumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jumps</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jumps</span><span class="o">=</span><span class="n">jumps</span></div>
<div class="viewcode-block" id="Tod.cut_detectors"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.cut_detectors">[docs]</a>    <span class="k">def</span> <span class="nf">cut_detectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">isgood</span><span class="p">):</span>
        <span class="c1">#cut all detectors not in boolean array isgood</span>
        <span class="n">isbad</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">isgood</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="n">bad_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">isbad</span><span class="p">)</span>
        <span class="n">bad_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">bad_inds</span><span class="p">)</span>
        <span class="n">bad_inds</span><span class="o">=</span><span class="n">bad_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bad_inds</span><span class="p">)</span>
        <span class="n">nkeep</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">isgood</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">slice_with_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">isgood</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jumps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_inds</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i in bad_inds is &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jumps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_inds</span><span class="p">:</span>
                <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cuts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>
                
<div class="viewcode-block" id="Tod.timestream_chisq"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.timestream_chisq">[docs]</a>    <span class="k">def</span> <span class="nf">timestream_chisq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span>
        <span class="n">dat_filt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat_filt</span><span class="o">*</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chisq</span></div>
<div class="viewcode-block" id="Tod.prior_from_skymap"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.Tod.html#minkasi_wrapper.extern.minkasi.minkasi.Tod.prior_from_skymap">[docs]</a>    <span class="k">def</span> <span class="nf">prior_from_skymap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">skymap</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;stuff.</span>
<span class="sd">        prior_from_skymap(self,skymap):</span>
<span class="sd">        Given e.g. the gradient of a map that has been zeroed under some threshold,</span>
<span class="sd">        return a CutsCompact object that can be used as a prior for solving for per-sample deviations</span>
<span class="sd">        due to strong map gradients.  This is to reduce X&#39;s around bright sources.  The input map</span>
<span class="sd">        should be a SkyMap that is non-zero where one wishes to solve for the per-sample deviations, and </span>
<span class="sd">        the non-zero values should be the standard deviations expected in those pixel.  The returned CutsCompact </span>
<span class="sd">        object will have the weight (i.e. 1/input squared) in its map.        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">skymap</span><span class="o">.</span><span class="n">map2tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">tmp</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">prior</span><span class="o">=</span><span class="n">CutsCompact</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">prior</span><span class="o">.</span><span class="n">cuts_from_array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">prior</span><span class="o">.</span><span class="n">get_imap</span><span class="p">()</span>
        <span class="n">prior</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">prior</span><span class="o">.</span><span class="n">map</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">prior</span><span class="o">.</span><span class="n">map</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">prior</span></div></div>

<div class="viewcode-block" id="slice_with_copy"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.slice_with_copy.html#minkasi_wrapper.extern.minkasi.minkasi.slice_with_copy">[docs]</a><span class="k">def</span> <span class="nf">slice_with_copy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">ind</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">myshape</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myshape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ans</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ans</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">ans</span><span class="p">[:]</span><span class="o">=</span><span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>   
            <span class="n">mydims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="n">myshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mydims</span><span class="p">,</span><span class="n">mydims</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">ans</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mydims</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">ans</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ans</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="c1">#should not get here</span></div>
<div class="viewcode-block" id="TodVec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec">[docs]</a><span class="k">class</span> <span class="nc">TodVec</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="o">=</span><span class="mi">0</span>
<div class="viewcode-block" id="TodVec.add_tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.add_tod">[docs]</a>    <span class="k">def</span> <span class="nf">add_tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tod</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="o">+</span><span class="mi">1</span></div>
<div class="viewcode-block" id="TodVec.lims"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.lims">[docs]</a>    <span class="k">def</span> <span class="nf">lims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lims</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lims</span><span class="p">()</span>
            <span class="n">xmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">xmin</span><span class="p">)</span>
            <span class="n">xmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>
            <span class="n">ymin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="n">ymin</span><span class="p">)</span>
            <span class="n">ymax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before reduction lims are &#39;</span><span class="p">,[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">])</span>
            <span class="n">xmin</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
            <span class="n">xmax</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>
            <span class="n">ymin</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
            <span class="n">ymax</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after reduction lims are &#39;</span><span class="p">,[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span></div>
<div class="viewcode-block" id="TodVec.set_pix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.set_pix">[docs]</a>    <span class="k">def</span> <span class="nf">set_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="c1">#ipix=map.get_pix(tod)</span>
            <span class="c1">#tod.info[&#39;ipix&#39;]=ipix</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">set_pix</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span></div>
<div class="viewcode-block" id="TodVec.set_apix"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.set_apix">[docs]</a>    <span class="k">def</span> <span class="nf">set_apix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">set_apix</span><span class="p">()</span></div>
<div class="viewcode-block" id="TodVec.dot_cached"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.dot_cached">[docs]</a>    <span class="k">def</span> <span class="nf">dot_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nthread</span><span class="o">=</span><span class="n">get_nthread</span><span class="p">()</span>
        <span class="n">mapset2</span><span class="o">.</span><span class="n">get_caches</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="p">):</span>
            <span class="n">tod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tod</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset2</span><span class="p">)</span>
        <span class="n">mapset2</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="n">mapset2</span><span class="o">.</span><span class="n">mpi_reduce</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mapset2</span></div>

<div class="viewcode-block" id="TodVec.get_nsamp"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.get_nsamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_nsamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">tot</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="n">tot</span><span class="o">=</span><span class="n">tot</span><span class="o">+</span><span class="n">tod</span><span class="o">.</span><span class="n">get_nsamp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
                <span class="n">tot</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tot</span></div>

<div class="viewcode-block" id="TodVec.dot"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">report_times</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cache_maps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mapset2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapset2</span><span class="o">=</span><span class="n">mapset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mapset2</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cache_maps</span><span class="p">:</span>
            <span class="n">mapset2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dot_cached</span><span class="p">(</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mapset2</span>
            

        <span class="n">times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="p">)</span>
        <span class="n">tot_times</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1">#for tod in self.tods:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntod</span><span class="p">):</span>
            <span class="n">tod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">mytimes</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mapset</span><span class="p">,</span><span class="n">mapset2</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tot_times</span><span class="o">=</span><span class="n">tot_times</span><span class="o">+</span><span class="n">mytimes</span>
            <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="n">mapset2</span><span class="o">.</span><span class="n">mpi_reduce</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tot_times</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report_times</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mapset2</span><span class="p">,</span><span class="n">times</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mapset2</span></div>
<div class="viewcode-block" id="TodVec.make_rhs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.TodVec.html#minkasi_wrapper.extern.minkasi.minkasi.TodVec.make_rhs">[docs]</a>    <span class="k">def</span> <span class="nf">make_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mapset</span><span class="p">,</span><span class="n">do_clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_clear</span><span class="p">:</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="n">dat_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="n">mapset</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span>
                <span class="nb">map</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">dat_filt</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
            <span class="n">mapset</span><span class="o">.</span><span class="n">mpi_reduce</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="read_tod_from_fits_cbass"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_fits_cbass.html#minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_fits_cbass">[docs]</a><span class="k">def</span> <span class="nf">read_tod_from_fits_cbass</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">dopol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="mf">37.2314</span><span class="p">,</span><span class="n">lon</span><span class="o">=-</span><span class="mf">118.2941</span><span class="p">,</span><span class="n">v34</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nm20</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ra</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
    <span class="n">dec</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
    <span class="n">flag</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]</span>
    <span class="n">I</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;I1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;I2&#39;</span><span class="p">])</span>


    <span class="n">mjd</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;MJD&#39;</span><span class="p">]</span>
    <span class="n">tvec</span><span class="o">=</span><span class="p">(</span><span class="n">mjd</span><span class="o">-</span><span class="mf">2455977.5</span><span class="o">+</span><span class="mf">2400000.5</span><span class="p">)</span><span class="o">*</span><span class="mi">86400</span><span class="o">+</span><span class="mi">1329696000</span>
    <span class="c1">#(mjd-2455977.5)*86400+1329696000;</span>
    <span class="n">dt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>

    <span class="n">dat</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">),[</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)])</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">),[</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dec</span><span class="p">)])</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dt</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;ctime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tvec</span>
    <span class="k">if</span> <span class="n">dopol</span><span class="p">:</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]])</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]])</span>
        <span class="n">Q</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;Q2&#39;</span><span class="p">])</span>
        <span class="n">U</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;U1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;U2&#39;</span><span class="p">])</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Q</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">v34</span><span class="p">:</span>  <span class="c1">#We believe this is the correct sign convention for V34</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=-</span><span class="n">U</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">Q</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">Q</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">U</span>            
        <span class="n">az</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;AZ&#39;</span><span class="p">]</span>
        <span class="n">el</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;EL&#39;</span><span class="p">]</span>
        <span class="c1">#JLS- changing default az/el to radians and not degrees in TOD</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">az</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;el&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">el</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        
        <span class="c1">#dat[&#39;AZ&#39;]=az</span>
        <span class="c1">#dat[&#39;EL&#39;]=el</span>
        <span class="c1">#dat[&#39;ctime&#39;]=tvec</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Q</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">have_qp</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">qp</span><span class="o">.</span><span class="n">QPoint</span><span class="p">(</span><span class="n">accuracy</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">fast_math</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mean_aber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1">#q_bore = Q.azel2bore(dat[&#39;AZ&#39;], dat[&#39;EL&#39;], 0*dat[&#39;AZ&#39;], 0*dat[&#39;AZ&#39;], lon*np.pi/180, lat*np.pi/180, dat[&#39;ctime&#39;])</span>
            <span class="n">q_bore</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">azel2bore</span><span class="p">(</span><span class="n">az</span><span class="p">,</span><span class="n">el</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">az</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="n">az</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;ctime&#39;</span><span class="p">])</span>
            <span class="n">q_off</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">det_offset</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="c1">#ra, dec, sin2psi, cos2psi = Q.bore2radec(q_off, ctime, q_bore)</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">sin2psi</span><span class="p">,</span> <span class="n">cos2psi</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">bore2radec</span><span class="p">(</span><span class="n">q_off</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">q_bore</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sin2psi</span><span class="p">,</span><span class="n">cos2psi</span><span class="p">)</span> 
            <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="c1">#this seems to be needed to get these coordinates to line up with </span>
                            <span class="c1">#the expected, in IAU convention I believe.  JLS Nov 12 2020</span>
            <span class="c1">#dat[&#39;twogamma_saved&#39;]=np.arctan2(sin2psi,cos2psi)</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;twogamma_saved&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">tmp</span><span class="p">,</span><span class="n">tmp</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1">#print(&#39;pointing rms is &#39;,np.std(ra*np.pi/180-dat[&#39;dx&#39;]),np.std(dec*np.pi/180-dat[&#39;dy&#39;]))</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ra</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dec</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)])</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">I</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]</span>


    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;pixid&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fname</span>

    <span class="k">if</span> <span class="n">nm20</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
        <span class="c1">#kludget to read in bonus cuts, which should be in f[3]</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> 
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;nm20_start&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">]</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;nm20_stop&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;END&#39;</span><span class="p">]</span>
            <span class="c1">#nm20=0*dat[&#39;flag&#39;]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">nm20</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
            <span class="n">start</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;nm20_start&#39;</span><span class="p">]</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;nm20_stop&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)):</span>
                <span class="n">nm20</span><span class="p">[:,</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">stop</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
                <span class="c1">#nm20[:,start[i]:stop[i]]=0</span>
            <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nm20</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;missing nm20 for &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dat</span></div>

<div class="viewcode-block" id="read_tod_from_toltec_nc"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_toltec_nc.html#minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_toltec_nc">[docs]</a><span class="k">def</span> <span class="nf">read_tod_from_toltec_nc</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">arrayindex</span><span class="p">,</span> <span class="n">sample_slice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ncfile</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="n">v_time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;TelTime&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;ELEV&#39;</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="n">v_elev</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;ELEV&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_elev</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;TelElDes&#39;</span><span class="p">]</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">]</span>
    <span class="n">all_dx</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;DX&#39;</span><span class="p">]</span>
    <span class="n">all_dy</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span>
    <span class="n">all_elev</span> <span class="o">=</span> <span class="n">v_elev</span> 
    <span class="n">all_flag</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]</span>
    <span class="n">all_pixid</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;PIXID&#39;</span><span class="p">]</span>
    <span class="n">all_time</span> <span class="o">=</span> <span class="n">v_time</span> 
    <span class="n">all_arrayid</span> <span class="o">=</span> <span class="n">ncfile</span><span class="p">[</span><span class="s1">&#39;ARRAYID&#39;</span><span class="p">]</span>

    <span class="c1">#Can be read in but unneeded</span>

    <span class="c1"># all_azoff = ncfile[&#39;AZOFF&#39;]</span>
    <span class="c1"># all_eloff = ncfile[&#39;ELOFF&#39;]</span>
    <span class="c1"># all_afwhm = ncfile[&#39;AFWHM&#39;]</span>
    <span class="c1"># all_bfwhm = ncfile[&#39;BFWHM&#39;]</span>


    <span class="n">select_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_arrayid</span><span class="p">)</span><span class="o">==</span><span class="n">arrayindex</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">selected_data</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">,</span><span class="n">select_vals</span><span class="p">]</span>
    <span class="n">selected_dx</span> <span class="o">=</span> <span class="n">all_dx</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">,</span><span class="n">select_vals</span><span class="p">]</span>
    <span class="n">selected_dy</span> <span class="o">=</span> <span class="n">all_dy</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">,</span><span class="n">select_vals</span><span class="p">]</span>
    <span class="n">selected_elev</span> <span class="o">=</span> <span class="n">all_elev</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">]</span>
    <span class="n">selected_flag</span> <span class="o">=</span> <span class="n">all_flag</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">,</span><span class="n">select_vals</span><span class="p">]</span>
    <span class="n">selected_pixid</span> <span class="o">=</span> <span class="n">all_pixid</span><span class="p">[</span><span class="n">select_vals</span><span class="p">]</span>
    <span class="n">selected_time</span> <span class="o">=</span> <span class="n">all_time</span><span class="p">[</span><span class="n">sample_slice</span><span class="p">]</span>

    <span class="c1">#not needed</span>
    <span class="c1"># selected_azoff = all_azoff[select_vals]</span>
    <span class="c1"># selected_eloff = all_eloff[select_vals]</span>
    <span class="c1"># selected_afwhm = all_afwhm[select_vals]</span>
    <span class="c1"># selected_bfwhm = all_bfwhm[select_vals]</span>


    <span class="n">ndet</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_pixid</span><span class="p">)</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_time</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;read data file </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> with slice=</span><span class="si">{</span><span class="n">sample_slice</span><span class="si">}</span><span class="s1"> took </span><span class="si">{</span><span class="n">t1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>
    
    <span class="n">ff</span><span class="o">=</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">xmin</span><span class="o">=</span><span class="n">selected_dx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
    <span class="n">xmax</span><span class="o">=</span><span class="n">selected_dx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
    <span class="n">ymin</span><span class="o">=</span><span class="n">selected_dy</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
    <span class="n">ymax</span><span class="o">=</span><span class="n">selected_dy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nsamp = &#39;</span><span class="p">,</span><span class="n">nsamp</span><span class="p">,</span><span class="s1">&#39;  ,&#39;</span><span class="p">,</span><span class="s1">&#39;ndet = &#39;</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="s1">&#39;  ,&#39;</span><span class="p">,</span> <span class="s1">&#39;ndatapoints = &#39;</span><span class="p">,</span><span class="n">ndet</span><span class="o">*</span><span class="n">nsamp</span><span class="p">,</span> <span class="s1">&#39;  ,&#39;</span><span class="p">,</span><span class="s1">&#39; on &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;with lims &#39;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span> <span class="p">)</span>
    
    <span class="n">dat</span><span class="o">=</span><span class="p">{}</span>

    <span class="n">ndet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">nsamp</span><span class="p">)</span>

    <span class="n">samp_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsamp</span><span class="p">)</span>
    <span class="n">det_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>



    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">selected_dx</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">selected_dy</span><span class="p">)</span>

    
    <span class="n">elev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">selected_elev</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">det_ones</span><span class="p">,</span><span class="n">elev</span><span class="p">)</span>

    <span class="n">dt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">selected_time</span><span class="p">))</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dt</span>
    <span class="n">pixid</span><span class="o">=</span><span class="n">selected_pixid</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;pixid&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pixid</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">selected_data</span><span class="p">)</span>

    <span class="c1">#work the flags out later</span>
    <span class="c1"># if np.sum(raw[&#39;UFNU&#39;]&gt;9e5)&gt;0:</span>
    <span class="c1">#     dat[&#39;mask&#39;]=np.reshape(raw[&#39;UFNU&#39;]&lt;9e5,dat[&#39;dat_calib&#39;].shape)</span>
    <span class="c1">#     dat[&#39;mask_sum&#39;]=np.sum(dat[&#39;mask&#39;],axis=0)</span>
    
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fname</span>

    <span class="k">del</span> <span class="n">select_vals</span>
    <span class="k">del</span> <span class="n">selected_data</span>
    <span class="k">del</span> <span class="n">selected_dx</span>
    <span class="k">del</span> <span class="n">selected_dy</span>
    <span class="k">del</span> <span class="n">selected_elev</span>
    <span class="k">del</span> <span class="n">selected_flag</span>
    <span class="k">del</span> <span class="n">selected_pixid</span>
    <span class="k">del</span> <span class="n">selected_time</span>
    <span class="k">del</span> <span class="n">samp_ones</span>
    <span class="k">del</span> <span class="n">det_ones</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dat</span></div>

<div class="viewcode-block" id="read_tod_from_fits"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_fits.html#minkasi_wrapper.extern.minkasi.minkasi.read_tod_from_fits">[docs]</a><span class="k">def</span> <span class="nf">read_tod_from_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">branch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1">#print &#39;sum of cut elements is &#39;,np.sum(raw[&#39;UFNU&#39;]&lt;9e5)</span>
    <span class="k">try</span> <span class="p">:</span> <span class="c1">#read in calinfo (per-scan beam volumes etc) if present</span>
        <span class="n">calinfo</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;calinfo&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
        <span class="n">kwds</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span><span class="s1">&#39;bunit&#39;</span><span class="p">,</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span><span class="s1">&#39;elevatio&#39;</span><span class="p">,</span><span class="s1">&#39;beameff&#39;</span><span class="p">,</span><span class="s1">&#39;apereff&#39;</span><span class="p">,</span><span class="s1">&#39;antgain&#39;</span><span class="p">,</span><span class="s1">&#39;gainunc&#39;</span><span class="p">,</span><span class="s1">&#39;bmaj&#39;</span><span class="p">,</span><span class="s1">&#39;bmin&#39;</span><span class="p">,</span><span class="s1">&#39;bpa&#39;</span><span class="p">,</span><span class="s1">&#39;parang&#39;</span><span class="p">,</span><span class="s1">&#39;beamvol&#39;</span><span class="p">,</span><span class="s1">&#39;beamvunc&#39;</span><span class="p">)</span><span class="c1">#for now just hardwired ones we want</span>
        <span class="k">for</span> <span class="n">kwd</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">calinfo</span><span class="p">[</span><span class="n">kwd</span><span class="p">]</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">hdu</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">kwd</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING - calinfo information not found in fits file header - to track JytoK etc you may need to reprocess the fits files using mustangidl &gt; revision 932&#39;</span><span class="p">)</span> 
        <span class="n">calinfo</span><span class="p">[</span><span class="s1">&#39;calinfo&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>

    <span class="n">pixid</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;PIXID&#39;</span><span class="p">]</span>
    <span class="n">dets</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pixid</span><span class="p">)</span>
    <span class="n">ndet</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pixid</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ff</span><span class="o">=</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">xmin</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
        <span class="n">xmax</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
        <span class="n">ymin</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">ff</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nsamp and ndet are &#39;</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pixid</span><span class="p">),</span><span class="s1">&#39; on &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;with lims &#39;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nsamp and ndet are &#39;</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pixid</span><span class="p">),</span><span class="s1">&#39; on &#39;</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1">#print raw.names</span>
    <span class="n">dat</span><span class="o">=</span><span class="p">{}</span>
    <span class="c1">#this bit of odd gymnastics is because a straightforward reshape doesn&#39;t seem to leave the data in</span>
    <span class="c1">#memory-contiguous order, which causes problems down the road</span>
    <span class="c1">#also, float32 is a bit on the edge for pointing, so cast to float64</span>
    <span class="n">dx</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DX&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">branch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">bb</span><span class="o">=</span><span class="n">branch</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">dx</span><span class="o">&gt;</span><span class="n">bb</span><span class="p">]</span><span class="o">=</span><span class="n">dx</span><span class="p">[</span><span class="n">dx</span><span class="o">&gt;</span><span class="n">bb</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1">#dat[&#39;dx&#39;]=np.zeros([ndet,nsamp],dtype=type(dx[0]))</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">ndet</span><span class="p">)</span>
    <span class="n">nsamp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">nsamp</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dx</span><span class="p">,[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])[:]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span>
    <span class="c1">#dat[&#39;dy&#39;]=np.zeros([ndet,nsamp],dtype=type(dy[0]))</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dy</span><span class="p">,[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])[:]</span>
    <span class="k">if</span> <span class="s1">&#39;ELEV&#39;</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="n">elev</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;ELEV&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">elev</span><span class="p">,[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])[:]</span>

    <span class="n">tt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">],[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span>
    <span class="n">tt</span><span class="o">=</span><span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">dt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dt</span>
    <span class="n">pixid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pixid</span><span class="p">,[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span>
    <span class="n">pixid</span><span class="o">=</span><span class="n">pixid</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;pixid&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pixid</span>
    <span class="n">dat_calib</span><span class="o">=</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;FNU&#39;</span><span class="p">]</span>
    <span class="c1">#print &#39;shapes are &#39;,raw[&#39;FNU&#39;].shape,raw[&#39;UFNU&#39;].shape,np.mean(raw[&#39;UFNU&#39;]&gt;9e5)</span>
    <span class="c1">#dat_calib[raw[&#39;UFNU&#39;]&gt;9e5]=0.0</span>

    <span class="c1">#dat[&#39;dat_calib&#39;]=np.zeros([ndet,nsamp],dtype=type(dat_calib[0]))</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span> <span class="c1">#go to double because why not</span>
    <span class="n">dat_calib</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dat_calib</span><span class="p">,[</span><span class="n">ndet</span><span class="p">,</span><span class="n">nsamp</span><span class="p">])</span>

    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">][:]</span><span class="o">=</span><span class="n">dat_calib</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;UFNU&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">9e5</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;UFNU&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">9e5</span><span class="p">,</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask_sum&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#print &#39;cut frac is now &#39;,np.mean(dat_calib==0)</span>
    <span class="c1">#print &#39;cut frac is now &#39;,np.mean(dat[&#39;dat_calib&#39;]==0),dat[&#39;dat_calib&#39;][0,0]</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fname</span>
    <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;calinfo&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">calinfo</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dat</span></div>


<div class="viewcode-block" id="downsample_array_r2r"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.downsample_array_r2r.html#minkasi_wrapper.extern.minkasi.minkasi.downsample_array_r2r">[docs]</a><span class="k">def</span> <span class="nf">downsample_array_r2r</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">fac</span><span class="p">):</span>

    <span class="n">n</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nn</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">fac</span><span class="p">)</span>
    <span class="n">arr_ft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">arr_ft</span><span class="o">=</span><span class="n">arr_ft</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">arr</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">arr_ft</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">arr</span></div>

<div class="viewcode-block" id="downsample_vec_r2r"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.downsample_vec_r2r.html#minkasi_wrapper.extern.minkasi.minkasi.downsample_vec_r2r">[docs]</a><span class="k">def</span> <span class="nf">downsample_vec_r2r</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">fac</span><span class="p">):</span>

    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">nn</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">fac</span><span class="p">)</span>
    <span class="n">vec_ft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">vec_ft</span><span class="o">=</span><span class="n">vec_ft</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vec</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">vec_ft</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">vec</span></div>

<div class="viewcode-block" id="downsample_tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.downsample_tod.html#minkasi_wrapper.extern.minkasi.minkasi.downsample_tod">[docs]</a><span class="k">def</span> <span class="nf">downsample_tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">ndata</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">keys</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1">#print(&#39;working on downsampling &#39; + key)</span>
                <span class="c1">#print(&#39;shape is &#39; + repr(dat[key].shape[0])+&#39;  &#39;+repr(n))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="c1">#print(&#39;working on downsampling &#39; + key)</span>
                    <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">downsample_vec_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">fac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">ndata</span><span class="p">:</span>
                <span class="c1">#print &#39;downsampling &#39; + key</span>
                    <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">downsample_array_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">fac</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1">#print &#39;not downsampling &#39; + key</span>
            <span class="k">pass</span></div>
    

<div class="viewcode-block" id="truncate_tod"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.truncate_tod.html#minkasi_wrapper.extern.minkasi.minkasi.truncate_tod">[docs]</a><span class="k">def</span> <span class="nf">truncate_tod</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">primes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">]):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;dat_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lens</span><span class="o">=</span><span class="n">find_good_fft_lens</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">primes</span><span class="p">)</span>
    <span class="n">n_new</span><span class="o">=</span><span class="n">lens</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_new</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;truncating from &#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s1">&#39; to &#39;</span><span class="p">,</span><span class="n">n_new</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#print(&#39;working on key &#39; + key)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">n</span><span class="p">:</span>
                        <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="n">n_new</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">n</span><span class="p">:</span>
                        <span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="n">n_new</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1">#print(&#39;skipping key &#39; + key)</span>
                <span class="k">pass</span></div>




<div class="viewcode-block" id="todvec_from_files_octave"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.todvec_from_files_octave.html#minkasi_wrapper.extern.minkasi.minkasi.todvec_from_files_octave">[docs]</a><span class="k">def</span> <span class="nf">todvec_from_files_octave</span><span class="p">(</span><span class="n">fnames</span><span class="p">):</span>
    <span class="n">todvec</span><span class="o">=</span><span class="n">TodVec</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
        <span class="n">info</span><span class="o">=</span><span class="n">read_octave_struct</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">tod</span><span class="o">=</span><span class="n">Tod</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">todvec</span><span class="o">.</span><span class="n">add_tod</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">todvec</span></div>
        
<div class="viewcode-block" id="make_hits"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.make_hits.html#minkasi_wrapper.extern.minkasi.minkasi.make_hits">[docs]</a><span class="k">def</span> <span class="nf">make_hits</span><span class="p">(</span><span class="n">todvec</span><span class="p">,</span><span class="nb">map</span><span class="p">,</span><span class="n">do_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">hits</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">map</span><span class="o">.</span><span class="n">npol</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">hits</span><span class="o">.</span><span class="n">set_polstate</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">poltag</span><span class="o">+</span><span class="s1">&#39;_PRECON&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">hits</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">todvec</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_weights</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_det_weights</span><span class="p">()</span>
                <span class="c1">#sz=tod.info[&#39;dat_calib&#39;].shape</span>
                <span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="c1">#tmp=np.outer(weights,np.ones(tod.info[&#39;dat_calb&#39;].shape[1]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error in making weight map.  Detector weights requested, but do not appear to be present.  Do you have a noise model?&quot;</span><span class="p">)</span>
                             
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#tmp=np.ones(tod.info[&#39;dat_calib&#39;].shape)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">())</span>
        <span class="c1">#if tod.info.has_key(&#39;mask&#39;):</span>
        <span class="k">if</span> <span class="s1">&#39;mask&#39;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="o">*</span><span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">tod2map</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reducing hits&#39;</span><span class="p">)</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting with total hitcount &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tot</span><span class="p">))</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">mpi_reduce</span><span class="p">()</span>
        <span class="n">tot</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ending with total hitcount &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tot</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hits</span></div>


<div class="viewcode-block" id="decimate"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.decimate.html#minkasi_wrapper.extern.minkasi.minkasi.decimate">[docs]</a><span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">nrep</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrep</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vec</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vec</span></div>
<div class="viewcode-block" id="plot_ps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.plot_ps.html#minkasi_wrapper.extern.minkasi.minkasi.plot_ps">[docs]</a><span class="k">def</span> <span class="nf">plot_ps</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">downsamp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">vecft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="get_wcs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_wcs.html#minkasi_wrapper.extern.minkasi.minkasi.get_wcs">[docs]</a><span class="k">def</span> <span class="nf">get_wcs</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span><span class="n">pixsize</span><span class="p">,</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;CAR&#39;</span><span class="p">,</span><span class="n">cosdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref_equ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">w</span><span class="o">=</span><span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>    
    <span class="n">dec</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cosdec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cosdec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proj</span><span class="o">==</span><span class="s1">&#39;CAR&#39;</span><span class="p">:</span>
        <span class="c1">#CAR in FITS seems to already correct for cosin(dec), which has me confused, but whatever...</span>
        <span class="n">cosdec</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">ref_equ</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
            <span class="c1">#this seems to be a needed hack if you want the position sent</span>
            <span class="c1">#in for the corner to actually be the corner.</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">pixsize</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">pixsize</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#w.wcs.crpix=[lims[1]/pixsize,-lims[2]/pixsize]</span>
            <span class="c1">#print &#39;crpix is &#39;,w.wcs.crpix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="o">=</span><span class="p">[</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">lims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">pixsize</span><span class="o">/</span><span class="n">cosdec</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">pixsize</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RA---CAR&#39;</span><span class="p">,</span><span class="s1">&#39;DEC--CAR&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">w</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unknown projection type &#39;</span><span class="p">,</span><span class="n">proj</span><span class="p">,</span><span class="s1">&#39; in get_wcs.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_aligned_map_subregion_car"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_aligned_map_subregion_car.html#minkasi_wrapper.extern.minkasi.minkasi.get_aligned_map_subregion_car">[docs]</a><span class="k">def</span> <span class="nf">get_aligned_map_subregion_car</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span><span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">big_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">osamp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a wcs for a subregion of a map, with optionally finer pixellization.  </span>
<span class="sd">    Designed for use in e.g. combining ACT maps and Mustang data.  Input arguments</span>
<span class="sd">    are RA/Dec limits for the subregion (which will be tweaked as-needed) and either a </span>
<span class="sd">    WCS structure or the name of a FITS file containing the WCS info the sub-region</span>
<span class="sd">    will be aligned with.&quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">big_wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in get_aligned_map_subregion_car.  Must send in either a file or a WCS.&quot;</span><span class="p">)</span>
        <span class="n">big_wcs</span><span class="o">=</span><span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">ll</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
    <span class="n">ll</span><span class="o">=</span><span class="n">ll</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> 
    
    <span class="c1">#get the ra/dec limits in big pixel coordinates</span>
    <span class="n">corner1</span><span class="o">=</span><span class="n">big_wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">corner2</span><span class="o">=</span><span class="n">big_wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ll</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#get the pixel edges for the corners.  FITS works in</span>
    <span class="c1">#pixel centers, so edges are a half-pixel off</span>
    <span class="n">corner1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mf">0.5</span>
    <span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mf">0.5</span>
    <span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mf">0.5</span>
    <span class="n">corner2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">corner2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mf">0.5</span>
    
    <span class="n">corner1_radec</span><span class="o">=</span><span class="n">big_wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">corner2_radec</span><span class="o">=</span><span class="n">big_wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">dra</span><span class="o">=</span><span class="p">(</span><span class="n">corner1_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">corner2_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ddec</span><span class="o">=</span><span class="p">(</span><span class="n">corner1_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">corner2_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">corner2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dra</span><span class="o">/</span><span class="n">ddec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;</span><span class="mf">1e-5</span><span class="p">)</span>  <span class="c1">#we are not currently smart enough to deal with rectangular pixels</span>
    
    <span class="n">lims_use</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">corner1_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner2_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner1_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">corner2_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">pixsize</span><span class="o">=</span><span class="n">ddec</span><span class="o">/</span><span class="n">osamp</span>
    <span class="n">lims_use</span><span class="o">=</span><span class="n">lims_use</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">])</span><span class="o">*</span><span class="n">pixsize</span>
    
    <span class="n">small_wcs</span><span class="o">=</span><span class="n">get_wcs</span><span class="p">(</span><span class="n">lims_use</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span><span class="n">pixsize</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span><span class="n">ref_equ</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">imin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">jmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">map_corner</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">imin</span><span class="p">,</span><span class="n">jmin</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">lims_use</span><span class="o">=</span><span class="n">lims_use</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>

    <span class="k">return</span> <span class="n">small_wcs</span><span class="p">,</span><span class="n">lims_use</span><span class="p">,</span><span class="n">map_corner</span></div>






<div class="viewcode-block" id="fit_linear_ps_uncorr"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_linear_ps_uncorr.html#minkasi_wrapper.extern.minkasi.minkasi.fit_linear_ps_uncorr">[docs]</a><span class="k">def</span> <span class="nf">fit_linear_ps_uncorr</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">vecs</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">vecs</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">rhs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">dat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lhs</span><span class="p">),</span><span class="n">rhs</span><span class="p">)</span> 
        <span class="n">guess</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">guess</span> <span class="c1">#scale down since we&#39;re less likely to run into convergence issues if we start low</span>
        <span class="c1">#print guess</span>
    <span class="n">fitp</span><span class="o">=</span><span class="n">guess</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">converged</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">npp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fitp</span><span class="p">)</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="n">grad_tr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npp</span><span class="p">)</span>
    <span class="n">grad_chi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npp</span><span class="p">)</span>
    <span class="n">curve</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="p">,</span><span class="n">npp</span><span class="p">])</span>
    <span class="n">datsqr</span><span class="o">=</span><span class="n">dat</span><span class="o">*</span><span class="n">dat</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">converged</span><span class="o">==</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">iter</span><span class="o">=</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">C</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fitp</span><span class="p">,</span><span class="n">vecs</span><span class="p">)</span>
        <span class="n">Cinv</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">C</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="p">):</span>
            <span class="n">grad_chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span>
            <span class="n">grad_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">npp</span><span class="p">):</span>
                <span class="c1">#curve[i,j]=-0.5*np.sum(datsqr*Cinv*Cinv*Cinv*vecs[i,:]*vecs[j,:]) #data-only curvature</span>
                <span class="c1">#curve[i,j]=-0.5*np.sum(Cinv*Cinv*vecs[i,:]*vecs[j,:]) #Fisher curvature</span>
                <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span> <span class="c1">#exact</span>
                <span class="n">curve</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">grad</span><span class="o">=</span><span class="n">grad_chi</span><span class="o">+</span><span class="n">grad_tr</span>
        <span class="n">curve_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
        <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">)</span>
        <span class="n">dp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve_inv</span><span class="p">)</span>
        <span class="n">fitp</span><span class="o">=</span><span class="n">fitp</span><span class="o">-</span><span class="n">dp</span>
        <span class="n">frac_shift</span><span class="o">=</span><span class="n">dp</span><span class="o">/</span><span class="n">errs</span>
        <span class="c1">#print dp,errs,frac_shift</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frac_shift</span><span class="p">))</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;successful convergence after &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span><span class="s1">&#39; iterations with error estimate &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frac_shift</span><span class="p">)))</span>
            <span class="n">converged</span><span class="o">=</span><span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">C</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">iter</span><span class="o">==</span><span class="n">max_iter</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not converging after &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span><span class="s1">&#39; iterations in fit_linear_ps_uncorr with current convergence parameter &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frac_shift</span><span class="p">)))</span>
            <span class="n">converged</span><span class="o">=</span><span class="kc">True</span>
            
    <span class="k">return</span> <span class="n">fitp</span></div>

<div class="viewcode-block" id="get_curve_deriv_powspec"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_powspec.html#minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_powspec">[docs]</a><span class="k">def</span> <span class="nf">get_curve_deriv_powspec</span><span class="p">(</span><span class="n">fitp</span><span class="p">,</span><span class="n">nu_scale</span><span class="p">,</span><span class="n">lognu</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">vecs</span><span class="p">):</span>
    <span class="n">vec</span><span class="o">=</span><span class="n">nu_scale</span><span class="o">**</span><span class="n">fitp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">C</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vec</span>
    <span class="n">Cinv</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">C</span>
    <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">vec</span>
    <span class="n">vecs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">lognu</span><span class="o">*</span><span class="n">vec</span>
    <span class="n">grad_chi</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span>
    <span class="n">grad_tr</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">Cinv</span><span class="p">)</span>
    <span class="n">grad</span><span class="o">=</span><span class="n">grad_chi</span><span class="o">+</span><span class="n">grad_tr</span>
    <span class="n">np</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grad_chi</span><span class="p">)</span>
    <span class="n">curve</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">np</span><span class="p">,</span><span class="n">np</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">np</span><span class="p">):</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="n">like</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">like</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">C</span></div>

<div class="viewcode-block" id="fit_ts_ps"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_ts_ps.html#minkasi_wrapper.extern.minkasi.minkasi.fit_ts_ps">[docs]</a><span class="k">def</span> <span class="nf">fit_ts_ps</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">ind</span><span class="o">=-</span><span class="mf">1.5</span><span class="p">,</span><span class="n">nu_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">nu_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">scale_fac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

    <span class="n">datft</span><span class="o">=</span><span class="n">mkfftw</span><span class="o">.</span><span class="n">fft_r2r</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">datft</span><span class="p">)</span>

    <span class="n">dnu</span><span class="o">=</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span> <span class="c1">#coefficient should reflect the type of fft you did...</span>
    <span class="n">nu</span><span class="o">=</span><span class="n">dnu</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">isgood</span><span class="o">=</span><span class="p">(</span><span class="n">nu</span><span class="o">&gt;</span><span class="n">nu_min</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">nu</span><span class="o">&lt;</span><span class="n">nu_max</span><span class="p">)</span>
    <span class="n">datft</span><span class="o">=</span><span class="n">datft</span><span class="p">[</span><span class="n">isgood</span><span class="p">]</span>
    <span class="n">nu</span><span class="o">=</span><span class="n">nu</span><span class="p">[</span><span class="n">isgood</span><span class="p">]</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">vecs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">])</span>
    <span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span> <span class="c1">#white noise</span>
    <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">nu</span><span class="o">**</span><span class="n">ind</span>
    <span class="n">guess</span><span class="o">=</span><span class="n">fit_linear_ps_uncorr</span><span class="p">(</span><span class="n">datft</span><span class="p">,</span><span class="n">vecs</span><span class="p">)</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span><span class="n">vecs</span><span class="p">)</span>
    <span class="c1">#pred=guess[0]*vecs[0]+guess[1]*vecs[1]</span>
    <span class="c1">#return pred</span>

    <span class="n">rat</span><span class="o">=</span><span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">*</span><span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#print &#39;rat lims are &#39;,rat.max(),rat.min()</span>
    <span class="n">my_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rat</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nu_ref</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">my_ind</span><span class="p">]</span><span class="o">*</span><span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#WAG as to a sensible frequency pivot point</span>

    <span class="c1">#nu_ref=0.2*nu[my_ind] #WAG as to a sensible frequency pivot point</span>
    <span class="c1">#print &#39;knee is roughly at &#39;,nu[my_ind],nu_ref</span>

    <span class="c1">#model = guess[1]*nu^ind+guess[0]</span>
    <span class="c1">#      = guess[1]*(nu/nu_ref*nu_ref)^ind+guess[0]</span>
    <span class="c1">#      = guess[1]*(nu_ref)^in*(nu/nu_ref)^ind+guess[0]</span>

    <span class="n">nu_scale</span><span class="o">=</span><span class="n">nu</span><span class="o">/</span><span class="n">nu_ref</span>
    <span class="n">guess_scale</span><span class="o">=</span><span class="n">guess</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">guess_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nu_ref</span><span class="o">**</span><span class="n">ind</span><span class="p">)</span>
    <span class="c1">#print &#39;guess is &#39;,guess</span>
    <span class="c1">#print &#39;guess_scale is &#39;,guess_scale</span>
    <span class="n">C_scale</span><span class="o">=</span><span class="n">guess_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">guess_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nu_scale</span><span class="o">**</span><span class="n">ind</span><span class="p">)</span>
    

    <span class="n">fitp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fitp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">guess_scale</span>
    <span class="n">fitp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">ind</span>

    <span class="n">npp</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">vecs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="p">,</span><span class="n">n</span><span class="p">])</span>
    <span class="n">vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">lognu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nu_scale</span><span class="p">)</span>
    <span class="n">curve</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="p">,</span><span class="n">npp</span><span class="p">])</span>
    <span class="n">grad_chi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npp</span><span class="p">)</span>
    <span class="n">grad_tr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npp</span><span class="p">)</span>
    <span class="n">datsqr</span><span class="o">=</span><span class="n">datft</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1">#for robustness, start with downscaling 1/f part</span>
    <span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">like</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">get_curve_deriv_powspec</span><span class="p">(</span><span class="n">fitp</span><span class="p">,</span><span class="n">nu_scale</span><span class="p">,</span><span class="n">lognu</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">vecs</span><span class="p">)</span>
    <span class="n">lamda</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="c1">#print &#39;starting likelihood is&#39;,like</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">lamda</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve</span><span class="p">))</span>
        <span class="n">curve_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">dp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve_inv</span><span class="p">)</span>
        <span class="n">trial_fitp</span><span class="o">=</span><span class="n">fitp</span><span class="o">-</span><span class="n">dp</span>
        <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">))</span>
        <span class="n">frac</span><span class="o">=</span><span class="n">dp</span><span class="o">/</span><span class="n">errs</span>
        <span class="n">new_like</span><span class="p">,</span><span class="n">new_grad</span><span class="p">,</span><span class="n">new_curve</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">get_curve_deriv_powspec</span><span class="p">(</span><span class="n">trial_fitp</span><span class="p">,</span><span class="n">nu_scale</span><span class="p">,</span><span class="n">lognu</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">vecs</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">new_like</span><span class="o">&gt;</span><span class="n">like</span><span class="p">):</span>
        <span class="c1">#if True:</span>
            <span class="n">like</span><span class="o">=</span><span class="n">new_like</span>
            <span class="n">grad</span><span class="o">=</span><span class="n">new_grad</span>
            <span class="n">curve</span><span class="o">=</span><span class="n">new_curve</span>
            <span class="n">fitp</span><span class="o">=</span><span class="n">trial_fitp</span>
            <span class="n">lamda</span><span class="o">=</span><span class="n">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lamda</span><span class="o">=</span><span class="n">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lamda</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frac</span><span class="p">))</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">):</span>
            <span class="n">converged</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">converged</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">vec</span><span class="o">=</span><span class="n">nu_scale</span><span class="o">**</span><span class="n">fitp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">C</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">vec</span>
            <span class="n">Cinv</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">C</span>
            <span class="n">vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">vec</span>
            <span class="n">vecs</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span><span class="o">=</span><span class="n">fitp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">lognu</span><span class="o">*</span><span class="n">vec</span>
            <span class="n">like</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">):</span>
                <span class="n">grad_chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span>
                <span class="n">grad_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">Cinv</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">np</span><span class="p">):</span>
                    <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">datsqr</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">Cinv</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">vecs</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>
                    <span class="n">curve</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">grad</span><span class="o">=</span><span class="n">grad_chi</span><span class="o">+</span><span class="n">grad_tr</span>
            <span class="n">curve_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
            <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">)</span>
            <span class="n">dp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve_inv</span><span class="p">)</span>
            <span class="n">fitp</span><span class="o">=</span><span class="n">fitp</span><span class="o">-</span><span class="n">dp</span><span class="o">*</span><span class="n">scale_fac</span>
            <span class="n">frac_shift</span><span class="o">=</span><span class="n">dp</span><span class="o">/</span><span class="n">errs</span>

        <span class="c1">#print fitp,errs,frac_shift,np.mean(np.abs(new_grad-grad))</span>
        <span class="c1">#print fitp,grad,frac,lamda</span>
        <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converged after &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span><span class="s1">&#39; iterations&#39;</span><span class="p">)</span>
            <span class="k">break</span>



    <span class="c1">#C=np.dot(guess,vecs)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean diff is &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">C_scale</span><span class="o">-</span><span class="n">C</span><span class="p">)))</span>
    <span class="c1">#return datft,vecs,nu,C</span>
    <span class="k">return</span> <span class="n">fitp</span><span class="p">,</span><span class="n">datsqr</span><span class="p">,</span><span class="n">C</span></div>
    
<div class="viewcode-block" id="get_derivs_tod_isosrc"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_derivs_tod_isosrc.html#minkasi_wrapper.extern.minkasi.minkasi.get_derivs_tod_isosrc">[docs]</a><span class="k">def</span> <span class="nf">get_derivs_tod_isosrc</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">niso</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">np_src</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">np_iso</span><span class="o">=</span><span class="mi">5</span>
    <span class="c1">#nsrc=(len(pars)-np_iso)/np_src</span>
    <span class="n">npp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">niso</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">niso</span><span class="o">=</span><span class="p">(</span><span class="n">npp</span><span class="o">%</span><span class="n">np_src</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np_iso</span><span class="o">-</span><span class="n">np_src</span><span class="p">)</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="p">(</span><span class="n">npp</span><span class="o">-</span><span class="n">niso</span><span class="o">*</span><span class="n">np_iso</span><span class="p">)</span><span class="o">/</span><span class="n">np_src</span>
    <span class="c1">#print nsrc,niso</span>
    

    <span class="n">fitp_iso</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np_iso</span><span class="p">)</span>
    <span class="n">fitp_iso</span><span class="p">[:]</span><span class="o">=</span><span class="n">pars</span><span class="p">[:</span><span class="n">np_iso</span><span class="p">]</span>
    <span class="c1">#print &#39;fitp_iso is &#39;,fitp_iso</span>
    <span class="n">derivs_iso</span><span class="p">,</span><span class="n">f_iso</span><span class="o">=</span><span class="n">derivs_from_isobeta_c</span><span class="p">(</span><span class="n">fitp_iso</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>

    <span class="c1">#nn=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">nn</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_nsamp</span><span class="p">()</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_iso</span><span class="p">,[</span><span class="n">np_iso</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">f_iso</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">fitp_src</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np_src</span><span class="p">)</span>
        <span class="n">istart</span><span class="o">=</span><span class="n">np_iso</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="n">np_src</span>
        <span class="n">fitp_src</span><span class="p">[:]</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">np_src</span><span class="p">]</span>
        <span class="n">derivs_src</span><span class="p">,</span><span class="n">f_src</span><span class="o">=</span><span class="n">derivs_from_gauss_c</span><span class="p">(</span><span class="n">fitp_src</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">f_src</span>
        <span class="n">derivs_src_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_src</span><span class="p">,[</span><span class="n">np_src</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
        <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">derivs_src_tmp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pred</span><span class="p">,</span><span class="n">derivs</span></div>

<div class="viewcode-block" id="get_curve_deriv_tod_manygauss"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_tod_manygauss.html#minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_tod_manygauss">[docs]</a><span class="k">def</span> <span class="nf">get_curve_deriv_tod_manygauss</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">return_vecs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">npp</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span><span class="o">//</span><span class="n">npp</span>
    <span class="n">fitp_gauss</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npp</span><span class="p">)</span>
    <span class="c1">#dat=tod.info[&#39;dat_calib&#39;]</span>
    <span class="n">dat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">big_derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">,</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">pred</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">curve</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">,</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">])</span>
    <span class="n">deriv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">fitp_gauss</span><span class="p">[:]</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npp</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">npp</span><span class="p">]</span>
        <span class="n">derivs</span><span class="p">,</span><span class="n">src_pred</span><span class="o">=</span><span class="n">derivs_from_gauss_c</span><span class="p">(</span><span class="n">fitp_gauss</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">src_pred</span>
        <span class="n">big_derivs</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">npp</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">npp</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">derivs</span>
    <span class="n">delt</span><span class="o">=</span><span class="n">dat</span><span class="o">-</span><span class="n">pred</span>
    <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">delt_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">delt_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">delt_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">deriv_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">big_derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">npp</span><span class="o">*</span><span class="n">nsrc</span><span class="p">):</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">big_derivs</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">big_derivs</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">big_derivs</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">curve</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">curve</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="c1">#print i,j,curve[i,j]</span>
        <span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">delt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">delt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">deriv_filt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">delt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">curve</span><span class="p">,</span><span class="n">deriv</span><span class="p">,</span><span class="n">chisq</span></div>
<div class="viewcode-block" id="get_curve_deriv_tod_isosrc"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_tod_isosrc.html#minkasi_wrapper.extern.minkasi.minkasi.get_curve_deriv_tod_isosrc">[docs]</a><span class="k">def</span> <span class="nf">get_curve_deriv_tod_isosrc</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="n">return_vecs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">np_src</span><span class="o">=</span><span class="mi">4</span>
    <span class="n">np_iso</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">nsrc</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span><span class="o">-</span><span class="n">np_iso</span><span class="p">)</span><span class="o">/</span><span class="n">np_src</span>
    <span class="c1">#print &#39;nsrc is &#39;,nsrc</span>
    <span class="n">fitp_iso</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np_iso</span><span class="p">)</span>
    <span class="n">fitp_iso</span><span class="p">[:]</span><span class="o">=</span><span class="n">pars</span><span class="p">[:</span><span class="n">np_iso</span><span class="p">]</span>
    <span class="c1">#print &#39;fitp_iso is &#39;,fitp_iso</span>
    <span class="n">derivs_iso</span><span class="p">,</span><span class="n">f_iso</span><span class="o">=</span><span class="n">derivs_from_isobeta_c</span><span class="p">(</span><span class="n">fitp_iso</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
    <span class="n">derivs_iso_filt</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">derivs_iso</span>
    <span class="c1">#tmp=0*tod.info[&#39;dat_calib&#39;]</span>
    <span class="n">tmp</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_empty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#nn=tod.info[&#39;dat_calib&#39;].size</span>
    <span class="n">nn</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_nsamp</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np_iso</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">derivs_iso</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
        <span class="n">derivs_iso_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_iso</span><span class="p">,[</span><span class="n">np_iso</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
    <span class="n">derivs_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_iso_filt</span><span class="p">,[</span><span class="n">np_iso</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">f_iso</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsrc</span><span class="p">):</span>
        <span class="n">fitp_src</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np_src</span><span class="p">)</span>
        <span class="n">istart</span><span class="o">=</span><span class="n">np_iso</span><span class="o">+</span><span class="n">ii</span><span class="o">*</span><span class="n">np_src</span>
        <span class="n">fitp_src</span><span class="p">[:]</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">istart</span><span class="o">+</span><span class="n">np_src</span><span class="p">]</span>
        <span class="c1">#print &#39;fitp_src is &#39;,fitp_src</span>
        <span class="n">derivs_src</span><span class="p">,</span><span class="n">f_src</span><span class="o">=</span><span class="n">derivs_from_gauss_c</span><span class="p">(</span><span class="n">fitp_src</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">f_src</span>
        <span class="n">derivs_src_filt</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">derivs_src</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np_src</span><span class="p">):</span>
            <span class="n">tmp</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">derivs_src</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
            <span class="n">derivs_src_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">derivs_src_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_src</span><span class="p">,[</span><span class="n">np_src</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
        <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">derivs_src_tmp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">derivs_src_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_src_filt</span><span class="p">,[</span><span class="n">np_src</span><span class="p">,</span><span class="n">nn</span><span class="p">])</span>
        <span class="n">derivs_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">derivs_src_tmp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#delt_filt=tod.apply_noise(tod.info[&#39;dat_calib&#39;]-pred)</span>
    <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">delt_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt_filt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>

    <span class="c1">#dvec=np.reshape(tod.info[&#39;dat_calib&#39;],nn)</span>
    <span class="n">dvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>
    <span class="c1">#predvec=np.reshape(pred,nn)</span>
    <span class="n">predvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">delt</span><span class="o">=</span><span class="n">dvec</span><span class="o">-</span><span class="n">predvec</span>
    



    <span class="n">grad</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">delt</span><span class="p">)</span>
    <span class="n">grad2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">delt_filt</span><span class="p">)</span>
    <span class="n">curve</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">derivs</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="c1">#return pred</span>
    <span class="k">if</span> <span class="n">return_vecs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">derivs</span><span class="p">,</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">delt</span><span class="p">,</span><span class="n">delt_filt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">grad</span><span class="p">,</span><span class="n">grad2</span><span class="p">,</span><span class="n">curve</span></div>

    

<div class="viewcode-block" id="get_timestream_chisq_from_func"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_timestream_chisq_from_func.html#minkasi_wrapper.extern.minkasi.minkasi.get_timestream_chisq_from_func">[docs]</a><span class="k">def</span> <span class="nf">get_timestream_chisq_from_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">tods</span><span class="p">):</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">tods</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="n">pred</span><span class="p">,</span><span class="n">derivs</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
        <span class="c1">#delt=tod.info[&#39;dat_calib&#39;]-pred</span>
        <span class="n">delt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span>
        <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span>
        <span class="n">delt_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">delt_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">delt_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">delt_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delt</span><span class="o">*</span><span class="n">delt_filt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span></div>

<div class="viewcode-block" id="get_timestream_chisq_curve_deriv_from_func"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_timestream_chisq_curve_deriv_from_func.html#minkasi_wrapper.extern.minkasi.minkasi.get_timestream_chisq_curve_deriv_from_func">[docs]</a><span class="k">def</span> <span class="nf">get_timestream_chisq_curve_deriv_from_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">rotmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">grad</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">curve</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="c1">#print &#39;inside func, len(tods) is &#39;,len(tods.tods),len(pars)</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">tods</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="c1">#print &#39;type of tod is &#39;,type(tod)</span>
        <span class="n">pred</span><span class="p">,</span><span class="n">derivs</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">rotmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">derivs</span><span class="p">)</span>
        <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs</span><span class="p">,[</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
        <span class="n">derivs_filt</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">derivs</span>
        <span class="c1">#print(&#39;derivs_filt shape is &#39;,derivs_filt.shape)</span>
        <span class="c1">#derivs_filt=np.reshape(derivs_filt,[derivs_filt.shape[0],np.product(derivs_filt.shape[1:])])</span>
        <span class="c1">#sz=tod.info[&#39;dat_calib&#39;].shape</span>
        <span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
        <span class="n">npp</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c1">#delt=tod.info[&#39;dat_calib&#39;]-pred</span>
        <span class="n">delt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span>
        <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="p">):</span>
            <span class="n">tmp</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">sz</span><span class="p">)</span>
            <span class="n">tmp_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="c1">#tmp_filt[:,1:-1]=tmp_filt[:,1:-1]*2</span>
            <span class="n">tmp_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tmp_filt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">tmp_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tmp_filt</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">derivs_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp_filt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">delt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">delt_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt_filt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
        <span class="n">grad1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">delt_filt</span><span class="p">)</span>
        <span class="n">grad2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">delt</span><span class="p">)</span>
        <span class="c1">#print &#39;grad error is &#39;,np.mean(np.abs((grad1-grad2)/(0.5*(np.abs(grad1)+np.abs(grad2)))))</span>
        <span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">grad1</span><span class="o">+</span><span class="n">grad2</span><span class="p">)</span>
        <span class="n">curve</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">derivs_filt</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">delt_filt</span><span class="p">)</span>
    <span class="n">curve</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">curve</span><span class="o">+</span><span class="n">curve</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
        <span class="n">curve</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
        <span class="n">grad</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">chisq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span></div>

<div class="viewcode-block" id="get_ts_derivs_many_funcs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_ts_derivs_many_funcs.html#minkasi_wrapper.extern.minkasi.minkasi.get_ts_derivs_many_funcs">[docs]</a><span class="k">def</span> <span class="nf">get_ts_derivs_many_funcs</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">funcs</span><span class="p">,</span><span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">#ndet=tod.info[&#39;dat_calib&#39;].shape[0]</span>
    <span class="c1">#ndat=tod.info[&#39;dat_calib&#39;].shape[1]</span>
    <span class="n">ndet</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndet</span><span class="p">()</span>
    <span class="n">ndat</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_ndata</span><span class="p">()</span>
    <span class="n">npar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">npar_fun</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="c1">#vals=np.zeros([ndet,ndat])</span>
    
    <span class="n">pred</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="n">ndet</span><span class="p">,</span><span class="n">ndat</span><span class="p">])</span>
    <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">)):</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="n">icur</span><span class="p">:</span><span class="n">icur</span><span class="o">+</span><span class="n">npar_fun</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">myderivs</span><span class="p">,</span><span class="n">mypred</span><span class="o">=</span><span class="n">funcs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">tmp</span><span class="p">,</span><span class="n">tod</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="o">+</span><span class="n">mypred</span>
        <span class="n">derivs</span><span class="p">[</span><span class="n">icur</span><span class="p">:</span><span class="n">icur</span><span class="o">+</span><span class="n">npar_fun</span><span class="p">[</span><span class="n">i</span><span class="p">],:,:]</span><span class="o">=</span><span class="n">myderivs</span>
        <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="n">npar_fun</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span></div>
    <span class="c1">#derivs,pred=funcs[i](pars,tod)</span>
<div class="viewcode-block" id="get_ts_curve_derivs_many_funcs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.get_ts_curve_derivs_many_funcs.html#minkasi_wrapper.extern.minkasi.minkasi.get_ts_curve_derivs_many_funcs">[docs]</a><span class="k">def</span> <span class="nf">get_ts_curve_derivs_many_funcs</span><span class="p">(</span><span class="n">todvec</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">funcs</span><span class="p">,</span><span class="n">driver</span><span class="o">=</span><span class="n">get_ts_derivs_many_funcs</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">curve</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">grad</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">chisq</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">todvec</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
        <span class="n">derivs</span><span class="p">,</span><span class="n">pred</span><span class="o">=</span><span class="n">driver</span><span class="p">(</span><span class="n">tod</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">funcs</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">npar</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ndet</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ndat</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">#pred_filt=tod.apply_noise(pred)</span>
        <span class="n">derivs_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">derivs_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:])</span>        

        <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs</span><span class="p">,[</span><span class="n">npar</span><span class="p">,</span><span class="n">ndet</span><span class="o">*</span><span class="n">ndat</span><span class="p">])</span>
        <span class="n">derivs_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,[</span><span class="n">npar</span><span class="p">,</span><span class="n">ndet</span><span class="o">*</span><span class="n">ndat</span><span class="p">])</span>
        <span class="c1">#delt=tod.info[&#39;dat_calib&#39;]-pred</span>
        <span class="n">delt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span>
        <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delt</span><span class="o">*</span><span class="n">delt_filt</span><span class="p">)</span>
        <span class="n">delt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">ndet</span><span class="o">*</span><span class="n">ndat</span><span class="p">)</span>
        <span class="c1">#delt_filt=np.reshape(delt_filt,[1,ndet*ndat])</span>
        <span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">delt</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1">#grad2=grad2+np.dot(derivs,delt_filt.T)</span>
        <span class="n">curve</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">derivs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">have_mpi</span><span class="p">:</span>
        <span class="n">chisq</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">chisq</span><span class="p">)</span>
        <span class="n">grad</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">curve</span><span class="o">=</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span></div>



<div class="viewcode-block" id="update_lamda"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.update_lamda.html#minkasi_wrapper.extern.minkasi.minkasi.update_lamda">[docs]</a><span class="k">def</span> <span class="nf">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="n">success</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lamda</span><span class="o">&lt;</span><span class="mf">0.2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lamda</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lamda</span><span class="o">==</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">lamda</span></div>
        
<div class="viewcode-block" id="invscale"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.invscale.html#minkasi_wrapper.extern.minkasi.minkasi.invscale">[docs]</a><span class="k">def</span> <span class="nf">invscale</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span><span class="n">do_invsafe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">vec</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">mm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">vec</span><span class="p">)</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">mm</span><span class="o">*</span><span class="n">mat</span>
    <span class="c1">#ee,vv=np.linalg.eig(mat)</span>
    <span class="c1">#print &#39;rcond is &#39;,ee.max()/ee.min(),vv[:,np.argmin(ee)]</span>
    <span class="k">if</span> <span class="n">do_invsafe</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mm</span><span class="o">*</span><span class="n">invsafe</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_par_step</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">to_fit</span><span class="p">,</span><span class="n">lamda</span><span class="p">,</span><span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">curve_use</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">lamda</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">to_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">,</span><span class="kc">True</span><span class="p">),</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">,</span><span class="kc">True</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curve_use</span><span class="o">=</span><span class="n">curve_use</span><span class="p">[</span><span class="n">to_fit</span><span class="p">,:]</span>
        <span class="n">curve_use</span><span class="o">=</span><span class="n">curve_use</span><span class="p">[:,</span><span class="n">to_fit</span><span class="p">]</span>
        <span class="n">grad_use</span><span class="o">=</span><span class="n">grad</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span>
        <span class="n">step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">),</span><span class="n">grad_use</span><span class="p">)</span>
        <span class="n">step_use</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_fit</span><span class="p">))</span>
        <span class="n">step_use</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">=</span><span class="n">step</span>
        <span class="n">errs_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">,</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_fit</span><span class="p">))</span>
        <span class="n">errs</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">=</span><span class="n">errs_tmp</span>
        <span class="n">step</span><span class="o">=</span><span class="n">step_use</span>
    <span class="c1">#print(&#39;step shape &#39;,step.shape,step)</span>
    <span class="k">if</span> <span class="n">return_full</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">step</span><span class="p">,</span><span class="n">errs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">step</span>

<div class="viewcode-block" id="fit_timestreams_with_derivs_manyfun"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_timestreams_with_derivs_manyfun.html#minkasi_wrapper.extern.minkasi.minkasi.fit_timestreams_with_derivs_manyfun">[docs]</a><span class="k">def</span> <span class="nf">fit_timestreams_with_derivs_manyfun</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">to_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">chitol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">driver</span><span class="o">=</span><span class="n">get_ts_derivs_many_funcs</span><span class="p">):</span>
    <span class="n">lamda</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">chisq</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="o">=</span><span class="n">get_ts_curve_derivs_many_funcs</span><span class="p">(</span><span class="n">tods</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">funcs</span><span class="p">,</span><span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)</span>
    <span class="n">t2</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting chisq is &#39;</span><span class="p">,</span><span class="n">chisq</span><span class="p">,</span><span class="s1">&#39; with &#39;</span><span class="p">,</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span><span class="s1">&#39; seconds to get curvature&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">pars_new</span><span class="o">=</span><span class="n">pars</span><span class="o">+</span><span class="n">_par_step</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">to_fit</span><span class="p">,</span><span class="n">lamda</span><span class="p">)</span>
        <span class="n">chisq_new</span><span class="p">,</span><span class="n">grad_new</span><span class="p">,</span><span class="n">curve_new</span><span class="o">=</span><span class="n">get_ts_curve_derivs_many_funcs</span><span class="p">(</span><span class="n">tods</span><span class="p">,</span><span class="n">pars_new</span><span class="p">,</span><span class="n">npar_fun</span><span class="p">,</span><span class="n">funcs</span><span class="p">,</span><span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chisq_new</span><span class="o">&lt;</span><span class="n">chisq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;accepting with delta_chisq &#39;</span><span class="p">,</span><span class="n">chisq_new</span><span class="o">-</span><span class="n">chisq</span><span class="p">,</span><span class="s1">&#39; and lamda &#39;</span><span class="p">,</span><span class="n">lamda</span><span class="p">,</span><span class="n">pars_new</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">pars_new</span><span class="p">))</span>
            <span class="n">pars</span><span class="o">=</span><span class="n">pars_new</span>
            <span class="n">curve</span><span class="o">=</span><span class="n">curve_new</span>
            <span class="n">grad</span><span class="o">=</span><span class="n">grad_new</span>
            <span class="n">lamda</span><span class="o">=</span><span class="n">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">chisq</span><span class="o">-</span><span class="n">chisq_new</span><span class="o">&lt;</span><span class="n">chitol</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lamda</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">step</span><span class="p">,</span><span class="n">errs</span><span class="o">=</span><span class="n">_par_step</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">to_fit</span><span class="p">,</span><span class="n">lamda</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pars</span><span class="p">,</span><span class="n">chisq_new</span><span class="p">,</span><span class="n">curve_new</span><span class="p">,</span><span class="n">errs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chisq</span><span class="o">=</span><span class="n">chisq_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rejecting with delta_chisq &#39;</span><span class="p">,</span><span class="n">chisq_new</span><span class="o">-</span><span class="n">chisq</span><span class="p">,</span><span class="s1">&#39; and lamda &#39;</span><span class="p">,</span><span class="n">lamda</span><span class="p">)</span>
            <span class="n">lamda</span><span class="o">=</span><span class="n">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">myrank</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fit_timestreams_with_derivs_manyfun failed to converge after &quot;</span><span class="p">,</span><span class="n">maxiter</span><span class="p">,</span><span class="s2">&quot; iterations.&quot;</span><span class="p">)</span>    
    <span class="n">step</span><span class="p">,</span><span class="n">errs</span><span class="o">=</span><span class="n">_par_step</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">to_fit</span><span class="p">,</span><span class="n">lamda</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pars</span><span class="p">,</span><span class="n">chisq</span><span class="p">,</span><span class="n">curve</span><span class="p">,</span><span class="n">errs</span></div>
        
<div class="viewcode-block" id="fit_timestreams_with_derivs"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.fit_timestreams_with_derivs.html#minkasi_wrapper.extern.minkasi.minkasi.fit_timestreams_with_derivs">[docs]</a><span class="k">def</span> <span class="nf">fit_timestreams_with_derivs</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">to_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">chitol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">to_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print &#39;working on creating rotmat&#39;</span>
        <span class="n">to_fit</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">to_fit</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">to_fit</span><span class="p">)</span>
        <span class="n">nfloat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ncovary</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nfit</span><span class="o">=</span><span class="n">nfloat</span><span class="o">+</span><span class="n">ncovary</span>
        <span class="n">rotmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">),</span><span class="n">nfit</span><span class="p">])</span>
        
        <span class="n">solo_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">solo_inds</span><span class="p">:</span>
            <span class="n">rotmat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">icur</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ncovary</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">group_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="n">inds</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">group_inds</span><span class="p">:</span>
                <span class="n">ii</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rotmat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">icur</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rotmat</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">converged</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">pp</span><span class="o">=</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">lamda</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="n">chi_ref</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="o">=</span><span class="n">get_timestream_chisq_curve_deriv_from_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pp</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">rotmat</span><span class="p">)</span>
    <span class="n">chi_cur</span><span class="o">=</span><span class="n">chi_ref</span>
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">converged</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&lt;</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="nb">iter</span><span class="o">=</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">curve_tmp</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">lamda</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve</span><span class="p">))</span>
        <span class="c1">#curve_inv=np.linalg.inv(curve_tmp)</span>
        <span class="n">curve_inv</span><span class="o">=</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_tmp</span><span class="p">)</span>
        <span class="n">shifts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">,</span><span class="n">grad</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">rotmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">shifts_use</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span><span class="n">shifts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shifts_use</span><span class="o">=</span><span class="n">shifts</span>
        <span class="n">pp_tmp</span><span class="o">=</span><span class="n">pp</span><span class="o">+</span><span class="n">shifts_use</span>
        <span class="n">chi_new</span><span class="o">=</span><span class="n">get_timestream_chisq_from_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pp_tmp</span><span class="p">,</span><span class="n">tods</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chi_new</span><span class="o">&lt;=</span><span class="n">chi_cur</span><span class="o">+</span><span class="n">chitol</span><span class="p">:</span> <span class="c1">#add in a bit of extra tolerance in chi^2 in case we&#39;re bopping about the minimum</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">=</span><span class="n">pp_tmp</span>
            <span class="n">chi_cur</span><span class="o">=</span><span class="n">chi_new</span>
            <span class="n">chi_tmp</span><span class="p">,</span><span class="n">grad</span><span class="p">,</span><span class="n">curve</span><span class="o">=</span><span class="n">get_timestream_chisq_curve_deriv_from_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pp</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">rotmat</span><span class="p">)</span>
        <span class="n">lamda</span><span class="o">=</span><span class="n">update_lamda</span><span class="p">(</span><span class="n">lamda</span><span class="p">,</span><span class="n">success</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lamda</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="n">success</span><span class="p">:</span>
            <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">))</span>
            <span class="n">conv_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shifts</span><span class="o">/</span><span class="n">errs</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">conv_fac</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;we have converged&#39;</span><span class="p">)</span>
                <span class="n">converged</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv_fac</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">to_print</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="mf">1.0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">pp</span><span class="o">-</span><span class="n">pars</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span><span class="s1">&#39; max_shift is &#39;</span><span class="p">,</span><span class="n">conv_fac</span><span class="p">,</span><span class="s1">&#39; with lamda &#39;</span><span class="p">,</span><span class="n">lamda</span><span class="p">,</span><span class="n">chi_ref</span><span class="o">-</span><span class="n">chi_cur</span><span class="p">,</span><span class="n">chi_ref</span><span class="o">-</span><span class="n">chi_new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pp</span><span class="p">,</span><span class="n">chi_cur</span></div>
<span class="k">def</span> <span class="nf">_fit_timestreams_with_derivs_old</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">pars</span><span class="p">,</span><span class="n">tods</span><span class="p">,</span><span class="n">to_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">to_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">scale_facs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Fit a model to timestreams.  func should return the model and the derivatives evaluated at </span>
<span class="sd">    the parameter values in pars.  to_fit says which parameters to float.  0 to fix, 1 to float, and anything</span>
<span class="sd">    larger than 1 is expected to vary together (e.g. shifting a TOD pointing mode you could put in a 2 for all RA offsets </span>
<span class="sd">    and a 3 for all dec offsets.).  to_scale will normalize</span>
<span class="sd">    by the input value, so one can do things like keep relative fluxes locked together.&#39;&#39;&#39;</span>
    

    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">to_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print &#39;working on creating rotmat&#39;</span>
        <span class="n">to_fit</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">to_fit</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">to_fit</span><span class="p">)</span>
        <span class="n">nfloat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ncovary</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nfit</span><span class="o">=</span><span class="n">nfloat</span><span class="o">+</span><span class="n">ncovary</span>
        <span class="n">rotmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">),</span><span class="n">nfit</span><span class="p">])</span>

        <span class="n">solo_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">icur</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">solo_inds</span><span class="p">:</span>
            <span class="n">rotmat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">icur</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ncovary</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">group_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="n">inds</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">group_inds</span><span class="p">:</span>
                <span class="n">ii</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">to_fit</span><span class="o">==</span><span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rotmat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">icur</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="n">icur</span><span class="o">=</span><span class="n">icur</span><span class="o">+</span><span class="mi">1</span>

        
    <span class="nb">iter</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">converged</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">pp</span><span class="o">=</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">converged</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">iter</span><span class="o">&lt;</span><span class="n">maxiter</span><span class="p">):</span>
        <span class="n">curve</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">grad</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">chisq</span><span class="o">=</span><span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">tods</span><span class="o">.</span><span class="n">tods</span><span class="p">:</span>
            <span class="c1">#sz=tod.info[&#39;dat_calib&#39;].shape</span>
            <span class="n">sz</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data_dims</span><span class="p">()</span>
            <span class="n">pred</span><span class="p">,</span><span class="n">derivs</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span><span class="n">tod</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">derivs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">derivs</span><span class="p">)</span>
            <span class="n">derivs_filt</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">derivs</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
            <span class="n">npp</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nn</span><span class="o">=</span><span class="n">derivs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#delt=tod.info[&#39;dat_calib&#39;]-pred</span>
            <span class="n">delt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">-</span><span class="n">pred</span>
            <span class="n">delt_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">delt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="p">):</span>
                <span class="n">tmp</span><span class="p">[:,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">derivs</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">sz</span><span class="p">)</span>
                <span class="n">tmp_filt</span><span class="o">=</span><span class="n">tod</span><span class="o">.</span><span class="n">apply_noise</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">derivs_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp_filt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
            <span class="n">delt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
            <span class="n">delt_filt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">delt_filt</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
            <span class="n">grad1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">delt_filt</span><span class="p">)</span>
            <span class="n">grad2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs_filt</span><span class="p">,</span><span class="n">delt</span><span class="p">)</span>
            <span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">grad1</span><span class="o">+</span><span class="n">grad2</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span><span class="n">derivs_filt</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">chisq</span><span class="o">=</span><span class="n">chisq</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delt</span><span class="p">,</span><span class="n">delt_filt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">iter</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">chi_ref</span><span class="o">=</span><span class="n">chisq</span>
        <span class="n">curve</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">curve</span><span class="o">+</span><span class="n">curve</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
        <span class="n">curve</span><span class="o">=</span><span class="n">curve</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve</span><span class="p">))</span> <span class="c1">#double the diagonal for testing purposes</span>
        <span class="n">curve_inv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
        <span class="n">errs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">))</span>
        <span class="n">shifts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">curve_inv</span><span class="p">,</span><span class="n">grad</span><span class="p">)</span>
        <span class="c1">#print errs,shifts</span>
        <span class="n">conv_fac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shifts</span><span class="o">/</span><span class="n">errs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">conv_fac</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We have converged.&#39;</span><span class="p">)</span>
            <span class="n">converged</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">to_fit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">shifts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span><span class="n">shifts</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">scale_facs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">iter</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">scale_facs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rescaling shift by &#39;</span><span class="p">,</span><span class="n">scale_facs</span><span class="p">[</span><span class="nb">iter</span><span class="p">])</span>
                <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="o">*</span><span class="n">scale_facs</span><span class="p">[</span><span class="nb">iter</span><span class="p">]</span>
        <span class="n">to_print</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">3600</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="mf">1.0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">pp</span><span class="o">-</span><span class="n">pars</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iter &#39;</span><span class="p">,</span><span class="nb">iter</span><span class="p">,</span><span class="s1">&#39; max shift is &#39;</span><span class="p">,</span><span class="n">conv_fac</span><span class="p">,</span><span class="s1">&#39; with chisq improvement &#39;</span><span class="p">,</span><span class="n">chi_ref</span><span class="o">-</span><span class="n">chisq</span><span class="p">,</span><span class="n">to_print</span><span class="p">)</span> <span class="c1">#converged,pp,shifts</span>
        <span class="n">pp</span><span class="o">=</span><span class="n">pp</span><span class="o">+</span><span class="n">shifts</span>

        <span class="nb">iter</span><span class="o">=</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">pp</span><span class="p">,</span><span class="n">chisq</span>


<div class="viewcode-block" id="split_dict"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.split_dict.html#minkasi_wrapper.extern.minkasi.minkasi.split_dict">[docs]</a><span class="k">def</span> <span class="nf">split_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">,</span><span class="n">vec</span><span class="p">,</span><span class="n">thresh</span><span class="p">):</span>
    <span class="c1">#split a dictionary into sub-dictionaries wherever a gap in vec is larger than thresh.</span>
    <span class="c1">#useful for e.g. splitting TODs where there&#39;s a large time gap due to cuts.</span>
    <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print(inds,len(inds))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mydict</span><span class="p">]</span>
    <span class="n">ndict</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span><span class="n">inds</span><span class="o">+</span><span class="mi">1</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)]])</span>
    <span class="c1">#print(inds)</span>

    <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ndict</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndict</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ndim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndict</span><span class="p">):</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndict</span><span class="p">):</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndict</span><span class="p">):</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
            <span class="c1">#print(&#39;copying &#39;,key,&#39; unchanged&#39;)</span>
            <span class="c1">#don&#39;t need below as it&#39;s already copied by default</span>
            <span class="c1">#for i in range(ndict):</span>
            <span class="c1">#    out[i][key]=mydict[key]</span>

    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="mask_dict"><a class="viewcode-back" href="../../../../api/minkasi_wrapper.extern.minkasi.minkasi.mask_dict.html#minkasi_wrapper.extern.minkasi.minkasi.mask_dict">[docs]</a><span class="k">def</span> <span class="nf">mask_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ndim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">mask</span><span class="p">,:]</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>
            <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">mask</span><span class="p">,:,:]</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">mask</span><span class="p">,:]</span>
                <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">maks</span><span class="p">):</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,:,</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, Zhiyuan Ma.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
    Last built 22 Mar 2023. <br/>
  </p>
</footer>
  </body>
</html>